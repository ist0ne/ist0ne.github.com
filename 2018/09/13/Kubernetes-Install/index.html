<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>高可用 Kubernetes 集群部署 | 石头记 | Docker、Kubernetes、CI/CD 等技术分享</title>

  
  <meta name="author" content="ist0ne">
  

  
  <meta name="description" content="Docker、Kubernetes、Ceph、Saltstack、OpenStack 等技术分享">
  

  
  <meta name="keywords" content="blog kubernetes k8s docker container ceph salt saltstack openstack kube kubectl helm charts gitlab git">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="高可用 Kubernetes 集群部署">

  <meta property="og:site_name" content="石头记">

  
  <meta property="og:image" content="/favicon.ico">
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="石头记" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">石头记</a>
    </h1>
    <p class="site-description">Docker、Kubernetes、CI/CD 等技术分享</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
        <li><a href="/atom.xml">订阅</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>高可用 Kubernetes 集群部署</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/09/13/Kubernetes-Install/" rel="bookmark">
        <time class="entry-date published" datetime="2018-09-13T04:09:18.000Z">
          2018-09-13
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>我在前面介绍容器技术基础知识，本篇主要介绍通过kubeadm部署高可用容器编排工具Kubernetes。跟很多基础设施领域先有工程实践、后有方法论的发展路线不同，Kubernetes 项目的理论基础则要比工程实践走得靠前得多，这当然要归功于 Google 公司在 2015 年 4 月发布的 Borg 论文了。Borg 系统，一直以来都被誉为 Google 公司内部最强大的“秘密武器”。因为，相比于 Spanner、BigTable 等相对上层的项目，Borg 要承担的责任，是承载 Google 公司整个基础设施的核心依赖。在 Google 公司已经公开发表的基础设施体系论文中，Borg 项目当仁不让地位居整个基础设施技术栈的最底层。</p>
<p><img src="/imgs/201809/borg.jpg" alt="Google 架构"></p>
<p>Kubernetes 项目的架构，跟它的原型项目 Borg 非常类似，都由 Master 和 Node 两种节点组成，而这两种角色分别对应着控制节点和计算节点。</p>
<p><img src="/imgs/201809/k8s_jiagou.png" alt="Kubernetes 架构"></p>
<p>其中，控制节点，即 Master 节点，由三个紧密协作的独立组件组合而成，它们分别是负责 API 服务的 kube-apiserver、负责调度的 kube-scheduler，以及负责容器编排的 kube-controller-manager。整个集群的持久化数据，则由 kube-apiserver 处理后保存在 ectd 中。Kubernetes 的高可用即为控制节点和 etcd 数据库的高可用。下面开始介绍高可用 Kubernetes 集群的搭建步骤。</p>
<a id="more"></a>

<h3 id="准备虚拟机"><a href="#准备虚拟机" class="headerlink" title="准备虚拟机"></a>准备虚拟机</h3><p>准备三台虚拟机作为 Kubernetes 的控制节点，由于是测试环境，计算节点也同时跑在三台控制节点上，实际产品环境计算作节点可以单独部署。所有节点均安装 CentOS 7 系统。</p>
<p><img src="/imgs/201809/k8s_vm.png" alt="Kubernetes 节点"></p>
<h4 id="三个节点如下设置主机名"><a href="#三个节点如下设置主机名" class="headerlink" title="三个节点如下设置主机名"></a>三个节点如下设置主机名</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">节点1：</span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname k8s-ha-1</span><br><span class="line">节点2：</span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname k8s-ha-2</span><br><span class="line">节点3：</span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname k8s-ha-3</span><br></pre></td></tr></table></figure>

<h4 id="三个节点添加hosts"><a href="#三个节点添加hosts" class="headerlink" title="三个节点添加hosts"></a>三个节点添加hosts</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/hosts</span><br><span class="line">192.168.115.83 k8s-ha-1</span><br><span class="line">192.168.115.84 k8s-ha-2</span><br><span class="line">192.168.115.85 k8s-ha-3</span><br></pre></td></tr></table></figure>

<h3 id="所有节点安装-Docker"><a href="#所有节点安装-Docker" class="headerlink" title="所有节点安装 Docker"></a>所有节点安装 Docker</h3><p>推荐安装 17.03，1.11、1.12、1.13也可以，但是17.06+是未经测试的，不推荐使用。</p>
<p>yum install -y docker<br>systemctl enable docker &amp;&amp; systemctl start docker</p>
<h3 id="所有节点安装-kubeadm、kubelet-和-kubectl"><a href="#所有节点安装-kubeadm、kubelet-和-kubectl" class="headerlink" title="所有节点安装 kubeadm、kubelet 和 kubectl"></a>所有节点安装 kubeadm、kubelet 和 kubectl</h3><p>kubelet版本要与待安装的Kubernetes版本相同，否则可能会出现一些难以预料的问题。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置 Kubernetes yum 仓库</span></span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg</span><br><span class="line">exclude=kube*</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭SELinux</span></span><br><span class="line">setenforce 0</span><br><span class="line"><span class="comment"># 安装软件包</span></span><br><span class="line">yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes</span><br><span class="line"></span><br><span class="line">以下软件包会被安装：</span><br><span class="line">  Installing : ebtables-2.0.10-16.el7.x86_64                                                                                1/7</span><br><span class="line">  Installing : kubectl-1.11.2-0.x86_64                                                                                      2/7</span><br><span class="line">  Installing : cri-tools-1.11.0-0.x86_64                                                                                    3/7</span><br><span class="line">  Installing : socat-1.7.3.2-2.el7.x86_64                                                                                   4/7</span><br><span class="line">  Installing : kubernetes-cni-0.6.0-0.x86_64                                                                                5/7</span><br><span class="line">  Installing : kubelet-1.11.2-0.x86_64                                                                                      6/7</span><br><span class="line">  Installing : kubeadm-1.11.2-0.x86_64</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动kubelet服务</span></span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet &amp;&amp; systemctl start kubelet</span><br></pre></td></tr></table></figure>

<p><strong>注意：如果服务器端不能直接访问google，可以通过离线安装包安装</strong></p>
<p>如果服务器端不能翻墙，需要手动下载rpm包安装：</p>
<p>访问 <a href="https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64/repodata/primary.xml" target="_blank" rel="noopener">https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64/repodata/primary.xml</a> 找到最新的rpm包并下载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://packages.cloud.google.com/yum/pool/f309f5183598b920355bc18ff53f3816f55c27ac1c6e8a4369344141d9d4f127-kubelet-1.11.3-0.x86_64.rpm -o kubelet-1.11.3-0.x86_64.rpm</span><br><span class="line">wget https://packages.cloud.google.com/yum/pool/0576a2ac6e3ff9e96d807b33ed6caabcfc3cec94e333fb86431d99a398318251-kubeadm-1.11.3-0.x86_64.rpm -o kubeadm-1.11.3-0.x86_64.rpm</span><br><span class="line">wget https://packages.cloud.google.com/yum/pool/a36ef4d0907a8d32359931252b65516b46bb72e19f997574ac72fe3e88c0b03c-kubectl-1.11.3-0.x86_64.rpm -o kubectl-1.11.3-0.x86_64.rpm</span><br><span class="line">wget https://packages.cloud.google.com/yum/pool/fe33057ffe95bfae65e2f269e1b05e99308853176e24a4d027bc082b471a07c0-kubernetes-cni-0.6.0-0.x86_64.rpm -o kubernetes-cni-0.6.0-0.x86_64.rpm</span><br><span class="line">wget https://packages.cloud.google.com/yum/pool/f70d8cb23c7b91c0509292f4862060367edabce8788b855c38a7c174f014b9e2-cri-tools-1.11.1-0.x86_64.rpm -o cri-tools-1.11.1-0.x86_64.rpm</span><br></pre></td></tr></table></figure>

<p>安装依赖包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y socat ebtables</span><br></pre></td></tr></table></figure>

<p>手动安装rpm 包（kubelet、kubeadm、kubectl、kubernetes-cni、cri-tools）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh *.rpm</span><br></pre></td></tr></table></figure>

<p>配置系统参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行命令使配置生效</span></span><br><span class="line">sysctl --system</span><br><span class="line"></span><br><span class="line"><span class="comment"># Kubernetes v1.8+ 要求关闭系统 Swap，请在所有节点利用以下指令关闭：</span></span><br><span class="line">swapoff -a &amp;&amp; sysctl -w vm.swappiness=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注释到swap相关的行</span></span><br><span class="line">vi /etc/fstab</span><br></pre></td></tr></table></figure>

<h3 id="配置-HaProxy-作为-apiserver-的负载均衡"><a href="#配置-HaProxy-作为-apiserver-的负载均衡" class="headerlink" title="配置 HaProxy 作为 apiserver 的负载均衡"></a>配置 HaProxy 作为 apiserver 的负载均衡</h3><h4 id="三个节点编译安装-Haproxy"><a href="#三个节点编译安装-Haproxy" class="headerlink" title="三个节点编译安装 Haproxy"></a>三个节点编译安装 Haproxy</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装编译所需软件包</span></span><br><span class="line">yum install gcc pcre-static pcre-devel systemd-devel -y</span><br><span class="line"><span class="comment"># 下载haproxy</span></span><br><span class="line">wget https://www.haproxy.org/download/1.8/src/haproxy-1.8.13.tar.gz</span><br><span class="line">tar xzvf haproxy-1.8.13.tar.gz</span><br><span class="line"><span class="built_in">cd</span> haproxy-1.8.13</span><br><span class="line">make TARGET=linux2628 USE_SYSTEMD=1</span><br><span class="line">make install</span><br><span class="line">mkdir -p /etc/haproxy</span><br><span class="line">mkdir -p /var/lib/haproxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置haproxy服务</span></span><br><span class="line">vi /usr/lib/systemd/system/haproxy.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=HAProxy Load Balancer</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Environment=<span class="string">"CONFIG=/etc/haproxy/haproxy.cfg"</span> <span class="string">"PIDFILE=/run/haproxy.pid"</span></span><br><span class="line">ExecStartPre=/usr/<span class="built_in">local</span>/sbin/haproxy -f <span class="variable">$CONFIG</span> -c -q</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/sbin/haproxy -Ws -f <span class="variable">$CONFIG</span> -p <span class="variable">$PIDFILE</span></span><br><span class="line">ExecReload=/usr/<span class="built_in">local</span>/sbin/haproxy -f <span class="variable">$CONFIG</span> -c -q</span><br><span class="line">ExecReload=/bin/<span class="built_in">kill</span> -USR2 <span class="variable">$MAINPID</span></span><br><span class="line">KillMode=mixed</span><br><span class="line">Restart=always</span><br><span class="line">SuccessExitStatus=143</span><br><span class="line">Type=notify</span><br><span class="line"></span><br><span class="line"><span class="comment"># The following lines leverage SystemD's sandboxing options to provide</span></span><br><span class="line"><span class="comment"># defense in depth protection at the expense of restricting some flexibility</span></span><br><span class="line"><span class="comment"># in your setup (e.g. placement of your configuration files) or possibly</span></span><br><span class="line"><span class="comment"># reduced performance. See systemd.service(5) and systemd.exec(5) for further</span></span><br><span class="line"><span class="comment"># information.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># NoNewPrivileges=true</span></span><br><span class="line"><span class="comment"># ProtectHome=true</span></span><br><span class="line"><span class="comment"># If you want to use 'ProtectSystem=strict' you should whitelist the PIDFILE,</span></span><br><span class="line"><span class="comment"># any state files and any other files written using 'ReadWritePaths' or</span></span><br><span class="line"><span class="comment"># 'RuntimeDirectory'.</span></span><br><span class="line"><span class="comment"># ProtectSystem=true</span></span><br><span class="line"><span class="comment"># ProtectKernelTunables=true</span></span><br><span class="line"><span class="comment"># ProtectKernelModules=true</span></span><br><span class="line"><span class="comment"># ProtectControlGroups=true</span></span><br><span class="line"><span class="comment"># If your SystemD version supports them, you can add: @reboot, @swap, @sync</span></span><br><span class="line"><span class="comment"># SystemCallFilter=~@cpu-emulation @keyring @module @obsolete @raw-io</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">vi /etc/haproxy/haproxy.cfg</span><br><span class="line">global</span><br><span class="line">    <span class="built_in">log</span> /dev/<span class="built_in">log</span> local0</span><br><span class="line">    <span class="built_in">log</span> /dev/<span class="built_in">log</span> local1 notice</span><br><span class="line">    chroot /var/lib/haproxy</span><br><span class="line">    stats timeout 30s</span><br><span class="line">    maxconn 5000</span><br><span class="line">    daemon</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    <span class="built_in">log</span> global</span><br><span class="line">    mode http</span><br><span class="line">    option dontlognull</span><br><span class="line">    timeout connect 5000</span><br><span class="line">    timeout client 50000</span><br><span class="line">    timeout server 50000</span><br><span class="line"></span><br><span class="line">frontend k8s-api</span><br><span class="line">    <span class="built_in">bind</span> 0.0.0.0:6443</span><br><span class="line">    mode tcp</span><br><span class="line">    default_backend k8s-api</span><br><span class="line"></span><br><span class="line">backend k8s-api</span><br><span class="line">    mode tcp</span><br><span class="line">    option tcp-check</span><br><span class="line">    balance roundrobin</span><br><span class="line">    default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100</span><br><span class="line">    server k8s-api-1 192.168.115.83:6443 check</span><br><span class="line">    server k8s-api-2 192.168.115.84:6443 check</span><br><span class="line">    server k8s-api-3 192.168.115.85:6443 check</span><br><span class="line"></span><br><span class="line">systemctl start haproxy</span><br><span class="line">systemctl <span class="built_in">enable</span> haproxy</span><br></pre></td></tr></table></figure>

<h4 id="配置-keepalived-服务"><a href="#配置-keepalived-服务" class="headerlink" title="配置 keepalived 服务"></a>配置 keepalived 服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 keepalived</span></span><br><span class="line">yum install -y keepalived psmisc</span><br></pre></td></tr></table></figure>

<p>节点1上配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/keepalived/keepalived.conf</span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">    root@localhost</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from admin@allen.com</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id LVS_ALLEN</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script haproxy-check &#123;</span><br><span class="line">    script <span class="string">"killall -0 haproxy"</span></span><br><span class="line">    interval 2</span><br><span class="line">    weight -30</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance k8s-api &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 100</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass k8s</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.115.250</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        haproxy-check</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>节点2上配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/keepalived/keepalived.conf</span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">    root@localhost</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from admin@allen.com</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id LVS_ALLEN</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script haproxy-check &#123;</span><br><span class="line">    script <span class="string">"killall -0 haproxy"</span></span><br><span class="line">    interval 2</span><br><span class="line">    weight -30</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance k8s-api &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 100</span><br><span class="line">    priority 90</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass k8s</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.115.250</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        haproxy-check</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>节点3上配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/keepalived/keepalived.conf</span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">    root@localhost</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from admin@allen.com</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id LVS_ALLEN</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script haproxy-check &#123;</span><br><span class="line">    script <span class="string">"killall -0 haproxy"</span></span><br><span class="line">    interval 2</span><br><span class="line">    weight -30</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance k8s-api &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 100</span><br><span class="line">    priority 80</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass k8s</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.115.250</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        haproxy-check</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>各节点启动 keepalived</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start keepalived</span><br><span class="line">systemctl <span class="built_in">enable</span> keepalived</span><br></pre></td></tr></table></figure>

<h4 id="验证可用性"><a href="#验证可用性" class="headerlink" title="验证可用性"></a>验证可用性</h4><p>VIP（192.168.115.250）开始绑定在节点1上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-ha-1 ~]<span class="comment"># ip a l</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether fa:16:3e:44:b9:61 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.115.83/24 brd 192.168.115.255 scope global dynamic eth0</span><br><span class="line">       valid_lft 540sec preferred_lft 540sec</span><br><span class="line">    inet 192.168.115.250/32 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::f816:3eff:fe44:b961/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN</span><br><span class="line">    link/ether 02:42:52:3d:25:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.77.1.1/24 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<p>停掉节点1上的haproxy服务，VIP已经飘走</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-ha-1 ~]<span class="comment"># systemctl stop haproxy</span></span><br><span class="line">[root@k8s-ha-1 ~]<span class="comment"># ip a l</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether fa:16:3e:44:b9:61 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.115.83/24 brd 192.168.115.255 scope global dynamic eth0</span><br><span class="line">       valid_lft 525sec preferred_lft 525sec</span><br><span class="line">    inet 192.168.115.250/32 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::f816:3eff:fe44:b961/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN</span><br><span class="line">    link/ether 02:42:52:3d:25:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.77.1.1/24 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<p>VIP已经绑定到节点2上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-ha-2 ~]<span class="comment"># ip a l</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether fa:16:3e:90:af:3e brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.115.84/24 brd 192.168.115.255 scope global dynamic eth0</span><br><span class="line">       valid_lft 489sec preferred_lft 489sec</span><br><span class="line">    inet 192.168.115.250/32 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::f816:3eff:fe90:af3e/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN</span><br><span class="line">    link/ether 02:42:f4:c9:6d:fa brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.77.1.1/24 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<p>停掉节点2上的haproxy服务，VIP绑定到节点3上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-ha-2 ~]<span class="comment"># systemctl stop haproxy</span></span><br><span class="line"></span><br><span class="line">[root@k8s-ha-3 ~]<span class="comment"># ip a l</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether fa:16:3e:d7:3b:08 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.115.85/24 brd 192.168.115.255 scope global dynamic eth0</span><br><span class="line">       valid_lft 512sec preferred_lft 512sec</span><br><span class="line">    inet 192.168.115.250/32 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::f816:3eff:fed7:3b08/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN</span><br><span class="line">    link/ether 02:42:a8:0c:2e:a1 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.77.1.1/24 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<p>启动节点1的haproxy，VIP重新绑定到节点1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-ha-1 ~]<span class="comment"># systemctl start haproxy</span></span><br><span class="line">[root@k8s-ha-1 ~]<span class="comment"># ip a l</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether fa:16:3e:44:b9:61 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.115.83/24 brd 192.168.115.255 scope global dynamic eth0</span><br><span class="line">       valid_lft 452sec preferred_lft 452sec</span><br><span class="line">    inet 192.168.115.250/32 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::f816:3eff:fe44:b961/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN</span><br><span class="line">    link/ether 02:42:52:3d:25:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.77.1.1/24 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<h3 id="配置Kubernetes控制节点"><a href="#配置Kubernetes控制节点" class="headerlink" title="配置Kubernetes控制节点"></a>配置Kubernetes控制节点</h3><h4 id="配置ssh-key认证"><a href="#配置ssh-key认证" class="headerlink" title="配置ssh key认证"></a>配置ssh key认证</h4><p>在节点1上执行生成公钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br></pre></td></tr></table></figure>

<p>拷贝 /root/.ssh/id_rsa.pub 内容到 节点2 和 节点3 上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /home/centos/.ssh/authorized_keys</span><br></pre></td></tr></table></figure>

<p>确保能够通过 ssh <a href="mailto:centos@192.168.115.84" target="_blank" rel="noopener">centos@192.168.115.84</a> ssh <a href="mailto:centos@192.168.115.85" target="_blank" rel="noopener">centos@192.168.115.85</a> 能够免密码登录</p>
<h4 id="启动第一个控制节点"><a href="#启动第一个控制节点" class="headerlink" title="启动第一个控制节点"></a>启动第一个控制节点</h4><p>创建 kubeadm-config.yaml 模板文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1alpha2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">MasterConfiguration</span></span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="string">v1.11.2</span></span><br><span class="line"><span class="attr">apiServerCertSANs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">"192.168.115.250"</span></span><br><span class="line"><span class="attr">api:</span></span><br><span class="line"><span class="attr">    controlPlaneEndpoint:</span> <span class="string">"192.168.115.250:8443"</span></span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line"><span class="attr">  local:</span></span><br><span class="line"><span class="attr">    extraArgs:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">"k8s-ha-1"</span></span><br><span class="line"><span class="attr">      listen-client-urls:</span> <span class="string">"https://127.0.0.1:2379,https://192.168.115.83:2379"</span></span><br><span class="line"><span class="attr">      advertise-client-urls:</span> <span class="string">"https://192.168.115.83:2379"</span></span><br><span class="line"><span class="attr">      listen-peer-urls:</span> <span class="string">"https://192.168.115.83:2380"</span></span><br><span class="line"><span class="attr">      initial-advertise-peer-urls:</span> <span class="string">"https://192.168.115.83:2380"</span></span><br><span class="line"><span class="attr">      initial-cluster:</span> <span class="string">"k8s-ha-1=https://192.168.115.83:2380"</span></span><br><span class="line"><span class="attr">    serverCertSANs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">192.168</span><span class="number">.115</span><span class="number">.83</span></span><br><span class="line"><span class="attr">    peerCertSANs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">192.168</span><span class="number">.115</span><span class="number">.83</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">    <span class="comment"># This CIDR is a Canal default. Substitute or remove for your CNI provider.</span></span><br><span class="line"><span class="attr">    podSubnet:</span> <span class="string">"10.244.0.0/16"</span></span><br><span class="line"><span class="attr">controllerManagerExtraArgs:</span></span><br><span class="line"><span class="attr">  address:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">schedulerExtraArgs:</span></span><br><span class="line"><span class="attr">  address:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong></p>
<ul>
<li>可以通过 kubeadm config print-default 打印集群的默认配置</li>
<li>etcd.local.extraArgs.name 和 etcd.local.extraArgs.initial-cluster 的设置需要与主机名相同（k8s-ha-1），你需要根据自己的主机做相应修改</li>
<li>如果无法直接访问 k8s.gcr.io 镜像仓库，可以通过 imageRepository: hub.example.com/google_containers 设置自己的镜像仓库</li>
<li>如果无法直接访问 k8s.gcr.io 镜像仓库，k8s.gcr.io/pause:3.1 镜像必须存在，可以通过 docker tag hub.example.com/google_containers/pause:3.1 k8s.gcr.io/pause:3.1 重命名镜像</li>
<li>networking.podSubnet 根据使用的网络插件的不同需要设置不同的默认值</li>
<li>controllerManager和scheduler监听到0.0.0.0，方便以后进行监控</li>
</ul>
<p>运行如下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --config kubeadm-config.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出如下</span></span><br><span class="line">[endpoint] WARNING: port specified <span class="keyword">in</span> api.controlPlaneEndpoint overrides api.bindPort <span class="keyword">in</span> the controlplane address</span><br><span class="line">[init] using Kubernetes version: v1.11.2</span><br><span class="line">[preflight] running pre-flight checks</span><br><span class="line">I0913 09:24:57.800852   16518 kernel_validator.go:81] Validating kernel version</span><br><span class="line">I0913 09:24:57.801137   16518 kernel_validator.go:96] Validating kernel config</span><br><span class="line">[preflight/images] Pulling images required <span class="keyword">for</span> setting up a Kubernetes cluster</span><br><span class="line">[preflight/images] This might take a minute or two, depending on the speed of your internet connection</span><br><span class="line">[preflight/images] You can also perform this action <span class="keyword">in</span> beforehand using <span class="string">'kubeadm config images pull'</span></span><br><span class="line">[kubelet] Writing kubelet environment file with flags to file <span class="string">"/var/lib/kubelet/kubeadm-flags.env"</span></span><br><span class="line">[kubelet] Writing kubelet configuration to file <span class="string">"/var/lib/kubelet/config.yaml"</span></span><br><span class="line">[preflight] Activating the kubelet service</span><br><span class="line">[certificates] Generated ca certificate and key.</span><br><span class="line">[certificates] Generated apiserver certificate and key.</span><br><span class="line">[certificates] apiserver serving cert is signed <span class="keyword">for</span> DNS names [k8s-ha-1 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 192.168.115.250 192.168.115.250 192.168.115.250]</span><br><span class="line">[certificates] Generated apiserver-kubelet-client certificate and key.</span><br><span class="line">[certificates] Generated sa key and public key.</span><br><span class="line">[certificates] Generated front-proxy-ca certificate and key.</span><br><span class="line">[certificates] Generated front-proxy-client certificate and key.</span><br><span class="line">[certificates] Generated etcd/ca certificate and key.</span><br><span class="line">[certificates] Generated etcd/server certificate and key.</span><br><span class="line">[certificates] etcd/server serving cert is signed <span class="keyword">for</span> DNS names [k8s-ha-1 localhost] and IPs [127.0.0.1 ::1 192.168.115.83]</span><br><span class="line">[certificates] Generated etcd/peer certificate and key.</span><br><span class="line">[certificates] etcd/peer serving cert is signed <span class="keyword">for</span> DNS names [k8s-ha-1 localhost] and IPs [192.168.115.83 127.0.0.1 ::1 192.168.115.83]</span><br><span class="line">[certificates] Generated etcd/healthcheck-client certificate and key.</span><br><span class="line">[certificates] Generated apiserver-etcd-client certificate and key.</span><br><span class="line">[certificates] valid certificates and keys now exist <span class="keyword">in</span> <span class="string">"/etc/kubernetes/pki"</span></span><br><span class="line">[endpoint] WARNING: port specified <span class="keyword">in</span> api.controlPlaneEndpoint overrides api.bindPort <span class="keyword">in</span> the controlplane address</span><br><span class="line">[kubeconfig] Wrote KubeConfig file to disk: <span class="string">"/etc/kubernetes/admin.conf"</span></span><br><span class="line">[kubeconfig] Wrote KubeConfig file to disk: <span class="string">"/etc/kubernetes/kubelet.conf"</span></span><br><span class="line">[kubeconfig] Wrote KubeConfig file to disk: <span class="string">"/etc/kubernetes/controller-manager.conf"</span></span><br><span class="line">[kubeconfig] Wrote KubeConfig file to disk: <span class="string">"/etc/kubernetes/scheduler.conf"</span></span><br><span class="line">[controlplane] wrote Static Pod manifest <span class="keyword">for</span> component kube-apiserver to <span class="string">"/etc/kubernetes/manifests/kube-apiserver.yaml"</span></span><br><span class="line">[controlplane] wrote Static Pod manifest <span class="keyword">for</span> component kube-controller-manager to <span class="string">"/etc/kubernetes/manifests/kube-controller-manager.yaml"</span></span><br><span class="line">[controlplane] wrote Static Pod manifest <span class="keyword">for</span> component kube-scheduler to <span class="string">"/etc/kubernetes/manifests/kube-scheduler.yaml"</span></span><br><span class="line">[etcd] Wrote Static Pod manifest <span class="keyword">for</span> a <span class="built_in">local</span> etcd instance to <span class="string">"/etc/kubernetes/manifests/etcd.yaml"</span></span><br><span class="line">[init] waiting <span class="keyword">for</span> the kubelet to boot up the control plane as Static Pods from directory <span class="string">"/etc/kubernetes/manifests"</span></span><br><span class="line">[init] this might take a minute or longer <span class="keyword">if</span> the control plane images have to be pulled</span><br><span class="line">[apiclient] All control plane components are healthy after 113.002871 seconds</span><br><span class="line">[uploadconfig] storing the configuration used <span class="keyword">in</span> ConfigMap <span class="string">"kubeadm-config"</span> <span class="keyword">in</span> the <span class="string">"kube-system"</span> Namespace</span><br><span class="line">[kubelet] Creating a ConfigMap <span class="string">"kubelet-config-1.11"</span> <span class="keyword">in</span> namespace kube-system with the configuration <span class="keyword">for</span> the kubelets <span class="keyword">in</span> the cluster</span><br><span class="line">[markmaster] Marking the node k8s-ha-1 as master by adding the label <span class="string">"node-role.kubernetes.io/master=''"</span></span><br><span class="line">[markmaster] Marking the node k8s-ha-1 as master by adding the taints [node-role.kubernetes.io/master:NoSchedule]</span><br><span class="line">[patchnode] Uploading the CRI Socket information <span class="string">"/var/run/dockershim.sock"</span> to the Node API object <span class="string">"k8s-ha-1"</span> as an annotation</span><br><span class="line">[bootstraptoken] using token: d176j4.otwlnrvxipdrfm1x</span><br><span class="line">[bootstraptoken] configured RBAC rules to allow Node Bootstrap tokens to post CSRs <span class="keyword">in</span> order <span class="keyword">for</span> nodes to get long term certificate credentials</span><br><span class="line">[bootstraptoken] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span><br><span class="line">[bootstraptoken] configured RBAC rules to allow certificate rotation <span class="keyword">for</span> all node client certificates <span class="keyword">in</span> the cluster</span><br><span class="line">[bootstraptoken] creating the <span class="string">"cluster-info"</span> ConfigMap <span class="keyword">in</span> the <span class="string">"kube-public"</span> namespace</span><br><span class="line">[addons] Applied essential addon: CoreDNS</span><br><span class="line">[endpoint] WARNING: port specified <span class="keyword">in</span> api.controlPlaneEndpoint overrides api.bindPort <span class="keyword">in</span> the controlplane address</span><br><span class="line">[addons] Applied essential addon: kube-proxy</span><br><span class="line"></span><br><span class="line">Your Kubernetes master has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">You can now join any number of machines by running the following on each node</span><br><span class="line">as root:</span><br><span class="line"></span><br><span class="line">  kubeadm join 192.168.115.250:8443 --token d176j4.otwlnrvxipdrfm1x --discovery-token-ca-cert-hash sha256:c92773b72002e0080b4c6639f65ce411d10dd7f029feee29b2001d55a06ea007</span><br></pre></td></tr></table></figure>

<p>拷贝证书及配置文件到其他两个节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">USER=centos</span><br><span class="line">CONTROL_PLANE_IPS=<span class="string">"192.168.115.84 192.168.115.85"</span></span><br><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span> <span class="variable">$&#123;CONTROL_PLANE_IPS&#125;</span>; <span class="keyword">do</span></span><br><span class="line">    scp /etc/kubernetes/pki/ca.crt <span class="string">"<span class="variable">$&#123;USER&#125;</span>"</span>@<span class="variable">$host</span>:</span><br><span class="line">    scp /etc/kubernetes/pki/ca.key <span class="string">"<span class="variable">$&#123;USER&#125;</span>"</span>@<span class="variable">$host</span>:</span><br><span class="line">    scp /etc/kubernetes/pki/sa.key <span class="string">"<span class="variable">$&#123;USER&#125;</span>"</span>@<span class="variable">$host</span>:</span><br><span class="line">    scp /etc/kubernetes/pki/sa.pub <span class="string">"<span class="variable">$&#123;USER&#125;</span>"</span>@<span class="variable">$host</span>:</span><br><span class="line">    scp /etc/kubernetes/pki/front-proxy-ca.crt <span class="string">"<span class="variable">$&#123;USER&#125;</span>"</span>@<span class="variable">$host</span>:</span><br><span class="line">    scp /etc/kubernetes/pki/front-proxy-ca.key <span class="string">"<span class="variable">$&#123;USER&#125;</span>"</span>@<span class="variable">$host</span>:</span><br><span class="line">    scp /etc/kubernetes/pki/etcd/ca.crt <span class="string">"<span class="variable">$&#123;USER&#125;</span>"</span>@<span class="variable">$host</span>:etcd-ca.crt</span><br><span class="line">    scp /etc/kubernetes/pki/etcd/ca.key <span class="string">"<span class="variable">$&#123;USER&#125;</span>"</span>@<span class="variable">$host</span>:etcd-ca.key</span><br><span class="line">    scp /etc/kubernetes/admin.conf <span class="string">"<span class="variable">$&#123;USER&#125;</span>"</span>@<span class="variable">$host</span>:</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h4 id="启动第二个控制节点"><a href="#启动第二个控制节点" class="headerlink" title="启动第二个控制节点"></a>启动第二个控制节点</h4><p>创建 kubeadm-config.yaml 模板文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1alpha2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">MasterConfiguration</span></span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="string">v1.11.2</span></span><br><span class="line"><span class="attr">apiServerCertSANs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">"192.168.115.250"</span></span><br><span class="line"><span class="attr">api:</span></span><br><span class="line"><span class="attr">    controlPlaneEndpoint:</span> <span class="string">"192.168.115.250:8443"</span></span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line"><span class="attr">  local:</span></span><br><span class="line"><span class="attr">    extraArgs:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">"k8s-ha-2"</span></span><br><span class="line"><span class="attr">      listen-client-urls:</span> <span class="string">"https://127.0.0.1:2379,https://192.168.115.84:2379"</span></span><br><span class="line"><span class="attr">      advertise-client-urls:</span> <span class="string">"https://192.168.115.84:2379"</span></span><br><span class="line"><span class="attr">      listen-peer-urls:</span> <span class="string">"https://192.168.115.84:2380"</span></span><br><span class="line"><span class="attr">      initial-advertise-peer-urls:</span> <span class="string">"https://192.168.115.84:2380"</span></span><br><span class="line"><span class="attr">      initial-cluster:</span> <span class="string">"k8s-ha-1=https://192.168.115.83:2380,k8s-ha-2=https://192.168.115.84:2380"</span></span><br><span class="line"><span class="attr">      initial-cluster-state:</span> <span class="string">existing</span></span><br><span class="line"><span class="attr">    serverCertSANs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">192.168</span><span class="number">.115</span><span class="number">.84</span></span><br><span class="line"><span class="attr">    peerCertSANs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">192.168</span><span class="number">.115</span><span class="number">.84</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">    <span class="comment"># This CIDR is a Canal default. Substitute or remove for your CNI provider.</span></span><br><span class="line"><span class="attr">    podSubnet:</span> <span class="string">"10.244.0.0/16"</span></span><br><span class="line"><span class="attr">controllerManagerExtraArgs:</span></span><br><span class="line"><span class="attr">  address:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">schedulerExtraArgs:</span></span><br><span class="line"><span class="attr">  address:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>

<p>拷贝证书及配置文件到正确目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">USER=centos</span><br><span class="line">mkdir -p /etc/kubernetes/pki/etcd</span><br><span class="line">mv /home/<span class="variable">$&#123;USER&#125;</span>/ca.crt /etc/kubernetes/pki/</span><br><span class="line">mv /home/<span class="variable">$&#123;USER&#125;</span>/ca.key /etc/kubernetes/pki/</span><br><span class="line">mv /home/<span class="variable">$&#123;USER&#125;</span>/sa.pub /etc/kubernetes/pki/</span><br><span class="line">mv /home/<span class="variable">$&#123;USER&#125;</span>/sa.key /etc/kubernetes/pki/</span><br><span class="line">mv /home/<span class="variable">$&#123;USER&#125;</span>/front-proxy-ca.crt /etc/kubernetes/pki/</span><br><span class="line">mv /home/<span class="variable">$&#123;USER&#125;</span>/front-proxy-ca.key /etc/kubernetes/pki/</span><br><span class="line">mv /home/<span class="variable">$&#123;USER&#125;</span>/etcd-ca.crt /etc/kubernetes/pki/etcd/ca.crt</span><br><span class="line">mv /home/<span class="variable">$&#123;USER&#125;</span>/etcd-ca.key /etc/kubernetes/pki/etcd/ca.key</span><br><span class="line">mv /home/<span class="variable">$&#123;USER&#125;</span>/admin.conf /etc/kubernetes/admin.conf</span><br></pre></td></tr></table></figure>

<p>启动kubelet</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubeadm alpha phase certs all --config kubeadm-config.yaml</span><br><span class="line">kubeadm alpha phase kubelet config write-to-disk --config kubeadm-config.yaml</span><br><span class="line">kubeadm alpha phase kubelet write-env-file --config kubeadm-config.yaml</span><br><span class="line">kubeadm alpha phase kubeconfig kubelet --config kubeadm-config.yaml</span><br><span class="line">systemctl start kubelet</span><br></pre></td></tr></table></figure>

<p>将etcd加入集群</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> CP0_IP=192.168.115.83</span><br><span class="line"><span class="built_in">export</span> CP0_HOSTNAME=k8s-ha-1</span><br><span class="line"><span class="built_in">export</span> CP1_IP=192.168.115.84</span><br><span class="line"><span class="built_in">export</span> CP1_HOSTNAME=k8s-ha-2</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line">kubectl <span class="built_in">exec</span> -n kube-system etcd-<span class="variable">$&#123;CP0_HOSTNAME&#125;</span> -- etcdctl --ca-file /etc/kubernetes/pki/etcd/ca.crt --cert-file /etc/kubernetes/pki/etcd/peer.crt --key-file /etc/kubernetes/pki/etcd/peer.key --endpoints=https://<span class="variable">$&#123;CP0_IP&#125;</span>:2379 member add <span class="variable">$&#123;CP1_HOSTNAME&#125;</span> https://<span class="variable">$&#123;CP1_IP&#125;</span>:2380</span><br><span class="line">kubeadm alpha phase etcd <span class="built_in">local</span> --config kubeadm-config.yaml</span><br></pre></td></tr></table></figure>

<p>部署控制组件并标记为master</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubeadm alpha phase kubeconfig all --config kubeadm-config.yaml</span><br><span class="line">kubeadm alpha phase controlplane all --config kubeadm-config.yaml</span><br><span class="line">kubeadm alpha phase mark-master --config kubeadm-config.yaml</span><br></pre></td></tr></table></figure>

<p>等待etcd启动成功后（etcd-k8s-ha-2 Running）再操作第三个节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-ha-2 ~]<span class="comment"># kubectl -n kube-system get pods</span></span><br><span class="line">NAME                               READY     STATUS    RESTARTS   AGE</span><br><span class="line">coredns-78fcdf6894-bbrp2           0/1       Pending   0          5m</span><br><span class="line">coredns-78fcdf6894-xf42d           0/1       Pending   0          5m</span><br><span class="line">etcd-k8s-ha-1                      1/1       Running   1          5m</span><br><span class="line">etcd-k8s-ha-2                      1/1       Running   0          30s</span><br><span class="line">kube-apiserver-k8s-ha-1            1/1       Running   0          5m</span><br><span class="line">kube-apiserver-k8s-ha-2            1/1       Running   0          2m</span><br><span class="line">kube-controller-manager-k8s-ha-1   1/1       Running   0          5m</span><br><span class="line">kube-controller-manager-k8s-ha-2   1/1       Running   0          2m</span><br><span class="line">kube-proxy-5rdqp                   1/1       Running   0          3m</span><br><span class="line">kube-proxy-vrw77                   1/1       Running   0          5m</span><br><span class="line">kube-scheduler-k8s-ha-1            1/1       Running   0          4m</span><br><span class="line">kube-scheduler-k8s-ha-2            1/1       Running   0          2m</span><br></pre></td></tr></table></figure>

<h4 id="启动第三个控制节点"><a href="#启动第三个控制节点" class="headerlink" title="启动第三个控制节点"></a>启动第三个控制节点</h4><p>创建 kubeadm-config.yaml 模板文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1alpha2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">MasterConfiguration</span></span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="string">v1.11.2</span></span><br><span class="line"><span class="attr">apiServerCertSANs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">"192.168.115.250"</span></span><br><span class="line"><span class="attr">api:</span></span><br><span class="line"><span class="attr">    controlPlaneEndpoint:</span> <span class="string">"192.168.115.250:8443"</span></span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line"><span class="attr">  local:</span></span><br><span class="line"><span class="attr">    extraArgs:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">"k8s-ha-3"</span></span><br><span class="line"><span class="attr">      listen-client-urls:</span> <span class="string">"https://127.0.0.1:2379,https://192.168.115.85:2379"</span></span><br><span class="line"><span class="attr">      advertise-client-urls:</span> <span class="string">"https://192.168.115.85:2379"</span></span><br><span class="line"><span class="attr">      listen-peer-urls:</span> <span class="string">"https://192.168.115.85:2380"</span></span><br><span class="line"><span class="attr">      initial-advertise-peer-urls:</span> <span class="string">"https://192.168.115.85:2380"</span></span><br><span class="line"><span class="attr">      initial-cluster:</span> <span class="string">"k8s-ha-1=https://192.168.115.83:2380,k8s-ha-2=https://192.168.115.84:2380,k8s-ha-3=https://192.168.115.85:2380"</span></span><br><span class="line"><span class="attr">      initial-cluster-state:</span> <span class="string">existing</span></span><br><span class="line"><span class="attr">    serverCertSANs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">192.168</span><span class="number">.115</span><span class="number">.85</span></span><br><span class="line"><span class="attr">    peerCertSANs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">192.168</span><span class="number">.115</span><span class="number">.85</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">    <span class="comment"># This CIDR is a Canal default. Substitute or remove for your CNI provider.</span></span><br><span class="line"><span class="attr">    podSubnet:</span> <span class="string">"10.244.0.0/16"</span></span><br><span class="line"><span class="attr">controllerManagerExtraArgs:</span></span><br><span class="line"><span class="attr">  address:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">schedulerExtraArgs:</span></span><br><span class="line"><span class="attr">  address:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>

<p>拷贝证书及配置文件到正确目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">USER=centos</span><br><span class="line">mkdir -p /etc/kubernetes/pki/etcd</span><br><span class="line">mv /home/<span class="variable">$&#123;USER&#125;</span>/ca.crt /etc/kubernetes/pki/</span><br><span class="line">mv /home/<span class="variable">$&#123;USER&#125;</span>/ca.key /etc/kubernetes/pki/</span><br><span class="line">mv /home/<span class="variable">$&#123;USER&#125;</span>/sa.pub /etc/kubernetes/pki/</span><br><span class="line">mv /home/<span class="variable">$&#123;USER&#125;</span>/sa.key /etc/kubernetes/pki/</span><br><span class="line">mv /home/<span class="variable">$&#123;USER&#125;</span>/front-proxy-ca.crt /etc/kubernetes/pki/</span><br><span class="line">mv /home/<span class="variable">$&#123;USER&#125;</span>/front-proxy-ca.key /etc/kubernetes/pki/</span><br><span class="line">mv /home/<span class="variable">$&#123;USER&#125;</span>/etcd-ca.crt /etc/kubernetes/pki/etcd/ca.crt</span><br><span class="line">mv /home/<span class="variable">$&#123;USER&#125;</span>/etcd-ca.key /etc/kubernetes/pki/etcd/ca.key</span><br><span class="line">mv /home/<span class="variable">$&#123;USER&#125;</span>/admin.conf /etc/kubernetes/admin.conf</span><br></pre></td></tr></table></figure>

<p>启动kubelet</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubeadm alpha phase certs all --config kubeadm-config.yaml</span><br><span class="line">kubeadm alpha phase kubelet config write-to-disk --config kubeadm-config.yaml</span><br><span class="line">kubeadm alpha phase kubelet write-env-file --config kubeadm-config.yaml</span><br><span class="line">kubeadm alpha phase kubeconfig kubelet --config kubeadm-config.yaml</span><br><span class="line">systemctl start kubelet</span><br></pre></td></tr></table></figure>

<p>将etcd加入集群</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> CP0_IP=192.168.115.83</span><br><span class="line"><span class="built_in">export</span> CP0_HOSTNAME=k8s-ha-1</span><br><span class="line"><span class="built_in">export</span> CP2_IP=192.168.115.85</span><br><span class="line"><span class="built_in">export</span> CP2_HOSTNAME=k8s-ha-3</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line">kubectl <span class="built_in">exec</span> -n kube-system etcd-<span class="variable">$&#123;CP0_HOSTNAME&#125;</span> -- etcdctl --ca-file /etc/kubernetes/pki/etcd/ca.crt --cert-file /etc/kubernetes/pki/etcd/peer.crt --key-file /etc/kubernetes/pki/etcd/peer.key --endpoints=https://<span class="variable">$&#123;CP0_IP&#125;</span>:2379 member add <span class="variable">$&#123;CP2_HOSTNAME&#125;</span> https://<span class="variable">$&#123;CP2_IP&#125;</span>:2380</span><br><span class="line">kubeadm alpha phase etcd <span class="built_in">local</span> --config kubeadm-config.yaml</span><br></pre></td></tr></table></figure>

<p>部署控制组件并标记为master</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubeadm alpha phase kubeconfig all --config kubeadm-config.yaml</span><br><span class="line">kubeadm alpha phase controlplane all --config kubeadm-config.yaml</span><br><span class="line">kubeadm alpha phase mark-master --config kubeadm-config.yaml</span><br></pre></td></tr></table></figure>

<h4 id="允许pod调度到master节点上"><a href="#允许pod调度到master节点上" class="headerlink" title="允许pod调度到master节点上"></a>允许pod调度到master节点上</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line">[root@k8s-ha-2 ~]<span class="comment"># kubectl taint nodes --all node-role.kubernetes.io/master-</span></span><br><span class="line">node/k8s-ha-1 untainted</span><br><span class="line">node/k8s-ha-2 untainted</span><br><span class="line">node/k8s-ha-3 untainted</span><br></pre></td></tr></table></figure>

<h4 id="工作节点加入集群"><a href="#工作节点加入集群" class="headerlink" title="工作节点加入集群"></a>工作节点加入集群</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启用 ip_vs 相关内核模块，并将下面命令写入 /etc/sysconfig/modules/ip_vs.modules</span></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">modprobe ip_vs</span><br><span class="line">modprobe ip_vs_rr</span><br><span class="line">modprobe ip_vs_wrr</span><br><span class="line">modprobe ip_vs_sh</span><br><span class="line"><span class="comment"># 修改配置文件权限</span></span><br><span class="line">chmod +x /etc/sysconfig/modules/ip_vs.modules</span><br><span class="line"></span><br><span class="line"><span class="comment"># Kubernetes v1.8+ 要求关闭系统 Swap，请在所有节点利用以下指令关闭：</span></span><br><span class="line">swapoff -a &amp;&amp; sysctl -w vm.swappiness=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注释到swap相关的行</span></span><br><span class="line">vi /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加入k8s集群</span></span><br><span class="line">kubeadm join 192.168.115.250:8443 --token d176j4.otwlnrvxipdrfm1x --discovery-token-ca-cert-hash sha256:c92773b72002e0080b4c6639f65ce411d10dd7f029feee29b2001d55a06ea007</span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet</span><br></pre></td></tr></table></figure>

<h3 id="部署网络插件"><a href="#部署网络插件" class="headerlink" title="部署网络插件"></a>部署网络插件</h3><p>在此使用 Canal 网络插件，Canal 使用 Calico 做网络策略，使用 Flannel 进行网络通信。Canal 进行 kubeadm init 时设置 –pod-network-cidr=10.244.0.0/16，其他网络插件参考：<a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/#pod-network" target="_blank" rel="noopener">https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/#pod-network</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-ha-2 ~]<span class="comment"># kubectl apply -f https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/canal/rbac.yaml</span></span><br><span class="line">clusterrole.rbac.authorization.k8s.io/calico created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/flannel created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/canal-flannel created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/canal-calico created</span><br><span class="line">[root@k8s-ha-2 ~]<span class="comment"># kubectl apply -f https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/canal/canal.yaml</span></span><br><span class="line">configmap/canal-config created</span><br><span class="line">daemonset.extensions/canal created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created</span><br><span class="line">serviceaccount/canal created</span><br></pre></td></tr></table></figure>

<p>coredns DNS插件在网络插件部署完成后也部署完成了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-ha-2 ~]<span class="comment"># kubectl -n kube-system get pods</span></span><br><span class="line">NAME                               READY     STATUS    RESTARTS   AGE</span><br><span class="line">canal-n6bks                        3/3       Running   0          8m</span><br><span class="line">canal-q8grs                        3/3       Running   0          8m</span><br><span class="line">canal-rkwzw                        3/3       Running   0          8m</span><br><span class="line">coredns-78fcdf6894-bbrp2           1/1       Running   0          29m</span><br><span class="line">coredns-78fcdf6894-xf42d           1/1       Running   0          29m</span><br><span class="line">etcd-k8s-ha-1                      1/1       Running   1          29m</span><br><span class="line">etcd-k8s-ha-2                      1/1       Running   0          24m</span><br><span class="line">etcd-k8s-ha-3                      1/1       Running   0          20m</span><br><span class="line">kube-apiserver-k8s-ha-1            1/1       Running   0          29m</span><br><span class="line">kube-apiserver-k8s-ha-2            1/1       Running   0          26m</span><br><span class="line">kube-apiserver-k8s-ha-3            1/1       Running   1          21m</span><br><span class="line">kube-controller-manager-k8s-ha-1   1/1       Running   2          29m</span><br><span class="line">kube-controller-manager-k8s-ha-2   1/1       Running   0          26m</span><br><span class="line">kube-controller-manager-k8s-ha-3   1/1       Running   0          21m</span><br><span class="line">kube-proxy-5rdqp                   1/1       Running   0          28m</span><br><span class="line">kube-proxy-6b4qs                   1/1       Running   0          21m</span><br><span class="line">kube-proxy-vrw77                   1/1       Running   0          29m</span><br><span class="line">kube-scheduler-k8s-ha-1            1/1       Running   0          29m</span><br><span class="line">kube-scheduler-k8s-ha-2            1/1       Running   0          26m</span><br><span class="line">kube-scheduler-k8s-ha-3            1/1       Running   0          21m</span><br></pre></td></tr></table></figure>

<h3 id="使用-helm-部署应用"><a href="#使用-helm-部署应用" class="headerlink" title="使用 helm 部署应用"></a>使用 helm 部署应用</h3><p>下载并安装helm</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://storage.googleapis.com/kubernetes-helm/helm-v2.10.0-linux-amd64.tar.gz</span><br><span class="line">tar xzvf helm-v2.10.0-linux-amd64.tar.gz</span><br><span class="line">cp linux-amd64/helm /usr/<span class="built_in">local</span>/bin/</span><br><span class="line">chmod +x /usr/<span class="built_in">local</span>/bin/helm</span><br></pre></td></tr></table></figure>

<p>创建helm服务账号</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">vi helm-service-account.yaml</span><br><span class="line"><span class="comment"># Create a service account for Helm and grant the cluster admin role.</span></span><br><span class="line"><span class="comment"># It is assumed that helm should be installed with this service account</span></span><br><span class="line"><span class="comment"># (tiller).</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: tiller</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: tiller</span><br><span class="line">  namespace: kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建账号</span></span><br><span class="line">kubectl create -f helm-service-account.yaml</span><br><span class="line"><span class="comment"># 初始化服务器端部署工具tiller</span></span><br><span class="line">helm init --service-account tiller</span><br><span class="line"><span class="comment"># 等待部署tiller完成</span></span><br><span class="line">kubectl -n kube-system get pods</span><br><span class="line">NAME                               READY     STATUS    RESTARTS   AGE</span><br><span class="line">......</span><br><span class="line">tiller-deploy-56c4cf647b-plfnf     1/1       Running   0          7m</span><br></pre></td></tr></table></figure>

<p>部署 wordpress 应用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建命名空间</span></span><br><span class="line">kubectl create namespace wordpress</span><br><span class="line"><span class="comment"># 通过helm部署wordpress应用</span></span><br><span class="line">helm install --namespace wordpress --name wordpress --<span class="built_in">set</span> persistence.enabled=<span class="literal">false</span> --<span class="built_in">set</span> mariadb.master.persistence.enabled=<span class="literal">false</span> stable/wordpress</span><br><span class="line"><span class="comment"># 更新wordpress应用通过NodePort访问</span></span><br><span class="line">helm upgrade --namespace wordpress --<span class="built_in">set</span> persistence.enabled=<span class="literal">false</span> --<span class="built_in">set</span> mariadb.master.persistence.enabled=<span class="literal">false</span> --<span class="built_in">set</span> serviceType=NodePort wordpress stable/wordpress</span><br></pre></td></tr></table></figure>

<p>查看部署情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-ha-2 ~]<span class="comment"># kubectl -n wordpress -o wide get pods</span></span><br><span class="line">NAME                                   READY     STATUS    RESTARTS   AGE       IP           NODE       NOMINATED NODE</span><br><span class="line">wordpress-mariadb-0                    1/1       Running   0          20m       10.244.2.7   k8s-ha-3   &lt;none&gt;</span><br><span class="line">wordpress-wordpress-75c5698f99-z5zql   1/1       Running   0          7m        10.244.1.2   k8s-ha-2   &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>获取服务访问信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">192.168.115.83[root@k8s-ha-2 ~]<span class="comment"># kubectl get svc --namespace wordpress -w wordpress-wordpress</span></span><br><span class="line">NAME                  TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">wordpress-wordpress   NodePort   10.111.15.23   &lt;none&gt;        80:32554/TCP,443:31949/TCP   13h</span><br><span class="line"></span><br><span class="line">[root@k8s-ha-2 ~]<span class="comment"># export NODE_PORT=$(kubectl get --namespace wordpress -o jsonpath="&#123;.spec.ports[0].nodePort&#125;" services wordpress-wordpress)</span></span><br><span class="line">[root@k8s-ha-2 ~]<span class="comment"># export NODE_IP=$(kubectl get nodes --namespace wordpress -o jsonpath="&#123;.items[0].status.addresses[0].address&#125;")</span></span><br><span class="line"><span class="comment"># 可以通过浮动IP+NodePort访问应用，192.168.115.83的浮动IP（外部访问IP）为10.70.93.97</span></span><br><span class="line">[root@k8s-ha-2 ~]<span class="comment"># echo "WordPress URL: http://$NODE_IP:$NODE_PORT/"</span></span><br><span class="line">WordPress URL: http://192.168.115.83:32554/</span><br></pre></td></tr></table></figure>

<p>通过浮动IP+NodePort访问验证服务</p>
<p><img src="/imgs/201809/k8s_wp.png" alt="Kubernetes wp服务"></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/docker/">docker</a><a href="/tags/container/">container</a><a href="/tags/kubernetes/">kubernetes</a><a href="/tags/k8s/">k8s</a><a href="/tags/kubeadm/">kubeadm</a><a href="/tags/kubectl/">kubectl</a><a href="/tags/helm/">helm</a>
    </span>
    

    </div>

    
  </div>
</article>

  

	<section id="comment" class="comment">
		<div id="gitment"></div>
	</section>
	<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
	<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
	<script>
		var gitment = new Gitment({
			owner: 'ist0ne',
			repo: 'gitment',
			oauth: {
				client_id: 'a3a5af94aef00fdf0c24',
				client_secret: '3d47316b6b7d0b98ba405da19a65457357256f2d',
			},
		})
		gitment.render('gitment')
	</script>





    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2019 ist0ne
    
  </p>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-39923501-1', 'auto');
    ga('send', 'pageview');

</script>

  </div>
</div>
</body>
</html>