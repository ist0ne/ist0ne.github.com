<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>CentOS 6.4 Puppet 3.2.4安装 | 石头记 | Docker、Kubernetes、CI/CD 等技术分享</title>

  
  <meta name="author" content="ist0ne">
  

  
  <meta name="description" content="CentOS 6.4 Puppet 3.2.4安装">
  

  
  <meta name="keywords" content="blog kubernetes k8s docker container ceph salt saltstack openstack kube kubectl helm charts gitlab git">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="CentOS 6.4 Puppet 3.2.4安装">

  <meta property="og:site_name" content="石头记">

  
  <meta property="og:image" content="/favicon.ico">
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="石头记" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">石头记</a>
    </h1>
    <p class="site-description">Docker、Kubernetes、CI/CD 等技术分享</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
        <li><a href="/atom.xml">订阅</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>CentOS 6.4 Puppet 3.2.4安装</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2014/05/19/puppet-install/" rel="bookmark">
        <time class="entry-date published" datetime="2014-05-19T02:00:00.000Z">
          2014-05-19
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>本文主要描述puppet的安装、加固、Puppet-dashboard安装、Puppet模块、hiera使用以及自定义facts。</p>
<h2 id="1、在Puppet-Server和Puppet-Client上关闭防火墙和selinux"><a href="#1、在Puppet-Server和Puppet-Client上关闭防火墙和selinux" class="headerlink" title="1、在Puppet Server和Puppet Client上关闭防火墙和selinux"></a>1、在Puppet Server和Puppet Client上关闭防火墙和selinux</h2><p>清除防火墙设置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -F</span><br></pre></td></tr></table></figure>
<p>保存设置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/iptables save</span><br></pre></td></tr></table></figure>
<p>设置selinux为disable</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysconfig/selinux</span><br><span class="line">SELINUX=disabled</span><br></pre></td></tr></table></figure>
<h2 id="2、在Puppet-Server和Puppet-Client上设置hosts，puppet通过主机名区分各节点"><a href="#2、在Puppet-Server和Puppet-Client上设置hosts，puppet通过主机名区分各节点" class="headerlink" title="2、在Puppet Server和Puppet Client上设置hosts，puppet通过主机名区分各节点"></a>2、在Puppet Server和Puppet Client上设置hosts，puppet通过主机名区分各节点</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">10.10.10.10     puppet.example.com</span><br><span class="line">10.10.10.11     zabbix.example.com</span><br></pre></td></tr></table></figure>
<h2 id="3、在Puppet-Server和Puppet-Client上安装puppetlabs-com仓库"><a href="#3、在Puppet-Server和Puppet-Client上安装puppetlabs-com仓库" class="headerlink" title="3、在Puppet Server和Puppet Client上安装puppetlabs.com仓库"></a>3、在Puppet Server和Puppet Client上安装puppetlabs.com仓库</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y http://yum.puppetlabs.com/el/6Server/products/x86_64/puppetlabs-release-6-7.noarch.rpm</span><br></pre></td></tr></table></figure>
<h2 id="4、在Puppet-Server上安装puppet-server"><a href="#4、在Puppet-Server上安装puppet-server" class="headerlink" title="4、在Puppet Server上安装puppet-server"></a>4、在Puppet Server上安装puppet-server</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y puppet-server</span><br></pre></td></tr></table></figure>
<h2 id="5、在Puppet-Server上启动puppetmaster服务"><a href="#5、在Puppet-Server上启动puppetmaster服务" class="headerlink" title="5、在Puppet Server上启动puppetmaster服务"></a>5、在Puppet Server上启动puppetmaster服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># /etc/init.d/puppetmaster start</span></span><br><span class="line">启动 puppetmaster：                                        [确定]</span><br></pre></td></tr></table></figure>
<h2 id="6、在Puppet-Server上查看证书"><a href="#6、在Puppet-Server上查看证书" class="headerlink" title="6、在Puppet Server上查看证书"></a>6、在Puppet Server上查看证书</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># puppet cert list --all</span></span><br><span class="line">\+ <span class="string">"puppet.example.com"</span> (SHA256) 44:E4:8C:B2:F9:9D:38:3B:7C:68:7B:D3:21:0D:2F:64:B5:FB:8C:F7:78:85:BE:50:D9:A2:C7:CA:67:98:13:00 (alt names: <span class="string">"DNS:puppet"</span>, <span class="string">"DNS:puppet.example.com"</span>)</span><br></pre></td></tr></table></figure>
<h2 id="7、使用apache-passenger-运行puppet-server"><a href="#7、使用apache-passenger-运行puppet-server" class="headerlink" title="7、使用apache + passenger 运行puppet-server"></a>7、使用apache + passenger 运行puppet-server</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install httpd httpd-devel ruby-devel mod_ssl make gcc gcc-c++ curl-devel openssl-devel zlib-devel</span><br></pre></td></tr></table></figure>
<p>安装rack和passenger</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># gem install -v=1.5.2 rack</span></span><br><span class="line">Successfully installed rack-1.5.2</span><br><span class="line">1 gem installed</span><br><span class="line">Installing ri documentation <span class="keyword">for</span> rack-1.5.2...</span><br><span class="line">Installing RDoc documentation <span class="keyword">for</span> rack-1.5.2...</span><br><span class="line"></span><br><span class="line">[root@puppet ~]<span class="comment"># gem install -v=4.0.14 passenger</span></span><br><span class="line">Building native extensions.  This could take a <span class="keyword">while</span>...</span><br><span class="line">Successfully installed passenger-4.0.14</span><br><span class="line">1 gem installed</span><br><span class="line">Installing ri documentation <span class="keyword">for</span> passenger-4.0.14...</span><br><span class="line">Installing RDoc documentation <span class="keyword">for</span> passenger-4.0.14...</span><br></pre></td></tr></table></figure>
<p>编译passenger</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passenger-install-apache2-module</span><br></pre></td></tr></table></figure>
<p>配置Puppet rack应用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/puppet/rack/</span><br><span class="line">mkdir /etc/puppet/rack/public /etc/puppet/rack/tmp</span><br><span class="line">cp /usr/share/puppet/ext/rack/example-passenger-vhost.conf /etc/httpd/conf.d/puppetmasterd.conf</span><br><span class="line">cp /usr/share/puppet/ext/rack/config.ru /etc/puppet/rack/</span><br><span class="line">chown -R puppet.puppet /etc/puppet/rack/</span><br><span class="line"></span><br><span class="line">ln -s /var/lib/puppet/ssl/ /etc/puppet/</span><br><span class="line"></span><br><span class="line">[root@puppet ~]<span class="comment"># vi /etc/httpd/conf.d/passenger.conf</span></span><br><span class="line">LoadModule passenger_module /usr/lib/ruby/gems/1.8/gems/passenger-4.0.14/buildout/apache2/mod_passenger.so</span><br><span class="line">PassengerRoot /usr/lib/ruby/gems/1.8/gems/passenger-4.0.14</span><br><span class="line">PassengerDefaultRuby /usr/bin/ruby</span><br><span class="line">PassengerMaxPoolSize 30</span><br><span class="line">PassengerPoolIdleTime 1500</span><br><span class="line">PassengerMaxRequests 1000</span><br><span class="line">PassengerStatThrottleRate 120</span><br></pre></td></tr></table></figure>
<p>如下修改puppetmasterd.conf</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/httpd/conf.d/puppetmasterd.conf</span><br><span class="line"></span><br><span class="line">Listen <span class="number">8140</span></span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *<span class="symbol">:</span><span class="number">8140</span>&gt;</span><br><span class="line">        SSLEngine on</span><br><span class="line">        SSLProtocol -ALL +SSLv3 +TLSv1</span><br><span class="line">        SSLCipherSuite <span class="symbol">ALL:</span>!<span class="symbol">ADH:</span>RC4+<span class="symbol">RSA:</span>+<span class="symbol">HIGH:</span>+<span class="symbol">MEDIUM:</span>-<span class="symbol">LOW:</span>-<span class="symbol">SSLv2:</span>-EXP</span><br><span class="line"></span><br><span class="line">        SSLCertificateFile      /etc/puppet/ssl/certs/puppet.example.com.pem</span><br><span class="line">        SSLCertificateKeyFile   /etc/puppet/ssl/private_keys/puppet.example.com.pem</span><br><span class="line">        SSLCertificateChainFile /etc/puppet/ssl/ca/ca_crt.pem</span><br><span class="line">        SSLCACertificateFile    /etc/puppet/ssl/ca/ca_crt.pem</span><br><span class="line">        <span class="comment"># If Apache complains about invalid signatures on the CRL, you can try disabling</span></span><br><span class="line">        <span class="comment"># CRL checking by commenting the next line, but this is not recommended.</span></span><br><span class="line">        SSLCARevocationFile     /etc/puppet/ssl/ca/ca_crl.pem</span><br><span class="line">        SSLVerifyClient optional</span><br><span class="line">        SSLVerifyDepth  <span class="number">1</span></span><br><span class="line">        <span class="comment"># The `ExportCertData` option is needed for agent certificate expiration warnings</span></span><br><span class="line">        SSLOptions +StdEnvVars +ExportCertData</span><br><span class="line"></span><br><span class="line">        <span class="comment"># This header needs to be set if using a loadbalancer or proxy</span></span><br><span class="line">        RequestHeader unset X-Forwarded-For</span><br><span class="line"></span><br><span class="line">        RequestHeader set X-SSL-Subject <span class="string">%&#123;SSL_CLIENT_S_DN&#125;</span>e</span><br><span class="line">        RequestHeader set X-Client-DN <span class="string">%&#123;SSL_CLIENT_S_DN&#125;</span>e</span><br><span class="line">        RequestHeader set X-Client-Verify <span class="string">%&#123;SSL_CLIENT_VERIFY&#125;</span>e</span><br><span class="line"></span><br><span class="line">        DocumentRoot /etc/puppet/rack/public/</span><br><span class="line">        RackBaseURI /</span><br><span class="line">        &lt;Directory /etc/puppet/rack/public/&gt;</span><br><span class="line">                Options None</span><br><span class="line">                AllowOverride None</span><br><span class="line">                Order allow,deny</span><br><span class="line">                allow from all</span><br><span class="line">        &lt;<span class="regexp">/Directory&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>VirtualHost&gt;</span><br></pre></td></tr></table></figure>
<p>设置apache以puppet用户启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/httpd/conf/httpd.conf</span><br><span class="line">User puppet</span><br><span class="line">Group puppet</span><br></pre></td></tr></table></figure>
<p>设置 /etc/puppet/puppet.conf</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># vi /etc/puppet/puppet.conf</span></span><br><span class="line">[main]</span><br><span class="line">    <span class="comment"># The Puppet log directory.</span></span><br><span class="line">    <span class="comment"># The default value is '$vardir/log'.</span></span><br><span class="line">    logdir = <span class="regexp">/var/log</span><span class="regexp">/puppet</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    # Where Puppet PID files are kept.</span></span><br><span class="line"><span class="regexp">    # The default value is '$vardir/run</span><span class="string">'.</span></span><br><span class="line"><span class="string">    rundir = /var/run/puppet</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    # Where SSL certificates are kept.</span></span><br><span class="line"><span class="string">    # The default value is '</span>$confdir/ssl<span class="string">'.</span></span><br><span class="line"><span class="string">    ssldir = $vardir/ssl</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[master]</span></span><br><span class="line"><span class="string">    ssl_client_header = SSL_CLIENT_S_DN</span></span><br><span class="line"><span class="string">    ssl_client_verify_header = SSL_CLIENT_VERIFY</span></span><br><span class="line"><span class="string">    autosign = true</span></span><br><span class="line"><span class="string">    reports = store</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[agent]</span></span><br><span class="line"><span class="string">    # The file in which puppetd stores a list of the classes</span></span><br><span class="line"><span class="string">    # associated with the retrieved configuratiion.  Can be loaded in</span></span><br><span class="line"><span class="string">    # the separate ``puppet`` executable using the ``--loadclasses``</span></span><br><span class="line"><span class="string">    # option.</span></span><br><span class="line"><span class="string">    # The default value is '</span>$confdir/classes.txt<span class="string">'.</span></span><br><span class="line"><span class="string">    classfile = $vardir/classes.txt</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    # Where puppetd caches the local configuration.  An</span></span><br><span class="line"><span class="string">    # extension indicating the cache format is added automatically.</span></span><br><span class="line"><span class="string">    # The default value is '</span>$confdir/localconfig<span class="string">'.</span></span><br><span class="line"><span class="string">    localconfig = $vardir/localconfig</span></span><br></pre></td></tr></table></figure>
<p>配置 /etc/sysconfig/puppetmaster</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># vi /etc/sysconfig/puppetmaster</span></span><br><span class="line"><span class="comment"># Location of the main manifest</span></span><br><span class="line"><span class="comment">#PUPPETMASTER_MANIFEST=/etc/puppet/manifests/site.pp</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Where to log general messages to.</span></span><br><span class="line"><span class="comment"># Specify syslog to send log messages to the system log.</span></span><br><span class="line"><span class="comment">#PUPPETMASTER_LOG=syslog</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># You may specify an alternate port on which your puppetmaster should listen. Default is: 8140</span></span><br><span class="line"><span class="comment"># An example with puppetmaster on a different port, run with standard webrick servertype</span></span><br><span class="line"><span class="comment">#PUPPETMASTER_PORTS="8141"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># You may specify other parameters to the puppetmaster here</span></span><br><span class="line"><span class="comment">#PUPPETMASTER_EXTRA_OPTS=--no-ca</span></span><br><span class="line">PUPPETMASTER_EXTRA_OPTS=<span class="string">"--reports store"</span></span><br></pre></td></tr></table></figure>
<p>配置文件服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># vi /etc/puppet/fileserver.conf</span></span><br><span class="line"> [files]</span><br><span class="line">    path /etc/puppet/files</span><br><span class="line">    allow *</span><br><span class="line"></span><br><span class="line">[modules]</span><br><span class="line">    allow *</span><br><span class="line"></span><br><span class="line">[plugins]</span><br><span class="line">    allow *</span><br></pre></td></tr></table></figure>
<p>创建文件发布目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/puppet/files</span><br></pre></td></tr></table></figure>
<h2 id="8、在Puppet-Server上配置puppet-manifests和module"><a href="#8、在Puppet-Server上配置puppet-manifests和module" class="headerlink" title="8、在Puppet Server上配置puppet manifests和module"></a>8、在Puppet Server上配置puppet manifests和module</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet puppet]<span class="comment"># cd manifests/</span></span><br></pre></td></tr></table></figure>
<p>创建site.pp，此为puppet入口配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]<span class="comment"># vi site.pp</span></span><br><span class="line">import <span class="string">"roles.pp"</span></span><br><span class="line">import <span class="string">"nodes.pp"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># General settings for standard types</span></span><br><span class="line">Exec &#123; path =&gt; <span class="string">"/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin"</span> &#125;</span><br><span class="line"></span><br><span class="line">filebucket &#123; main: server =&gt; <span class="string">"puppet.example.com"</span>, path =&gt; <span class="literal">false</span> &#125;</span><br><span class="line">File &#123; backup =&gt; main &#125;</span><br></pre></td></tr></table></figure>
<p>创建roles.pp，用于定义服务器角色：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]<span class="comment"># vi roles.pp</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">baseclass</span> &#123;</span></span><br><span class="line">        <span class="keyword">include</span> test</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建nodes.pp，用于配置服务器节点：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]<span class="comment"># vi nodes.pp</span></span><br><span class="line">node <span class="string">'basenode'</span> &#123;</span><br><span class="line">        <span class="keyword">include</span> baseclass</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">node <span class="string">'zabbix.example.com'</span> inherits basenode &#123;</span><br><span class="line">        tag(<span class="string">"test"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建一个test模块：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]<span class="comment"># cd ..</span></span><br><span class="line">[root@puppet puppet]<span class="comment"># mkdir modules</span></span><br><span class="line">[root@puppet modules]<span class="comment"># mkdir -p test/manifests/</span></span><br><span class="line">[root@puppet modules]<span class="comment"># mkdir test/files/</span></span><br><span class="line">[root@puppet modules]<span class="comment"># cd test/files/</span></span><br><span class="line">[root@puppet files]<span class="comment"># vi test.txt</span></span><br><span class="line"><span class="built_in">test</span> line！</span><br></pre></td></tr></table></figure>
<p>创建test类，用来下发一个文件到客户端：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet files]<span class="comment"># cd ../manifests/</span></span><br><span class="line">[root@puppet manifests]<span class="comment"># vi init.pp</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span> &#123;</span></span><br><span class="line">        file &#123; <span class="string">"/tmp/test.txt"</span><span class="symbol">:</span></span><br><span class="line">                <span class="keyword">ensure</span>  =&gt; present,</span><br><span class="line">                group   =&gt; <span class="string">"root"</span>,</span><br><span class="line">                owner   =&gt; <span class="string">"root"</span>,</span><br><span class="line">                mode    =&gt; <span class="string">"0644"</span>,</span><br><span class="line">                source  =&gt; <span class="string">"puppet:///test/test.txt"</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="9、启动puppet-server"><a href="#9、启动puppet-server" class="headerlink" title="9、启动puppet server"></a>9、启动puppet server</h2><p>开机启动httpd服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># chkconfig --level 2345 httpd on</span></span><br></pre></td></tr></table></figure>
<p>启动apache服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># /etc/init.d/httpd start</span></span><br><span class="line">[root@puppet ~]<span class="comment"># netstat -tunlp</span></span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name</span><br><span class="line">tcp        0      0 127.0.0.1:37964             0.0.0.0:*                   LISTEN      7358/Passenger Rack</span><br><span class="line">tcp        0      0 :::8140                     :::*                        LISTEN      7297/httpd</span><br></pre></td></tr></table></figure>
<h2 id="10、配置puppet-client"><a href="#10、配置puppet-client" class="headerlink" title="10、配置puppet client"></a>10、配置puppet client</h2><p>安装puppet</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]<span class="comment"># yum install -y puppet</span></span><br></pre></td></tr></table></figure>
<p>配置/etc/puppet/puppet.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]<span class="comment"># vi /etc/puppet/puppet.conf</span></span><br><span class="line">[main]</span><br><span class="line">    <span class="comment"># The Puppet log directory.</span></span><br><span class="line">    <span class="comment"># The default value is '$vardir/log'.</span></span><br><span class="line">    logdir = /var/<span class="built_in">log</span>/puppet</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Where Puppet PID files are kept.</span></span><br><span class="line">    <span class="comment"># The default value is '$vardir/run'.</span></span><br><span class="line">    rundir = /var/run/puppet</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Where SSL certificates are kept.</span></span><br><span class="line">    <span class="comment"># The default value is '$confdir/ssl'.</span></span><br><span class="line">    ssldir = <span class="variable">$vardir</span>/ssl</span><br><span class="line"></span><br><span class="line">[agent]</span><br><span class="line">    <span class="comment"># The file in which puppetd stores a list of the classes</span></span><br><span class="line">    <span class="comment"># associated with the retrieved configuratiion.  Can be loaded in</span></span><br><span class="line">    <span class="comment"># the separate ``puppet`` executable using the ``--loadclasses``</span></span><br><span class="line">    <span class="comment"># option.</span></span><br><span class="line">    <span class="comment"># The default value is '$confdir/classes.txt'.</span></span><br><span class="line">    classfile = <span class="variable">$vardir</span>/classes.txt</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Where puppetd caches the local configuration.  An</span></span><br><span class="line">    <span class="comment"># extension indicating the cache format is added automatically.</span></span><br><span class="line">    <span class="comment"># The default value is '$confdir/localconfig'.</span></span><br><span class="line">    localconfig = <span class="variable">$vardir</span>/localconfig</span><br><span class="line"></span><br><span class="line">    report = <span class="literal">true</span>  <span class="comment"># 设置发送报告</span></span><br><span class="line"></span><br><span class="line">    listen = <span class="literal">true</span>  <span class="comment"># 设置为守护进程</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置puppet server地址</span></span><br><span class="line">    server = puppet.example.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 禁用插件同步，puppet 3.0默认开启，如果没有配置插件会报错</span></span><br><span class="line">    pluginsync=<span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>配置/etc/sysconfig/puppet</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]<span class="comment"># vi /etc/sysconfig/puppet</span></span><br><span class="line"><span class="comment"># The puppetmaster server</span></span><br><span class="line">PUPPET_SERVER=puppet.example.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># If you wish to specify the port to connect to do so here</span></span><br><span class="line"><span class="comment">#PUPPET_PORT=8140</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Where to log to. Specify syslog to send log messages to the system log.</span></span><br><span class="line"><span class="comment">#PUPPET_LOG=/var/log/puppet/puppet.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># You may specify other parameters to the puppet client here</span></span><br><span class="line"><span class="comment">#PUPPET_EXTRA_OPTS=--waitforcert=500</span></span><br><span class="line"></span><br><span class="line">[root@zabbix ~]<span class="comment"># vi namespaceauth.conf</span></span><br><span class="line">[puppetrunner]    allow puppet.example.com</span><br><span class="line">[root@zabbix ~]<span class="comment">#  vi auth.conf</span></span><br><span class="line"><span class="comment"># 在最后一行添加allow *</span></span><br><span class="line">......</span><br><span class="line">path /</span><br><span class="line">auth any</span><br><span class="line"></span><br><span class="line">allow *</span><br></pre></td></tr></table></figure>
<p>设置puppet开机自动启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]<span class="comment"># chkconfig puppet on</span></span><br></pre></td></tr></table></figure>
<p>测试客户端</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]<span class="comment"># puppet agent --test --debug</span></span><br></pre></td></tr></table></figure>
<p>如果Puppet Server没有设置：autosign = true，需要在Puppet Server上执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># puppet cert list</span></span><br><span class="line">zabbix.example.com</span><br><span class="line">[root@puppet ~]<span class="comment"># puppet cert sign zabbix.example.com</span></span><br></pre></td></tr></table></figure>
<p>这样为zabbix.example.com签名。然后回到客户端再次执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]<span class="comment"># puppet agent --test --debug</span></span><br></pre></td></tr></table></figure>
<p>文件已同步</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]<span class="comment"># cat /tmp/test.txt</span></span><br><span class="line"><span class="built_in">test</span> line.</span><br></pre></td></tr></table></figure>
<p>启动puppet客户端服务，自动抓取配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]<span class="comment"># service puppet start</span></span><br><span class="line">[root@zabbix ~]<span class="comment"># netstat -tunlp</span></span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name</span><br><span class="line">tcp        0      0 0.0.0.0:8139                0.0.0.0:*                   LISTEN      3413/ruby</span><br></pre></td></tr></table></figure>
<p>也可以在Puppet Server上进行推送：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># puppet kick -d --host zabbix.example.com</span></span><br><span class="line">Triggering zabbix.example.com</span><br><span class="line">Getting status</span><br><span class="line">status is success</span><br><span class="line">zabbix.example.com finished with <span class="built_in">exit</span> code 0</span><br><span class="line">Finished</span><br></pre></td></tr></table></figure>
<p>返回0说明触发客户端上的puppetd成功。</p>
<h2 id="11、在Puppet-Server上安装puppetdb"><a href="#11、在Puppet-Server上安装puppetdb" class="headerlink" title="11、在Puppet Server上安装puppetdb"></a>11、在Puppet Server上安装puppetdb</h2><p>安装puppetdb</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># puppet resource package puppetdb ensure=latest</span></span><br><span class="line">Notice: /Package[puppetdb]/ensure: created</span><br><span class="line">package &#123; <span class="string">'puppetdb'</span>:</span><br><span class="line">  ensure =&gt; <span class="string">'1.4.0-1.el6'</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动puppetdb并设置开机自启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># puppet resource service puppetdb ensure=running enable=true</span></span><br><span class="line">Notice: /Service[puppetdb]/ensure: ensure changed <span class="string">'stopped'</span> to <span class="string">'running'</span></span><br><span class="line">service &#123; <span class="string">'puppetdb'</span>:</span><br><span class="line">  ensure =&gt; <span class="string">'running'</span>,</span><br><span class="line">  <span class="built_in">enable</span> =&gt; <span class="string">'true'</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看启动日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># cat /var/log/puppetdb/puppetdb.log</span></span><br><span class="line">2013-08-25 09:46:29,823 INFO  [main] [cli.services] Starting 1 <span class="built_in">command</span> processor threads</span><br><span class="line">2013-08-25 09:46:29,845 INFO  [main] [cli.services] Starting query server</span><br><span class="line">2013-08-25 09:46:29,870 INFO  [pool-2-thread-1] [cli.services] Starting database garbage collection</span><br><span class="line">2013-08-25 09:46:29,904 INFO  [clojure-agent-send-off-pool-2] [server.Server] jetty-7.x.y-SNAPSHOT</span><br><span class="line">2013-08-25 09:46:29,906 INFO  [pool-2-thread-1] [cli.services] Finished database garbage collection</span><br><span class="line">2013-08-25 09:46:29,921 INFO  [pool-2-thread-1] [cli.services] Starting sweep of stale reports (threshold: 14 days)</span><br><span class="line">2013-08-25 09:46:29,933 INFO  [pool-2-thread-1] [cli.services] Finished sweep of stale reports (threshold: 14 days)</span><br><span class="line">2013-08-25 09:46:30,059 INFO  [clojure-agent-send-off-pool-2] [server.AbstractConnector] Started SelectChannelConnector@localhost:8080</span><br><span class="line">2013-08-25 09:46:30,515 INFO  [clojure-agent-send-off-pool-2] [ssl.SslContextFactory] Enabled Protocols [SSLv2Hello, SSLv3, TLSv1] of [SSLv2Hello, SSLv3, TLSv1]</span><br><span class="line">2013-08-25 09:46:30,530 INFO  [clojure-agent-send-off-pool-2] [server.AbstractConnector] Started SslSelectChannelConnector@puppet.example.com:8081</span><br></pre></td></tr></table></figure>
<p>查看启动端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># netstat -tunlp</span></span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name</span><br><span class="line"></span><br><span class="line">tcp        0      0 ::ffff:127.0.0.1:8080       :::*                        LISTEN      6757/java</span><br><span class="line">tcp        0      0 ::ffff:10.10.10.10:8081     :::*                        LISTEN      6757/java</span><br></pre></td></tr></table></figure>
<p>配置puppet server连接到puppetdb<br>安装puppetdb-terminus插件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># puppet resource package puppetdb-terminus ensure=latest</span></span><br><span class="line">Notice: /Package[puppetdb-terminus]/ensure: created</span><br><span class="line">package &#123; <span class="string">'puppetdb-terminus'</span>:</span><br><span class="line">[main]</span><br><span class="line">  ensure =&gt; <span class="string">'1.4.0-1.el6'</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在/etc/puppet下新建puppetdb.conf，并输入puppetdb server和port</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># cd /etc/puppet</span></span><br><span class="line">[root@puppet puppet]<span class="comment"># vi puppetdb.conf</span></span><br><span class="line">[main]</span><br><span class="line">server = puppet.example.com</span><br><span class="line">port = 8081</span><br></pre></td></tr></table></figure>
<p>配置puppet server连接到puppetdb</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet puppet]<span class="comment"># vi puppet.conf</span></span><br><span class="line">[master]</span><br><span class="line">    ……</span><br><span class="line">    storeconfigs = <span class="literal">true</span></span><br><span class="line">    storeconfigs_backend = puppetdb</span><br></pre></td></tr></table></figure>
<p>在/etc/puppet下新建routes.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet puppet]<span class="comment"># vi routes.yaml</span></span><br><span class="line">---</span><br><span class="line">master:</span><br><span class="line">  facts:</span><br><span class="line">    terminus: puppetdb</span><br><span class="line">    cache: yaml</span><br></pre></td></tr></table></figure>
<p>重启puppet server</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet puppet]<span class="comment"># /etc/init.d/httpd restart</span></span><br><span class="line">停止 httpd：                                               [确定]</span><br><span class="line">正在启动 httpd：                                           [确定]</span><br></pre></td></tr></table></figure>
<p>在puppet客户端（[zabbix.example.com）执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]<span class="comment"># puppet agent --test --debug</span></span><br></pre></td></tr></table></figure>
<p>查看日志，发现zabbix.example.com已推送facts和catalog到puppetdb</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet puppet]<span class="comment"># tail -f /var/log/puppetdb/puppetdb.log</span></span><br><span class="line"></span><br><span class="line">2013-08-25 10:12:52,606 INFO  [<span class="built_in">command</span>-proc-46] [puppetdb.command] [af698348-275d-45ac-9ea9-017c4b1e6947] [replace facts] zabbix.example.com</span><br><span class="line">2013-08-25 10:12:53,824 INFO  [<span class="built_in">command</span>-proc-46] [puppetdb.command] [8d7029f9-e147-4b9f-8076-4b26e21d7a9f] [replace catalog] zabbix.example.com</span><br></pre></td></tr></table></figure>
<p>参考文档：<a href="http://docs.puppetlabs.com/puppetdb/1.4/install_from_packages.html" target="_blank" rel="noopener">http://docs.puppetlabs.com/puppetdb/1.4/install_from_packages.html</a></p>
<h2 id="12、在Puppet-Server上安装puppet-dashboard"><a href="#12、在Puppet-Server上安装puppet-dashboard" class="headerlink" title="12、在Puppet Server上安装puppet-dashboard"></a>12、在Puppet Server上安装puppet-dashboard</h2><p>安装MySQL</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># yum install -y mysql mysql-devel mysql-server</span></span><br></pre></td></tr></table></figure>
<p>配置MySQL</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># vi /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="built_in">bind</span>=10.10.10.10</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">user=mysql</span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links=0</span><br><span class="line"><span class="comment"># Allowing 32MB allows an occasional 17MB row with plenty of spare room</span></span><br><span class="line">max_allowed_packet = 32M</span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line"><span class="built_in">log</span>-error=/var/<span class="built_in">log</span>/mysqld.log</span><br><span class="line">pid-file=/var/run/mysqld/mysqld.pid</span><br></pre></td></tr></table></figure>
<p>启动MySQL</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># /etc/init.d/mysqld start</span></span><br><span class="line"></span><br><span class="line">正在启动 mysqld：                                          [确定]</span><br><span class="line">[root@puppet ~]<span class="comment"># netstat -tunlp</span></span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name</span><br><span class="line">tcp        0      0 10.10.10.10:3306            0.0.0.0:*                   LISTEN      11677/mysqld</span><br></pre></td></tr></table></figure>
<p>开机自动启动MySQL</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># chkconfig --level 2345 mysqld on</span></span><br></pre></td></tr></table></figure>
<p>创建一个dashboard数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># mysql -uroot</span></span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2</span><br><span class="line">Server version: 5.1.69 Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">'help;'</span> or <span class="string">'\h'</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">'\c'</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; CREATE DATABASE dashboard CHARACTER SET utf8;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; CREATE USER <span class="string">'dashboard'</span>@<span class="string">'10.10.10.10'</span> IDENTIFIED BY <span class="string">'dashboard@puppet$'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON dashboard.* TO <span class="string">'dashboard'</span>@<span class="string">'10.10.10.10'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; quit</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>
<p>安装puppet-dashboard</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># yum install -y puppet-dashboard</span></span><br></pre></td></tr></table></figure>
<p>配置Dashboard</p>
<p>编辑 /usr/share/puppet-dashboard/config/database.yml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># vi /usr/share/puppet-dashboard/config/database.yml</span></span><br><span class="line">production:</span><br><span class="line">  database: dashboard</span><br><span class="line">  username: dashboard</span><br><span class="line">  password: dashboard@puppet$</span><br><span class="line">  encoding: utf8</span><br><span class="line">  adapter: mysql</span><br><span class="line">  host: 10.10.10.10</span><br></pre></td></tr></table></figure>
<p>修改时区 /usr/share/puppet-dashboard/config/environment.rb</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># vi /usr/share/puppet-dashboard/config/environment.rb</span></span><br><span class="line"><span class="comment"># config.time_zone = 'UTC'</span></span><br><span class="line">config.time_zone = <span class="string">'Beijing'</span></span><br></pre></td></tr></table></figure>
<p>初始化数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># cd /usr/share/puppet-dashboard/</span></span><br><span class="line">[root@puppet puppet-dashboard]<span class="comment"># rake RAILS_ENV=production db:migrate</span></span><br></pre></td></tr></table></figure>
<p>配置apache</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet puppet-dashboard]<span class="comment"># vi /etc/httpd/conf.d/dashboard.conf</span></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">   ServerName puppet.example.com</span><br><span class="line">   DocumentRoot <span class="string">"/usr/share/puppet-dashboard/public/"</span></span><br><span class="line">   &lt;Directory <span class="string">"/usr/share/puppet-dashboard/public/"</span>&gt;</span><br><span class="line">      Options None</span><br><span class="line">      AllowOverride AuthConfig</span><br><span class="line">      Order allow,deny</span><br><span class="line">      allow from all</span><br><span class="line">   &lt;/Directory&gt;</span><br><span class="line">   ErrorLog /var/<span class="built_in">log</span>/httpd/puppet.example.com_error.log</span><br><span class="line">   LogLevel warn</span><br><span class="line">   CustomLog /var/<span class="built_in">log</span>/httpd/puppet.example.com_access.log combined</span><br><span class="line">   ServerSignature On</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>
<p>配置Puppet报告到Dashboard</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet puppet-dashboard]<span class="comment"># cd</span></span><br><span class="line">[root@puppet ~]<span class="comment"># vi /etc/puppet/puppet.conf</span></span><br><span class="line">[master]</span><br><span class="line">    ssl_client_header = SSL_CLIENT_S_DN</span><br><span class="line">    ssl_client_verify_header = SSL_CLIENT_VERIFY</span><br><span class="line">    autosign = <span class="literal">true</span></span><br><span class="line">    reports = store, http</span><br><span class="line">    reporturl = http://puppet.example.com/reports/upload</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure>
<p>配置/etc/sysconfig/puppetmaster</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># vi /etc/sysconfig/puppetmaster</span></span><br><span class="line">PUPPETMASTER_EXTRA_OPTS=<span class="string">"--reports store, puppet_dashboard"</span></span><br></pre></td></tr></table></figure>
<p>重启apache使配置生效</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># /etc/init.d/httpd restart</span></span><br><span class="line">停止 httpd：                                               [确定]</span><br><span class="line">正在启动 httpd：                                           [确定]</span><br></pre></td></tr></table></figure>
<p>导入已有报告</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># cd /usr/share/puppet-dashboard</span></span><br><span class="line">[root@puppet puppet-dashboard]<span class="comment">#</span></span><br><span class="line">[root@puppet puppet-dashboard]<span class="comment"># rake RAILS_ENV=production reports:import</span></span><br><span class="line">Importing 29 reports from /var/lib/puppet/reports <span class="keyword">in</span> the background</span><br><span class="line">Importing:     100% |<span class="comment">#############################################################################################################################################| Time: 00:00:00</span></span><br><span class="line">29 of 29 reports queued</span><br></pre></td></tr></table></figure>
<p>启动dashboard报告分析进程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># chown -R puppet-dashboard /usr/share/puppet-dashboard/tmp/pids/</span></span><br><span class="line">[root@puppet ~]<span class="comment"># /etc/init.d/puppet-dashboard-workers start</span></span><br><span class="line">正在启动 puppet-dashboard-workers：                        [确定]</span><br><span class="line">[root@puppet ~]<span class="comment"># chkconfig --level 2345 puppet-dashboard-workers on</span></span><br></pre></td></tr></table></figure>
<p>以上启动脚本有问题，如下启动：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env RAILS_ENV=production /usr/share/puppet-dashboard/script/delayed_job -p dashboard -n 4 -m start</span><br></pre></td></tr></table></figure>
<p>配置Inventory服务（使用puppetdb）</p>
<p>配置/usr/share/puppet-dashboard/config/settings.yml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># vi /usr/share/puppet-dashboard/config/settings.yml</span></span><br><span class="line"><span class="comment"># Node name to use when contacting the puppet master.  This is the</span></span><br><span class="line"><span class="comment"># CN that is used in Dashboard's certificate.</span></span><br><span class="line">cn_name: <span class="string">'puppet.example.com'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ca_crl_path: <span class="string">'certs/puppet.example.com.ca_crl.pem'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ca_certificate_path: <span class="string">'certs/puppet.example.com.ca_cert.pem'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">certificate_path: <span class="string">'certs/puppet.example.com.cert.pem'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">private_key_path: <span class="string">'certs/puppet.example.com.private_key.pem'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public_key_path: <span class="string">'certs/puppet.example.com.public_key.pem'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Hostname of the certificate authority.</span></span><br><span class="line">ca_server: <span class="string">'puppet.example.com'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Port for the certificate authority.</span></span><br><span class="line">ca_port: 8140</span><br><span class="line"></span><br><span class="line"><span class="comment"># Key length for SSL certificates</span></span><br><span class="line">key_length: 1024</span><br><span class="line"></span><br><span class="line"><span class="comment"># The "inventory service" allows you to connect to a puppet master to retrieve and node facts</span></span><br><span class="line">enable_inventory_service: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Hostname of the inventory server.</span></span><br><span class="line">inventory_server: <span class="string">'puppet.example.com'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Port for the inventory server.</span></span><br><span class="line">inventory_port: 8140</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set this to true to allow Dashboard to display diffs on files that</span></span><br><span class="line"><span class="comment"># are archived in the file bucket.</span></span><br><span class="line">use_file_bucket_diffs: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Hostname of the file bucket server.</span></span><br><span class="line">file_bucket_server: <span class="string">'puppet.example.com'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Port for the file bucket server.</span></span><br><span class="line">file_bucket_port: 8140</span><br></pre></td></tr></table></figure>
<p>配置puppet授权访问文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># vi /etc/puppet/auth.conf</span></span><br><span class="line">……</span><br><span class="line"></span><br><span class="line">path /facts</span><br><span class="line">auth any</span><br><span class="line">allow *</span><br><span class="line"></span><br><span class="line">path /facts_search</span><br><span class="line">allow *</span><br><span class="line"></span><br><span class="line"><span class="comment"># deny everything else; this ACL is not strictly necessary, but</span></span><br><span class="line"><span class="comment"># illustrates the default policy.</span></span><br><span class="line">path /</span><br><span class="line">auth any</span><br></pre></td></tr></table></figure>
<p>重启puppet server</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># /etc/init.d/httpd restart</span></span><br><span class="line">停止 httpd：                                               [确定]</span><br><span class="line">正在启动 httpd：                                           [确定]</span><br></pre></td></tr></table></figure>
<p>访问puppet dashboard</p>
<p>参考文档：<a href="http://docs.puppetlabs.com/guides/inventory_service.htmlInventory" target="_blank" rel="noopener">http://docs.puppetlabs.com/guides/inventory_service.htmlInventory</a> </p>
<h2 id="13、编写Puppet模块"><a href="#13、编写Puppet模块" class="headerlink" title="13、编写Puppet模块"></a>13、编写Puppet模块</h2><p>可以从<a href="http://forge.puppetlabs.com/" target="_blank" rel="noopener">http://forge.puppetlabs.com/</a> 和<a href="https://github.com查找共享的Puppet模块。" target="_blank" rel="noopener">https://github.com查找共享的Puppet模块。</a></p>
<p>以ntp模块为例，从github下载代码放到/etc/puppet/modules/</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># cd /etc/puppet/modules/</span></span><br><span class="line">[root@puppet modules]<span class="comment"># git clone https://github.com/puppetlabs/puppetlabs-ntp.git</span></span><br><span class="line">[root@puppet modules]<span class="comment"># mv puppetlabs_ntp ntp</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载ntp依赖的stdlib模块</span></span><br><span class="line">[root@puppet modules]<span class="comment"># git clone https://github.com/puppetlabs/puppetlabs-stdlib.git</span></span><br><span class="line">[root@puppet modules]<span class="comment"># mv puppetlabs_stdlib stdlib</span></span><br></pre></td></tr></table></figure>
<p>参考文档：<a href="http://docs.puppetlabs.com/puppet/3/reference/modules_fundamentals.html" target="_blank" rel="noopener">http://docs.puppetlabs.com/puppet/3/reference/modules_fundamentals.html</a></p>
<p>参考文档：stdlib</p>
<p><a href="http://puppetlabs.com/blog/module-of-the-week-puppetlabsstdlib-puppet-labs-standard-library" target="_blank" rel="noopener">http://puppetlabs.com/blog/module-of-the-week-puppetlabsstdlib-puppet-labs-standard-library</a></p>
<p><a href="http://puppetlabs.com/blog/module-of-the-week-puppetlabs-stdlib-puppet-labs-standard-library-part-2" target="_blank" rel="noopener">http://puppetlabs.com/blog/module-of-the-week-puppetlabs-stdlib-puppet-labs-standard-library-part-2</a></p>
<p><a href="http://puppetlabs.com/blog/module-of-the-week-puppetlabsstdlib-puppetlabs-standard-library-part-3" target="_blank" rel="noopener">http://puppetlabs.com/blog/module-of-the-week-puppetlabsstdlib-puppetlabs-standard-library-part-3</a></p>
<p><a href="http://puppetlabs.com/blog/module-of-the-week-puppetlabs-stdlib-puppet-labs-standard-library-part-4" target="_blank" rel="noopener">http://puppetlabs.com/blog/module-of-the-week-puppetlabs-stdlib-puppet-labs-standard-library-part-4</a></p>
<h2 id="14、使用hiera"><a href="#14、使用hiera" class="headerlink" title="14、使用hiera"></a>14、使用hiera</h2><p>将数据放到hiera中可以更好的复用puppet代码。</p>
<p>安装hiera</p>
<p>hiera已经内置在puppet 3.x中，如果puppet版本是2.7.x需要单独安装hiera、hiera-puppet</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">puppet resource package hiera ensure=installed</span><br><span class="line">puppet resource package hiera-puppet ensure=installed</span><br></pre></td></tr></table></figure>
<p>参考文档：hiera安装<a href="http://docs.puppetlabs.com/hiera/1/installing.html" target="_blank" rel="noopener">http://docs.puppetlabs.com/hiera/1/installing.html</a></p>
<p>配置hiera</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># cat /etc/puppet/hiera.yaml</span></span><br><span class="line">---</span><br><span class="line">:backends:</span><br><span class="line">  - yaml</span><br><span class="line">:yaml:</span><br><span class="line">  :datadir: /etc/puppet/hieradata</span><br><span class="line">:hierarchy:</span><br><span class="line">  - node/%&#123;::fqdn&#125;</span><br><span class="line">  - idc/%&#123;::idc&#125;</span><br><span class="line">  - environment/%&#123;::environment&#125;</span><br><span class="line">  - osfamily/%&#123;osfamily&#125;</span><br><span class="line">  - common</span><br><span class="line">:merge_behavior:</span><br><span class="line">  - deeper</span><br></pre></td></tr></table></figure>
<p>如果merge_behavior使用depper需要安装deep_merge，切hiera版本大于等于1.2.0</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># gem install deep_merge</span></span><br><span class="line">Successfully installed deep_merge-1.0.0</span><br><span class="line">1 gem installed</span><br><span class="line">Installing ri documentation <span class="keyword">for</span> deep_merge-1.0.0...</span><br><span class="line">Installing RDoc documentation <span class="keyword">for</span> deep_merge-1.0.0...</span><br></pre></td></tr></table></figure>
<p>创建相应的目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># ls /etc/puppet/hieradata/</span></span><br><span class="line">environment  idc  node  osfamily</span><br></pre></td></tr></table></figure>
<p>为配置文件创建连接，hiera命令行使用/etc/hiera.yaml配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@puppet ~]<span class="comment"># ln -s /etc/puppet/hiera.yaml /etc/hiera.yaml</span></span><br></pre></td></tr></table></figure>
<p>参考文档：</p>
<p>Hiera配置：<a href="http://docs.puppetlabs.com/hiera/1/configuring.html" target="_blank" rel="noopener">http://docs.puppetlabs.com/hiera/1/configuring.html</a></p>
<p>创建Hierarchies： <a href="http://docs.puppetlabs.com/hiera/1/hierarchy.html" target="_blank" rel="noopener">http://docs.puppetlabs.com/hiera/1/hierarchy.html</a></p>
<p>yaml coolbook： <a href="http://www.yaml.org/YAML_for_ruby.html" target="_blank" rel="noopener">http://www.yaml.org/YAML_for_ruby.html</a></p>
<p>编写数据源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet puppet]<span class="comment"># cat hieradata/node/puppet.example.com.yaml</span></span><br><span class="line">\---</span><br><span class="line">ntp::package_ensure: present</span><br><span class="line">ntp::service_enable: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">ntp::servers:</span><br><span class="line">  - 0.asia.pool.ntp.org</span><br><span class="line">  - 1.asia.pool.ntp.org</span><br><span class="line">[root@puppet puppet]<span class="comment"># cat hieradata/node/zabbix.example.com.yaml</span></span><br><span class="line">\---</span><br><span class="line">ntp::package_ensure: latest</span><br><span class="line">ntp::service_enable: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">ntp::servers:</span><br><span class="line">  - puppet.example.com</span><br><span class="line">  - 0.asia.pool.ntp.org</span><br><span class="line">  - 1.asia.pool.ntp.org</span><br><span class="line">[root@puppet puppet]<span class="comment"># cat hieradata/idc/m5.yaml</span></span><br><span class="line">\---</span><br><span class="line">ntp::package_ensure: latest</span><br><span class="line">ntp::service_enable: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">ntp::servers:</span><br><span class="line">  - puppet.example.com</span><br><span class="line">  - zabbix.example.com</span><br><span class="line">[root@puppet puppet]<span class="comment"># cat hieradata/common.yaml</span></span><br><span class="line">\---</span><br><span class="line">ntp::package_ensure: latest</span><br><span class="line">ntp::service_enable: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">ntp::servers:</span><br><span class="line">  - 4.asia.pool.ntp.org</span><br><span class="line">  - 5.asia.pool.ntp.org</span><br></pre></td></tr></table></figure>
<p>测试数据源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet puppet]<span class="comment"># hiera ntp::servers ::fqdn=puppet.example.com</span></span><br><span class="line">[<span class="string">"0.asia.pool.ntp.org"</span>, <span class="string">"1.asia.pool.ntp.org"</span>]</span><br><span class="line">[root@puppet puppet]<span class="comment"># vi hieradata/node/puppet.example.com.yaml</span></span><br><span class="line">[root@puppet puppet]<span class="comment"># hiera ntp::package_ensure ::fqdn=puppet.example.com</span></span><br><span class="line">present</span><br><span class="line">[root@puppet puppet]<span class="comment"># hiera ntp::servers ::fqdn=zabbix.example.com</span></span><br><span class="line">[<span class="string">"puppet.example.com"</span>, <span class="string">"0.asia.pool.ntp.org"</span>, <span class="string">"1.asia.pool.ntp.org"</span>]</span><br><span class="line">[root@puppet puppet]<span class="comment"># hiera ntp::package_ensure ::fqdn=zabbix.example.com</span></span><br><span class="line">latest</span><br><span class="line">[root@puppet puppet]<span class="comment"># hiera ntp::servers ::fqdn=node.example.com ::idc=m5</span></span><br><span class="line">[<span class="string">"puppet.example.com"</span>, <span class="string">"zabbix.example.com"</span>]</span><br><span class="line">[root@puppet puppet]<span class="comment"># hiera ntp::servers ::fqdn=node.example.com</span></span><br><span class="line">[<span class="string">"4.asia.pool.ntp.org"</span>, <span class="string">"5.asia.pool.ntp.org"</span>]</span><br><span class="line">[root@puppet puppet]<span class="comment"># hiera ntp::package_ensure ::fqdn=node.example.com</span></span><br><span class="line">latest</span><br></pre></td></tr></table></figure>
<p>puppet.example.com在idc m5机房，使用0.asia.pool.ntp.org和1.asia.pool.ntp.org ntp server，不自动升级<br>zabbix.example.com在idc m5机房，使用puppet.example.com 0.asia.pool.ntp.org 和1.asia.pool.ntp.org ntp server<br>node.example.com在idc m5机房，使用puppet.example.com和zabbix.example.com ntp server<br>其他机房默认使用4.asia.pool.ntp.org和5.asia.pool.ntp.org</p>
<p>参考文档：</p>
<p>编写数据源: <a href="http://docs.puppetlabs.com/hiera/1/data_sources.html" target="_blank" rel="noopener">http://docs.puppetlabs.com/hiera/1/data_sources.html</a></p>
<p>hiera应用完整实例: <a href="http://docs.puppetlabs.com/hiera/1/complete_example.html" target="_blank" rel="noopener">http://docs.puppetlabs.com/hiera/1/complete_example.html</a> </p>
<h2 id="15、-在上文中用到的-facts-idc需要自定义"><a href="#15、-在上文中用到的-facts-idc需要自定义" class="headerlink" title="15、 在上文中用到的 facts idc需要自定义"></a>15、 在上文中用到的 facts idc需要自定义</h2><p>Stone:puppet dongliang$ cat modules/tags/lib/facter/idc.rb</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Fact: idc</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Purpose: return idc</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'facter'</span></span><br><span class="line"></span><br><span class="line">idc = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">network_eth<span class="number">0</span> = Facter.value(<span class="string">'network_eth0'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> network_eth<span class="number">0</span></span><br><span class="line"><span class="keyword">when</span> /<span class="number">60</span>\.<span class="number">38</span>\.<span class="number">244</span><span class="params">|172\.16\.244/</span></span><br><span class="line"><span class="params">    idc = "tanggu"</span></span><br><span class="line"><span class="params"><span class="keyword">when</span> /121\.24\.32|</span><span class="number">10</span>\.<span class="number">71</span>\.<span class="number">32</span>/</span><br><span class="line">    idc = <span class="string">"qixinggang"</span></span><br><span class="line"><span class="keyword">when</span> /<span class="number">58</span>\.<span class="number">93</span>\.<span class="number">214</span><span class="params">|172\.16\.215/</span></span><br><span class="line"><span class="params">    idc = "m5"</span></span><br><span class="line"><span class="params"><span class="keyword">when</span> /61\.182\.207|</span><span class="number">172</span>\.<span class="number">16</span>\.<span class="number">51</span>/</span><br><span class="line">    idc = <span class="string">"qinzhou"</span></span><br><span class="line"><span class="keyword">when</span> /<span class="number">10</span>\.<span class="number">26</span>\.<span class="number">0</span><span class="params">|10\.27\.0/</span></span><br><span class="line"><span class="params">    idc = "huayuan"</span></span><br><span class="line"><span class="params"><span class="keyword">end</span></span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">Facter.add(:idc) <span class="keyword">do</span></span></span><br><span class="line"><span class="params">    setcode &#123; idc &#125;</span></span><br><span class="line"><span class="params"><span class="keyword">end</span></span></span><br></pre></td></tr></table></figure>
<p>参考文档：自定义facts<a href="http://docs.puppetlabs.com/guides/custom_facts.html" target="_blank" rel="noopener">http://docs.puppetlabs.com/guides/custom_facts.html</a> </p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Puppet/">Puppet</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/puppet/">puppet</a><a href="/tags/devops/">devops</a>
    </span>
    

    </div>

    
  </div>
</article>

  

	<section id="comment" class="comment">
		<div id="gitment"></div>
	</section>
	<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
	<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
	<script>
		var gitment = new Gitment({
			owner: 'ist0ne',
			repo: 'gitment',
			oauth: {
				client_id: 'a3a5af94aef00fdf0c24',
				client_secret: '3d47316b6b7d0b98ba405da19a65457357256f2d',
			},
		})
		gitment.render('gitment')
	</script>





    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    <br>
    
    &copy; 2019 ist0ne
    
  </p>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-39923501-1', 'auto');
    ga('send', 'pageview');

</script>

  </div>
</div>
</body>
</html>