<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>第 2 页 | 石头记 | Docker、Kubernetes、CI/CD 等技术分享</title>

  
  <meta name="author" content="ist0ne">
  

  
  <meta name="description" content="Docker、Kubernetes、Ceph、Saltstack、OpenStack 等技术分享">
  

  
  <meta name="keywords" content="blog kubernetes k8s docker container ceph salt saltstack openstack kube kubectl helm charts gitlab git">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content="石头记">

  
  <meta property="og:image" content="/favicon.ico">
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="石头记" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">石头记</a>
    </h1>
    <p class="site-description">Docker、Kubernetes、CI/CD 等技术分享</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
        <li><a href="/atom.xml">订阅</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    
  <article>

  
    
    <h3 class="article-title"><a href="/2014/09/10/openstack-use/"><span>Openstack 使用</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2014/09/10/openstack-use/" rel="bookmark">
        <time class="entry-date published" datetime="2014-09-10T03:00:00.000Z">
          2014-09-10
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>OpenStack作为基础设施即服务（简称IaaS）资源的通用前端。首要任务是简化云的部署过程并为其带来良好的可扩展性。本文希望通过提供必要的指导信息，帮助大家利用OpenStack前端来设置及管理自己的私有云。</p>
<h2 id="导入虚拟机镜像"><a href="#导入虚拟机镜像" class="headerlink" title="导入虚拟机镜像"></a>导入虚拟机镜像</h2><p>如下列出了一下虚拟机镜像，可以在本地下载后通过Openstack界面导入。</p>
<p><a href="https://openstack.redhat.com/Image_resources" target="_blank" rel="noopener">https://openstack.redhat.com/Image_resources</a></p>
<p>也可以参考如下文档自己制作镜像：</p>
<p><a href="https://www.ibm.com/developerworks/community/wikis/home?lang=en#!/wiki/OpenStack/page/Creating%20qcow2%20CentOS%20Image%20for%20OpenStack" target="_blank" rel="noopener">https://www.ibm.com/developerworks/community/wikis/home?lang=en#!/wiki/OpenStack/page/Creating%20qcow2%20CentOS%20Image%20for%20OpenStack</a></p>
<p>导入镜像：</p>
<p>点击左侧的镜像 选项卡，可以看到已经导入的镜像，点击创建镜像 按钮创建镜像。</p>
<p><img src="/images/14-09-10/openstack_images.png" alt="Openstack镜像"></p>
<p>填写 镜像名称，镜像源选择—镜像文件，格式选择 QCOW2，勾选 公有 框（这样你上传得镜像其他人也能使用），然后点击创建镜像。</p>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/虚拟化/">虚拟化</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Openstack/">Openstack</a><a href="/tags/KVM/">KVM</a><a href="/tags/Ceph/">Ceph</a><a href="/tags/CoreOS/">CoreOS</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2014/09/10/openstack-use/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2014/09/10/openstack-install/"><span>Openstack 安装</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2014/09/10/openstack-install/" rel="bookmark">
        <time class="entry-date published" datetime="2014-09-10T02:00:00.000Z">
          2014-09-10
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>OpenStack 是由 Rackspace 和 NASA 共同开发的云计算平台，帮助服务商和企业内部实现类似于 Amazon EC2 和 S3 的云基础架构服务(Infrastructure as a Service, IaaS)。OpenStack 包含两个主要模块：Nova 和 Swift，前者是 NASA 开发的虚拟服务器部署和业务计算模块；后者是Rackspace开发的分布式云存储模块，两者可以一起用，也可以分开单独用。OpenStack 是开源项目，除了有 Rackspace 和 NASA 的大力支持外，后面还有包括 Dell、Citrix、 Cisco、 Canonical 这些重量级公司的贡献和支持，发展速度非常快。</p>
<p>Openstack集群搭建使用5台机器，一台Fuel管理机，一台Controller，一台Compute，两台Storage。这是一个最小化的安装，安装完成后可以对集群进行扩容。</p>
<h2 id="1-网络环境准备"><a href="#1-网络环境准备" class="headerlink" title="1. 网络环境准备"></a>1. 网络环境准备</h2><p>网络规划：</p>
<ul>
<li>Floating/Public 网络 172.16.200.0/24 in VLAN 100 (untagged on servers) • Floating IP range 172.16.200.130 - 254  # 用于集群公网和虚拟机浮动IP，需要能与外网通信</li>
<li>Internal network (private) 192.168.100.0/24  # 用于虚拟机间通信</li>
<li>Gateway 192.168.100.1  # 虚拟机的网关地址</li>
<li>DNS 8.8.4.4, 8.8.8.8  # DNS地址</li>
<li>Management network 192.168.0.0/24 in VLAN 501 # 管理网络</li>
<li>Storage network 192.168.1.0/24 in VLAN 502  # 存储网络</li>
<li>Administrative network (for Fuel) 10.20.0.0/24 in VLAN 503  # Fuel集群管理网络
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/虚拟化/">虚拟化</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Openstack/">Openstack</a><a href="/tags/KVM/">KVM</a><a href="/tags/Ceph/">Ceph</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2014/09/10/openstack-install/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2014/06/17/saltstack-expand/"><span>Saltstack：Salt模块的扩展</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2014/06/17/saltstack-expand/" rel="bookmark">
        <time class="entry-date published" datetime="2014-06-17T02:00:00.000Z">
          2014-06-17
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>对Salt进行模块化设计就是为了扩展，另外将变量抽象出来放到pillar中也是为了模块可以重用。当你需要配置两个web平台，而这两个平台又有些许不同时你该怎么办？需要重新再写个nginx模块适配新的平台吗？</p>
<p>对于上面问题的回答是否定的，我们无需再重新写一个nginx模块，我们只需要对新的平台传递新的配置文件或者使用同一个模板传递不同的参数。</p>
<h4 id="使用不同的配置文件"><a href="#使用不同的配置文件" class="headerlink" title="使用不同的配置文件"></a>使用不同的配置文件</h4><p>当两个平台配置相差比较大时可能传递一个不同的配置文件会更合适，如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">/etc/rsyncd.conf:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://rsync/files/etc/&#123;&#123;salt['pillar.get']('rsync_template',</span> <span class="string">'rsyncd.conf'</span><span class="string">)&#125;&#125;</span></span><br><span class="line"><span class="attr">    - template:</span> <span class="string">jinja</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br></pre></td></tr></table></figure>

<p>为不同的节点在pillar中配置不同的rsync_template变量即可。</p>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Saltstack/">Saltstack</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/devops/">devops</a><a href="/tags/saltstack/">saltstack</a><a href="/tags/salt/">salt</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2014/06/17/saltstack-expand/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2014/06/16/saltstack-zabbix-monitor/"><span>Saltstack：自动化监控</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2014/06/16/saltstack-zabbix-monitor/" rel="bookmark">
        <time class="entry-date published" datetime="2014-06-16T02:00:00.000Z">
          2014-06-16
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>本节参考了<a href="http://pengyao.org/" target="_blank" rel="noopener">绿肥</a>的《记saltstack和zabbix的一次联姻》，对zabbix添加监控脚本（add_monitors.py）进行部分修改而成，此脚本基于@超大杯摩卡星冰乐 同学的zapi进行更高级别的封装而成，在此表示感谢。</p>
<p>自动化监控的过程如下：</p>
<ol>
<li>通过Saltstack部署Zabbix server、Zabbix web、Zabbix api；</li>
<li>完成安装后需要手动导入Zabbix监控模板；</li>
<li>通过Saltstack部署服务及Zabbix agent；</li>
<li>Saltstack在安装完服务后通过Salt Mine将服务角色汇报给Salt Master；</li>
<li>Zabbix api拿到各服务角色后添加相应监控到Zabbix server。</li>
</ol>
<p><a href="http://docs.saltstack.com/en/latest/ref/modules/all/salt.modules.mine.html" target="_blank" rel="noopener">Salt Mine</a>用于将Salt Minion的信息存储到Salt Master，供其他Salt Minion使用。</p>
<p>下面以对nginx模块的监控为例讲述整个监控过程，其中Zabbix服务（Zabbix server、Zabbix web、Zabbix api）安装使用/srv/salt/zabbix进行管理，服务部署在admin.grid.mall.com上。Zabbix agent使用/srv/salt/zabbix进行管理。nginx使用/srv/salt/nginx模块进行管理。</p>
<p>安装完nginx和php后定义相应的角色：</p>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Saltstack/">Saltstack</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/devops/">devops</a><a href="/tags/saltstack/">saltstack</a><a href="/tags/salt/">salt</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2014/06/16/saltstack-zabbix-monitor/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2014/06/15/saltstack-publish/"><span>Saltstack：代码部署系统搭建</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2014/06/15/saltstack-publish/" rel="bookmark">
        <time class="entry-date published" datetime="2014-06-15T02:00:00.000Z">
          2014-06-15
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>部署系统基于Salt Runner编写，Salt Runner使用salt-run命令执行的命令行工具，可以通过调用Salt API很轻松构建。Salt Runner与Salt的执行模块很像，但是在Salt Master上运行而非Salt Minion上。</p>
<h4 id="配置Salt-Master"><a href="#配置Salt-Master" class="headerlink" title="配置Salt Master"></a>配置Salt Master</h4><p>配置文件（/etc/salt/master.d/publish.conf）如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">svn:</span></span><br><span class="line"><span class="attr">  username:</span> <span class="string">'publish'</span>  <span class="comment"># 定义svn用户名，用于检出代码</span></span><br><span class="line"><span class="attr">  password:</span> <span class="string">'#1qaz@WSX#ht'</span>  <span class="comment"># svn密码</span></span><br><span class="line"><span class="attr">publish:</span></span><br><span class="line"><span class="attr">    master:</span> <span class="string">'admin.grid.mall.com'</span>  <span class="comment"># salt master主机名</span></span><br><span class="line"><span class="attr">    cwd:</span> <span class="string">'/data1/vhosts'</span>  <span class="comment"># 代码检出目录</span></span><br><span class="line"><span class="attr">projects:</span></span><br><span class="line">  <span class="string">www.mall.com:</span>  <span class="comment"># 定义项目名</span></span><br><span class="line"><span class="attr">    remote:</span> <span class="string">'svn://172.16.100.81/www.mall.com'</span> <span class="comment"># svn存放路径</span></span><br><span class="line"><span class="attr">    target:</span>  <span class="comment"># 定义代码部署列表 ip::rsync模块</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'172.16.100.21::www_mall_com'</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'172.16.100.22::www_mall_com'</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'172.16.100.23::www_mall_com'</span></span><br></pre></td></tr></table></figure>

<p>另外还要配置runner的放置目录：runner_dirs: [/srv/salt/_runners]，配置完成后要重启Puppet master。</p>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Saltstack/">Saltstack</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/devops/">devops</a><a href="/tags/saltstack/">saltstack</a><a href="/tags/salt/">salt</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2014/06/15/saltstack-publish/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2014/06/14/saltstack-service/"><span>Saltstack：服务部署</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2014/06/14/saltstack-service/" rel="bookmark">
        <time class="entry-date published" datetime="2014-06-14T02:00:00.000Z">
          2014-06-14
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>本文以web服务器为例介绍salt服务的部署。把不同的服务组织成不同的角色，然后将角色应用到不同的节点上。通过角色的划分能够清晰的对不同的服务模块进行组织，所有角色的配置放到/srv/salt/roles下，角色用到的相关变量放到/srv/pillar/roles和/srv/pillar/nodes下，其中/srv/pillar/nodes下放置与具体节点相关的变量。</p>
<h3 id="角色与配置文件"><a href="#角色与配置文件" class="headerlink" title="角色与配置文件"></a>角色与配置文件</h3><p>/srv/salt/roles/web.sls配置如下，包括nginx模块、rsync模块、limits模块和nfs.client：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nginx</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">rsync</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">limits</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nfs.client</span></span><br></pre></td></tr></table></figure>

<p>变量/srv/pillar/roles/web.sls如下，没有单独应用到节点的变量:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hostgroup:</span> <span class="string">web</span>  <span class="comment"># 定义zabbix分组，具体见后文的自动化监控一节</span></span><br><span class="line"><span class="attr">vhostsdir:</span> <span class="string">/data1/vhosts</span>  <span class="comment"># 代码发布目录</span></span><br><span class="line"><span class="attr">vhostscachedir:</span> <span class="string">/data1/cache</span>  <span class="comment"># 程序临时目录</span></span><br><span class="line"><span class="attr">logdir:</span> <span class="string">/data1/logs</span>  <span class="comment"># nginx日志目录</span></span><br><span class="line"><span class="attr">vhosts:</span>  <span class="comment"># 虚拟主机名，用于创建对用的代码发布目录</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">www.mall.com</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">static.mall.com</span></span><br><span class="line"><span class="attr">limit_users:</span>  <span class="comment"># 对用户打开文件数做设置</span></span><br><span class="line"><span class="attr">  nginx:</span></span><br><span class="line"><span class="attr">    limit_hard:</span> <span class="number">65535</span></span><br><span class="line"><span class="attr">    limit_soft:</span> <span class="number">65535</span></span><br><span class="line"><span class="attr">    limit_type:</span> <span class="string">nofile</span></span><br><span class="line"><span class="attr">mounts:</span> <span class="comment"># nfs共享存储挂载相关配置</span></span><br><span class="line">  <span class="string">/data1/vhosts/static.mall.com/htdocs:</span></span><br><span class="line"><span class="attr">    device:</span> <span class="number">172.16</span><span class="number">.100</span><span class="number">.71</span><span class="string">:/data1/share</span></span><br><span class="line"><span class="attr">    fstype:</span> <span class="string">nfs</span></span><br><span class="line"><span class="attr">    mkmnt:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    opts:</span> <span class="string">async,noatime,noexec,nosuid,soft,timeo=3,retrans=3,intr,retry=3,rsize=16384,wsize=16384</span></span><br></pre></td></tr></table></figure>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Saltstack/">Saltstack</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/devops/">devops</a><a href="/tags/saltstack/">saltstack</a><a href="/tags/salt/">salt</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2014/06/14/saltstack-service/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2014/05/29/saltstack-base-service/"><span>Saltstack：基础服务部署</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2014/05/29/saltstack-base-service/" rel="bookmark">
        <time class="entry-date published" datetime="2014-05-29T02:00:00.000Z">
          2014-05-29
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>对基础服务的管理包括配置管理系统、用户账号管理、yum配置管理、hosts文件管理、时间同步管理、DNS配置管理。</p>
<h3 id="配置管理系统"><a href="#配置管理系统" class="headerlink" title="配置管理系统"></a>配置管理系统</h3><p>配置管理系统使用模块化设计，每个服务一个模块，将多个模块组织到一起形成角色（/srv/salt/roles/）。所有模块放置到：/srv/salt下，入口配置文件为：/srv/salt/top.sls。模块使用的变量放置到：/srv/pillar，入口配置文件：/srv/pillar/top.sls。针对变量的作用域不同，将变量分为三级级，一级应用于模块（/srv/pillar/模块名），一级应用于角色（/srv/pillar/roles/），一级应用于主机节点（/srv/pillar/nodes）。具体配置在此不一一列出，具体参见salt配置文件。</p>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Saltstack/">Saltstack</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/devops/">devops</a><a href="/tags/saltstack/">saltstack</a><a href="/tags/salt/">salt</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2014/05/29/saltstack-base-service/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2014/05/28/saltstack-install/"><span>Saltstack：安装</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2014/05/28/saltstack-install/" rel="bookmark">
        <time class="entry-date published" datetime="2014-05-28T02:00:00.000Z">
          2014-05-28
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>本文以一个小的电商网站（<a href="http://www.mall.com）为例，讲述Saltstack在真实场景中的应用。本节主要讲述Saltstack的安装过程。" target="_blank" rel="noopener">www.mall.com）为例，讲述Saltstack在真实场景中的应用。本节主要讲述Saltstack的安装过程。</a></p>
<h2 id="Saltstack安装"><a href="#Saltstack安装" class="headerlink" title="Saltstack安装"></a>Saltstack安装</h2><p>Saltstack源码地址：<a href="https://github.com/saltstack/salt，最新版本为v2014.1.4。" target="_blank" rel="noopener">https://github.com/saltstack/salt，最新版本为v2014.1.4。</a><br>需要自己<a href="http://yoyolive.com/%E5%85%B6%E4%BB%96/2014/05/22/rpm-pkg.html" target="_blank" rel="noopener">打rpm包</a>，salt描述文件：<a href="https://github.com/saltstack/salt/blob/develop/pkg/rpm/salt.spec，另外最新版本的salt需要python-libcloud，也需要提前打好包。如果是在CentOS" target="_blank" rel="noopener">https://github.com/saltstack/salt/blob/develop/pkg/rpm/salt.spec，另外最新版本的salt需要python-libcloud，也需要提前打好包。如果是在CentOS</a> 5.x 上安装salt，需要升级zeromq到3.x版。将所有打好的rpm包放入yum仓库，开始安装。</p>
<h3 id="Salt-Master安装"><a href="#Salt-Master安装" class="headerlink" title="Salt Master安装"></a>Salt Master安装</h3><p>注意：安装前确保主机名已按角色划分部分进行配置。</p>
<p>安装salt-master：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum install -y salt-master</span></span><br></pre></td></tr></table></figure>

<p>修改配置文件：/etc/salt/master，使salt监听在内网网卡上。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">interface: 172.16.100.81</span><br></pre></td></tr></table></figure>

<p>启动Salt Master：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/init.d/salt-master start</span></span><br></pre></td></tr></table></figure>

<p>查看启动情况，4505端口处于监听状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># netstat -tunlp |grep 4505</span></span><br></pre></td></tr></table></figure>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Saltstack/">Saltstack</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/devops/">devops</a><a href="/tags/saltstack/">saltstack</a><a href="/tags/salt/">salt</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2014/05/28/saltstack-install/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2014/05/27/saltstack-example-introduction/"><span>Saltstack：网站架构介绍</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2014/05/27/saltstack-example-introduction/" rel="bookmark">
        <time class="entry-date published" datetime="2014-05-27T02:00:00.000Z">
          2014-05-27
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>本文以一个小的电商网站（<a href="http://www.mall.com）为例，讲述Saltstack在真实场景中的应用。主要介绍如何使用salt对电商网站各种服务进行管理、基于角色对应用进行自动化监控、基于Saltstack" target="_blank" rel="noopener">www.mall.com）为例，讲述Saltstack在真实场景中的应用。主要介绍如何使用salt对电商网站各种服务进行管理、基于角色对应用进行自动化监控、基于Saltstack</a> runner的代码部署系统等，主要包括以下主题：</p>
<ul>
<li><a href="http://yoyolive.com/saltstack/2014/05/27/saltstack-example-introduction.html" target="_blank" rel="noopener">网站架构介绍</a></li>
<li><a href="http://yoyolive.com/saltstack/2014/05/28/saltstack-install.html" target="_blank" rel="noopener">Saltstack安装</a></li>
<li><a href="http://yoyolive.com/saltstack/2014/05/29/saltstack-base-service.html" target="_blank" rel="noopener">基础服务部署</a></li>
<li><a href="http://yoyolive.com/saltstack/2014/06/14/saltstack-service.html" target="_blank" rel="noopener">服务部署</a></li>
<li><a href="http://yoyolive.com/saltstack/2014/06/15/saltstack-publish.html" target="_blank" rel="noopener">代码部署系统搭建</a></li>
<li><a href="http://yoyolive.com/saltstack/2014/06/16/saltstack-zabbix-monitor.html" target="_blank" rel="noopener">自动化监控</a></li>
<li><a href="http://yoyolive.com/saltstack/2014/06/17/saltstack-expand.html" target="_blank" rel="noopener">Salt模块的扩展</a></li>
</ul>
<p>项目代码已放到GitHub上，地址：<a href="https://github.com/ist0ne/salt-states" target="_blank" rel="noopener">https://github.com/ist0ne/salt-states</a></p>
<h2 id="网站架构介绍"><a href="#网站架构介绍" class="headerlink" title="网站架构介绍"></a>网站架构介绍</h2><h3 id="网络架构"><a href="#网络架构" class="headerlink" title="网络架构"></a>网络架构</h3><ol>
<li>使用Haproxy做负载均衡，一主一备，当主服务器宕机后备服务器自动接替主服务器角色对外提供服务。</li>
<li>WEB前端采用Nginx+PHP提供动态页面的访问；所有前端服务器通过NFS协议挂载共享存储，商品展示图片上传至存储中，图片访问时通过Varnish进行缓存加速。</li>
<li>使用memcached做缓冲层来提高访问速度和减轻数据库的压力；使用Redis做队列服务。</li>
<li>数据持久层使用MySQL，MySQL采用主从模式，通过主从分离提高访问速度。</li>
<li>使用Salt对整个系统进行配置管理；使用Zabbix进行系统监控；所有服务器通过跳板机进行登录。</li>
<li>使用SVN统一管理代码和配置信息。</li>
</ol>
<p><img src="/images/14-05-27/net.png" alt="网络架构"></p>
<p>说明:上面网络架构未按实际服务器数量画出，具体服务器见角色划分部分。</p>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Saltstack/">Saltstack</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/devops/">devops</a><a href="/tags/saltstack/">saltstack</a><a href="/tags/salt/">salt</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2014/05/27/saltstack-example-introduction/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2014/05/22/rpm-pkg/"><span>rpm打包</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2014/05/22/rpm-pkg/" rel="bookmark">
        <time class="entry-date published" datetime="2014-05-22T02:00:00.000Z">
          2014-05-22
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>为了方便批量进行软件安装，我们通常将源代码打包，放到yum仓库中进行统一管理，本文记录了一次rpm打包过程。</p>
<h2 id="1、安装rpm-build"><a href="#1、安装rpm-build" class="headerlink" title="1、安装rpm-build"></a>1、安装rpm-build</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y rpm-build</span><br></pre></td></tr></table></figure>

<h2 id="2、安装编译依赖包"><a href="#2、安装编译依赖包" class="headerlink" title="2、安装编译依赖包"></a>2、安装编译依赖包</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y make gcc gcc-c++ libtool autoconf automake imake</span><br></pre></td></tr></table></figure>

<h2 id="3、安装软件本身依赖的软件包"><a href="#3、安装软件本身依赖的软件包" class="headerlink" title="3、安装软件本身依赖的软件包"></a>3、安装软件本身依赖的软件包</h2><p>以CoreSeek安装为例，<a href="http://www.coreseek.cn/products-install/" target="_blank" rel="noopener">Coreseek</a> 是一款中文全文检索/搜索软件，以GPLv2许可协议开源发布，基于Sphinx研发并独立发布，专攻中文搜索和信息处理领域，适用于行业/垂直搜索、论坛/站内搜索、数据库搜索、文档/文献检索、信息检索、数据挖掘等应用场景。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y libxml2-devel expat-devel mysql-devel python-devel</span><br></pre></td></tr></table></figure>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/其他/">其他</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/rpm/">rpm</a><a href="/tags/rpm-build/">rpm-build</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2014/05/22/rpm-pkg/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>




<nav class="pagination">
  
  <a href="/" class="pagination-prev">上一页</a>
  
  
  <a href="/page/3/" class="pagination-next">下一页</a>
  
</nav>
    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2019 ist0ne
    
  </p>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-39923501-1', 'auto');
    ga('send', 'pageview');

</script>

  </div>
</div>
</body>
</html>