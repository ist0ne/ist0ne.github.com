<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>石头记</title>
  
  <subtitle>Docker、Kubernetes、CI/CD 等技术分享</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://istone.dev/"/>
  <updated>2019-06-26T14:45:48.772Z</updated>
  <id>https://istone.dev/</id>
  
  <author>
    <name>ist0ne</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Openstack 使用</title>
    <link href="https://istone.dev/2014/09/10/openstack-use/"/>
    <id>https://istone.dev/2014/09/10/openstack-use/</id>
    <published>2014-09-10T03:00:00.000Z</published>
    <updated>2019-06-26T14:45:48.772Z</updated>
    
    <content type="html"><![CDATA[<p>OpenStack作为基础设施即服务（简称IaaS）资源的通用前端。首要任务是简化云的部署过程并为其带来良好的可扩展性。本文希望通过提供必要的指导信息，帮助大家利用OpenStack前端来设置及管理自己的私有云。</p><h2 id="导入虚拟机镜像"><a href="#导入虚拟机镜像" class="headerlink" title="导入虚拟机镜像"></a>导入虚拟机镜像</h2><p>如下列出了一下虚拟机镜像，可以在本地下载后通过Openstack界面导入。</p><p><a href="https://openstack.redhat.com/Image_resources" target="_blank" rel="noopener">https://openstack.redhat.com/Image_resources</a></p><p>也可以参考如下文档自己制作镜像：</p><p><a href="https://www.ibm.com/developerworks/community/wikis/home?lang=en#!/wiki/OpenStack/page/Creating%20qcow2%20CentOS%20Image%20for%20OpenStack" target="_blank" rel="noopener">https://www.ibm.com/developerworks/community/wikis/home?lang=en#!/wiki/OpenStack/page/Creating%20qcow2%20CentOS%20Image%20for%20OpenStack</a></p><p>导入镜像：</p><p>点击左侧的镜像 选项卡，可以看到已经导入的镜像，点击创建镜像 按钮创建镜像。</p><p><img src="/images/14-09-10/openstack_images.png" alt="Openstack镜像"></p><p>填写 镜像名称，镜像源选择—镜像文件，格式选择 QCOW2，勾选 公有 框（这样你上传得镜像其他人也能使用），然后点击创建镜像。</p><p><img src="/images/14-09-10/openstack_create_image.png" alt="Openstack创建镜像"></p><h2 id="创建虚拟机"><a href="#创建虚拟机" class="headerlink" title="创建虚拟机"></a>创建虚拟机</h2><p>点击左侧的 实例 选项卡，可以看到已创建的虚拟机，点击右上角的启动云主机创建 虚拟机。</p><p><img src="/images/14-09-10/openstack_create_vm_1.png" alt="Openstack创建虚拟机1"></p><p>在详情选项卡填写云主机名称、选择云主机的规格类型、云主机数量、云主机启动的源，本文从镜像启动，然后选择镜像名称，点击 访问 &amp; 安全选项卡。</p><p><img src="/images/14-09-10/openstack_create_vm_2.png" alt="Openstack创建虚拟机2"></p><p>选择一个秘钥对，如果没有需要点击加按钮进行创建，此秘钥对用于登陆创建的虚拟主机（在Openstack中虚拟主机的登陆一般不是通过用户名密码登陆的）。安全组选择default（用于设置防火墙规则）。</p><p><img src="/images/14-09-10/openstack_create_vm_3.png" alt="Openstack创建虚拟机3"></p><p>如下创建秘钥对：</p><p><img src="/images/14-09-10/openstack_create_vm_4.png" alt="Openstack创建虚拟机4"></p><p>点击 网络 选项卡，点击网络框中的+为虚拟机选择私有网络。</p><p><img src="/images/14-09-10/openstack_create_vm_5.png" alt="Openstack创建虚拟机5"></p><p>以上设置完成后点击运行，开始创建虚拟机。</p><p><img src="/images/14-09-10/openstack_create_vm_6.png" alt="Openstack创建虚拟机6"></p><p>点击更多，分配浮动IP地址，虚拟机只能通过浮动IP地址进行登陆。</p><p><img src="/images/14-09-10/openstack_create_vm_7.png" alt="Openstack创建虚拟机7"></p><h2 id="访问-amp-安全"><a href="#访问-amp-安全" class="headerlink" title="访问 &amp; 安全"></a>访问 &amp; 安全</h2><p>默认情况下，创建的虚拟机不能被ping 通和进行ssh 连接，需要修改默认安全规则。点击 管理规则。</p><p><img src="/images/14-09-10/openstack_access_1.png" alt="Openstack访问 &amp; 安全1"></p><p>然后点击添加规则。</p><p><img src="/images/14-09-10/openstack_access_2.png" alt="Openstack访问 &amp; 安全2"></p><p>如下添加ICMP规则，允许虚拟机被ping通。</p><p><img src="/images/14-09-10/openstack_access_3_icmp.png" alt="Openstack访问 &amp; 安全3"></p><p>添加SSH规则，允许虚拟机通过SSH客户端进行连接。</p><p><img src="/images/14-09-10/openstack_access_4_ssh.png" alt="Openstack访问 &amp; 安全4"></p><p>分配完浮动IP地址并设置好安全规则就可以登陆虚拟机了（必须在生成ssh key的机器上进行登陆）。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@fuel ~]<span class="comment"># ssh centos@172.16.200.133</span></span><br><span class="line">[centos@vm-centos-7 ~]$ sudo su -</span><br><span class="line">[root@vm-centos-7 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h2 id="为虚拟机挂载数据盘"><a href="#为虚拟机挂载数据盘" class="headerlink" title="为虚拟机挂载数据盘"></a>为虚拟机挂载数据盘</h2><p>点击 左侧的 云硬盘 选项卡，点击 创建云硬盘 按钮，然后如下填写 创建云硬盘。</p><p><img src="/images/14-09-10/openstack_vdisk_1.png" alt="Openstack云硬盘1"></p><p>然后点击更多，选择 编辑挂载。</p><p><img src="/images/14-09-10/openstack_vdisk_2.png" alt="Openstack云硬盘2"></p><p>选择要连接到的虚拟机，然后连接数据盘。</p><p><img src="/images/14-09-10/openstack_vdisk_3.png" alt="Openstack云硬盘3"></p><p>登陆虚拟机，对已挂在的数据盘进行分区。</p><p><img src="/images/14-09-10/openstack_vdisk_4.png" alt="Openstack云硬盘4"></p><p><img src="/images/14-09-10/openstack_vdisk_5.png" alt="Openstack云硬盘5"></p><p>格式化数据盘并挂载。</p><p><img src="/images/14-09-10/openstack_vdisk_6.png" alt="Openstack云硬盘6"></p><p>将需要挂载的数据盘 写入/etc/fstab文件，以便开机自动挂载。</p><p><img src="/images/14-09-10/openstack_vdisk_7.png" alt="Openstack云硬盘7"></p><h2 id="为admin租户新增网段"><a href="#为admin租户新增网段" class="headerlink" title="为admin租户新增网段"></a>为admin租户新增网段</h2><p># 设置认证信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># cat creds-admin</span></span><br><span class="line"><span class="built_in">export</span> OS_TENANT_NAME=admin</span><br><span class="line"><span class="built_in">export</span> OS_USERNAME=admin</span><br><span class="line"><span class="built_in">export</span> OS_PASSWORD=admin</span><br><span class="line"><span class="built_in">export</span> OS_AUTH_URL=<span class="string">"http://172.16.200.2:5000/v2.0/“</span></span><br></pre></td></tr></table></figure><p># 使认证信息生效</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># . creds-admin</span></span><br></pre></td></tr></table></figure><p># 列出所有租户信息，admin的租户ID为：f51b22163f504dd6a6014f4700e9ee48</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># keystone tenant-list</span></span><br><span class="line">+----------------------------------+----------+---------+</span><br><span class="line">|                id                |   name   | enabled |</span><br><span class="line">+----------------------------------+----------+---------+</span><br><span class="line">| f51b22163f504dd6a6014f4700e9ee48 |  admin   |   True  |</span><br><span class="line">| 8dc964cb23414e1497a74db79ddb563f | services |   True  |</span><br><span class="line">+----------------------------------+----------+---------+</span><br></pre></td></tr></table></figure><p># 为admin租户添加网络net_admin，net_admin网络ID为：284d3f00-042b-41b2-bec4-f5bc7dcee037</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># neutron net-create --tenant-id f51b22163f504dd6a6014f4700e9ee48 net_admin</span></span><br><span class="line">Created a new network:</span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line">| Field                     | Value                                |</span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line">| admin_state_up            | True                                 |</span><br><span class="line">| id                        | 284d3f00-042b-41b2-bec4-f5bc7dcee037 |</span><br><span class="line">| name                      | net_admin                            |</span><br><span class="line">| provider:network_type     | vlan                                 |</span><br><span class="line">| provider:physical_network | physnet2                             |</span><br><span class="line">| provider:segmentation_id  | 511                                  |</span><br><span class="line">| shared                    | False                                |</span><br><span class="line">| status                    | ACTIVE                               |</span><br><span class="line">| subnets                   |                                      |</span><br><span class="line">| tenant_id                 | f51b22163f504dd6a6014f4700e9ee48     |</span><br><span class="line">+---------------------------+--------------------------------------+</span><br></pre></td></tr></table></figure><p># 为net_admin网络添加子网，子网ID：31896641-28e4-4983-b24d-f37348286a85</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># neutron subnet-create --name net_admin__subnet --tenant-id f51b22163f504dd6a6014f4700e9ee48 net_admin 192.168.101.0/24</span></span><br><span class="line">Created a new subnet:</span><br><span class="line">+------------------+------------------------------------------------------+</span><br><span class="line">| Field            | Value                                                |</span><br><span class="line">+------------------+------------------------------------------------------+</span><br><span class="line">| allocation_pools | &#123;<span class="string">"start"</span>: <span class="string">"192.168.101.2"</span>, <span class="string">"end"</span>: <span class="string">"192.168.101.254"</span>&#125; |</span><br><span class="line">| cidr             | 192.168.101.0/24                                     |</span><br><span class="line">| dns_nameservers  |                                                      |</span><br><span class="line">| enable_dhcp      | True                                                 |</span><br><span class="line">| gateway_ip       | 192.168.101.1                                        |</span><br><span class="line">| host_routes      |                                                      |</span><br><span class="line">| id               | 31896641-28e4-4983-b24d-f37348286a85                 |</span><br><span class="line">| ip_version       | 4                                                    |</span><br><span class="line">| name             | net_admin__subnet                                    |</span><br><span class="line">| network_id       | 284d3f00-042b-41b2-bec4-f5bc7dcee037                 |</span><br><span class="line">| tenant_id        | f51b22163f504dd6a6014f4700e9ee48                     |</span><br><span class="line">+------------------+------------------------------------------------------+</span><br></pre></td></tr></table></figure><p># 修改子网dns地址</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># neutron subnet-update 31896641-28e4-4983-b24d-f37348286a85 --dns_nameservers list=true 8.8.4.4 8.8.8.8</span></span><br><span class="line">Updated subnet: 31896641-28e4-4983-b24d-f37348286a85</span><br></pre></td></tr></table></figure><p># 列出路由器信息，路由器ID为：dfcf3d90-2409-4505-a020-58b8ed3c9e67</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># neutron router-list</span></span><br><span class="line">+--------------------------------------+----------+-----------------------------------------------------------------------------+</span><br><span class="line">| id                                   | name     | external_gateway_info                                                       |</span><br><span class="line">+--------------------------------------+----------+-----------------------------------------------------------------------------+</span><br><span class="line">| dfcf3d90-2409-4505-a020-58b8ed3c9e67 | router04 | &#123;<span class="string">"network_id"</span>: <span class="string">"c4448c0d-f633-449a-861a-a39a304cad21"</span>, <span class="string">"enable_snat"</span>: <span class="literal">true</span>&#125; |</span><br><span class="line">+--------------------------------------+----------+-----------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure><p># 将子网（31896641-28e4-4983-b24d-f37348286a85）连接到路由器（dfcf3d90-2409-4505-a020-58b8ed3c9e67）上</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># neutron router-interface-add dfcf3d90-2409-4505-a020-58b8ed3c9e67 31896641-28e4-4983-b24d-f37348286a85</span></span><br><span class="line">Added interface a8e6c89f-45a4-4b20-876c-844e46f09a46 to router dfcf3d90-2409-4505-a020-58b8ed3c9e67.</span><br></pre></td></tr></table></figure><p># 列出代理信息，DHCP代理ID为：75a25941-0b13-4efc-aea8-ad7150d3e89e</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># neutron agent-list</span></span><br><span class="line">+--------------------------------------+--------------------+------------------+-------+----------------+</span><br><span class="line">| id                                   | agent_type         | host             | alive | admin_state_up |</span><br><span class="line">+--------------------------------------+--------------------+------------------+-------+----------------+</span><br><span class="line">| 1544e83b-a495-4a46-b43c-b050596ecc9a | Open vSwitch agent | node-11.example.com | :-)   | True           |</span><br><span class="line">| 2117339e-039d-4eb7-b7f0-6e645c50c69d | Metadata agent     | node-9.example.com  | :-)   | True           |</span><br><span class="line">| 75a25941-0b13-4efc-aea8-ad7150d3e89e | DHCP agent         | node-9.example.com  | :-)   | True           |</span><br><span class="line">| c8701380-1705-436f-858d-2b79a17dcff8 | L3 agent           | node-9.example.com  | :-)   | True           |</span><br><span class="line">| fa010ebe-db3b-4251-9c89-59c864d54971 | Open vSwitch agent | node-9.example.com  | :-)   | True           |</span><br><span class="line">+--------------------------------------+--------------------+------------------+-------+----------------+</span><br></pre></td></tr></table></figure><p># 为net_admin网络添加DHCP代理，以便此网段能够自动分配IP地址</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># neutron dhcp-agent-network-add 75a25941-0b13-4efc-aea8-ad7150d3e89e net_admin</span></span><br><span class="line">Added network net_admin to DHCP agent</span><br></pre></td></tr></table></figure><p># 完成后网络拓扑如图所示(net_admin和net04都是是通过router04与net04_ext相连的，Openstack控制界面上显示异常)：</p><p><img src="/images/14-09-10/openstack_tuopu.png" alt="Openstack网络拓扑"></p><h2 id="添加租户并设置网络"><a href="#添加租户并设置网络" class="headerlink" title="添加租户并设置网络"></a>添加租户并设置网络</h2><p>添加租户op.example.com，并为租户添加网络：</p><p># 使认证信息生效</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># . creds-admin</span></span><br></pre></td></tr></table></figure><p># 创建op.example.com租户，租户ID为：2e8def45720343fb9d648bd561a99c06</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># keystone tenant-create --name op.example.com</span></span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">|   Property  |              Value               |</span><br><span class="line">+-------------+----------------------------------+</span><br><span class="line">| description |                                  |</span><br><span class="line">|   enabled   |               True               |</span><br><span class="line">|      id     | 2e8def45720343fb9d648bd561a99c06 |</span><br><span class="line">|     name    |          op.example.com          |</span><br><span class="line">+-------------+----------------------------------+</span><br></pre></td></tr></table></figure><p># 为租户创建用户</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># keystone user-create --name=dongliang --pass=123456 --tenant-id=2e8def45720343fb9d648bd561a99c06 --email=dongliang@example.com</span></span><br><span class="line">+----------+----------------------------------+</span><br><span class="line">| Property |              Value               |</span><br><span class="line">+----------+----------------------------------+</span><br><span class="line">|  email   |      dongliang@example.com       |</span><br><span class="line">| enabled  |               True               |</span><br><span class="line">|    id    | 181390a3b29d4e3fa9938aa7d65bb0b3 |</span><br><span class="line">|   name   |            dongliang             |</span><br><span class="line">| tenantId | 2e8def45720343fb9d648bd561a99c06 |</span><br><span class="line">| username |            dongliang             |</span><br><span class="line">+----------+----------------------------------+</span><br></pre></td></tr></table></figure><p># 列出角色信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># keystone role-list</span></span><br><span class="line">+----------------------------------+-----------------+</span><br><span class="line">|                id                |       name      |</span><br><span class="line">+----------------------------------+-----------------+</span><br><span class="line">| d6284307ed704c9da4ab426f123e3c9f |      Member     |</span><br><span class="line">| 9fe2ff9ee4384b1894a90878d3e92bab |     _member_    |</span><br><span class="line">| f44b81985a3849f1ae98e36357cdad0d |      admin      |</span><br><span class="line">| e45948cda56f4306b17cb408c7d33b9b | heat_stack_user |</span><br><span class="line">+----------------------------------+-----------------+</span><br></pre></td></tr></table></figure><p># 为dongliang用户添加角色</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># keystone user-role-add --tenant-id 2e8def45720343fb9d648bd561a99c06 --user-id 181390a3b29d4e3fa9938aa7d65bb0b3 --role-id d6284307ed704c9da4ab426f123e3c9f</span></span><br></pre></td></tr></table></figure><p># 为op.example.com 租户添加网络 net_op_leju_com，具体参见为admin租户新增网段</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># neutron net-create --tenant-id 2e8def45720343fb9d648bd561a99c06 net_op_leju_com</span></span><br><span class="line">Created a new network:</span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line">| Field                     | Value                                |</span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line">| admin_state_up            | True                                 |</span><br><span class="line">| id                        | 429f5040-ca24-42ff-9260-a5148ff47391 |</span><br><span class="line">| name                      | net_op_leju_com                      |</span><br><span class="line">| provider:network_type     | vlan                                 |</span><br><span class="line">| provider:physical_network | physnet2                             |</span><br><span class="line">| provider:segmentation_id  | 512                                  |</span><br><span class="line">| shared                    | False                                |</span><br><span class="line">| status                    | ACTIVE                               |</span><br><span class="line">| subnets                   |                                      |</span><br><span class="line">| tenant_id                 | 2e8def45720343fb9d648bd561a99c06     |</span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line"></span><br><span class="line">[root@node-9 ~]<span class="comment"># neutron subnet-create --tenant-id 2e8def45720343fb9d648bd561a99c06 net_op_leju_com 172.16.102.0/24</span></span><br><span class="line">Created a new subnet:</span><br><span class="line">+------------------+----------------------------------------------------+</span><br><span class="line">| Field            | Value                                              |</span><br><span class="line">+------------------+----------------------------------------------------+</span><br><span class="line">| allocation_pools | &#123;<span class="string">"start"</span>: <span class="string">"172.16.102.2"</span>, <span class="string">"end"</span>: <span class="string">"172.16.102.254"</span>&#125; |</span><br><span class="line">| cidr             | 172.16.102.0/24                                    |</span><br><span class="line">| dns_nameservers  |                                                    |</span><br><span class="line">| enable_dhcp      | True                                               |</span><br><span class="line">| gateway_ip       | 172.16.102.1                                       |</span><br><span class="line">| host_routes      |                                                    |</span><br><span class="line">| id               | e13718ef-58a0-4741-9fed-963f393202c1               |</span><br><span class="line">| ip_version       | 4                                                  |</span><br><span class="line">| name             |                                                    |</span><br><span class="line">| network_id       | 429f5040-ca24-42ff-9260-a5148ff47391               |</span><br><span class="line">| tenant_id        | 2e8def45720343fb9d648bd561a99c06                   |</span><br><span class="line">+------------------+----------------------------------------------------+</span><br></pre></td></tr></table></figure><p># 修改子网dns地址</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># neutron subnet-update e13718ef-58a0-4741-9fed-963f393202c1 --dns_nameservers list=true 8.8.4.4 8.8.8.8</span></span><br><span class="line">Updated subnet: e13718ef-58a0-4741-9fed-963f393202c1</span><br><span class="line"></span><br><span class="line">[root@node-9 ~]<span class="comment"># neutron router-list</span></span><br><span class="line">+--------------------------------------+----------+-----------------------------------------------------------------------------+</span><br><span class="line">| id                                   | name     | external_gateway_info                                                       |</span><br><span class="line">+--------------------------------------+----------+-----------------------------------------------------------------------------+</span><br><span class="line">| dfcf3d90-2409-4505-a020-58b8ed3c9e67 | router04 | &#123;<span class="string">"network_id"</span>: <span class="string">"c4448c0d-f633-449a-861a-a39a304cad21"</span>, <span class="string">"enable_snat"</span>: <span class="literal">true</span>&#125; |</span><br><span class="line">+--------------------------------------+----------+-----------------------------------------------------------------------------+</span><br><span class="line"></span><br><span class="line">[root@node-9 ~]<span class="comment"># neutron router-interface-add dfcf3d90-2409-4505-a020-58b8ed3c9e67 e13718ef-58a0-4741-9fed-963f393202c1</span></span><br><span class="line">Added interface 4d978e71-1b97-46d3-9f6a-7ace3aa54b3d to router dfcf3d90-2409-4505-a020-58b8ed3c9e67.</span><br><span class="line"></span><br><span class="line">[root@node-9 ~]<span class="comment"># neutron agent-list</span></span><br><span class="line">+--------------------------------------+--------------------+------------------+-------+----------------+</span><br><span class="line">| id                                   | agent_type         | host             | alive | admin_state_up |</span><br><span class="line">+--------------------------------------+--------------------+------------------+-------+----------------+</span><br><span class="line">| 1544e83b-a495-4a46-b43c-b050596ecc9a | Open vSwitch agent | node-11.example.com | :-)   | True           |</span><br><span class="line">| 2117339e-039d-4eb7-b7f0-6e645c50c69d | Metadata agent     | node-9.example.com  | :-)   | True           |</span><br><span class="line">| 75a25941-0b13-4efc-aea8-ad7150d3e89e | DHCP agent         | node-9.example.com  | :-)   | True           |</span><br><span class="line">| c8701380-1705-436f-858d-2b79a17dcff8 | L3 agent           | node-9.example.com  | :-)   | True           |</span><br><span class="line">| fa010ebe-db3b-4251-9c89-59c864d54971 | Open vSwitch agent | node-9.example.com  | :-)   | True           |</span><br><span class="line">+--------------------------------------+--------------------+------------------+-------+----------------+</span><br><span class="line"></span><br><span class="line">[root@node-9 ~]<span class="comment"># neutron dhcp-agent-network-add 75a25941-0b13-4efc-aea8-ad7150d3e89e net_op_leju_com</span></span><br><span class="line">Added network net_op_leju_com to DHCP agent</span><br><span class="line"></span><br><span class="line">[root@node-9 ~]<span class="comment"># neutron net-list</span></span><br><span class="line">+--------------------------------------+-----------------+-------------------------------------------------------+</span><br><span class="line">| id                                   | name            | subnets                                               |</span><br><span class="line">+--------------------------------------+-----------------+-------------------------------------------------------+</span><br><span class="line">| 284d3f00-042b-41b2-bec4-f5bc7dcee037 | net_admin       | 31896641-28e4-4983-b24d-f37348286a85 192.168.101.0/24 |</span><br><span class="line">| 35030315-0abb-4321-bd2d-fa02ecebe4a4 | net04           | 33fec45a-5a55-4e66-b5d0-d243a63b5b52 192.168.100.0/24 |</span><br><span class="line">| 429f5040-ca24-42ff-9260-a5148ff47391 | net_op_leju_com | e13718ef-58a0-4741-9fed-963f393202c1 172.16.102.0/24  |</span><br><span class="line">| c4448c0d-f633-449a-861a-a39a304cad21 | net04_ext       | fc9caac9-d9a9-43f4-9fec-feebc14038cd 172.16.200.0/24  |</span><br><span class="line">+--------------------------------------+-----------------+-------------------------------------------------------+</span><br><span class="line"></span><br><span class="line">[root@node-9 ~]<span class="comment"># neutron net-show c4448c0d-f633-449a-861a-a39a304cad21</span></span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line">| Field                     | Value                                |</span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line">| admin_state_up            | True                                 |</span><br><span class="line">| id                        | c4448c0d-f633-449a-861a-a39a304cad21 |</span><br><span class="line">| name                      | net04_ext                            |</span><br><span class="line">| provider:network_type     | flat                                 |</span><br><span class="line">| provider:physical_network | physnet1                             |</span><br><span class="line">| provider:segmentation_id  |                                      |</span><br><span class="line">| router:external           | True                                 |</span><br><span class="line">| shared                    | *False*                              |</span><br><span class="line">| status                    | ACTIVE                               |</span><br><span class="line">| subnets                   | fc9caac9-d9a9-43f4-9fec-feebc14038cd |</span><br><span class="line">| tenant_id                 | f51b22163f504dd6a6014f4700e9ee48     |</span><br><span class="line">+---------------------------+--------------------------------------+</span><br></pre></td></tr></table></figure><p># 修改net04_ext网络为共享模式</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># neutron net-update c4448c0d-f633-449a-861a-a39a304cad21 --shared</span></span><br><span class="line">Updated network: c4448c0d-f633-449a-861a-a39a304cad21</span><br><span class="line"></span><br><span class="line">[root@node-9 ~]<span class="comment"># neutron net-show c4448c0d-f633-449a-861a-a39a304cad21</span></span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line">| Field                     | Value                                |</span><br><span class="line">+---------------------------+--------------------------------------+</span><br><span class="line">| admin_state_up            | True                                 |</span><br><span class="line">| id                        | c4448c0d-f633-449a-861a-a39a304cad21 |</span><br><span class="line">| name                      | net04_ext                            |</span><br><span class="line">| provider:network_type     | flat                                 |</span><br><span class="line">| provider:physical_network | physnet1                             |</span><br><span class="line">| provider:segmentation_id  |                                      |</span><br><span class="line">| router:external           | True                                 |</span><br><span class="line">| shared                    | *True*                               |</span><br><span class="line">| status                    | ACTIVE                               |</span><br><span class="line">| subnets                   | fc9caac9-d9a9-43f4-9fec-feebc14038cd |</span><br><span class="line">| tenant_id                 | f51b22163f504dd6a6014f4700e9ee48     |</span><br><span class="line">+---------------------------+--------------------------------------+</span><br></pre></td></tr></table></figure><p># 完成后网络拓扑如图所示(net_op_leju_com是通过router04与net04_ext相连的，Openstack控制界面上显示异常)：</p><blockquote><p>注意： 以上租户和网络创建都是通过命令行添加的，Openstack界面也可以实现部分功能，但有时添加会有问题，建议使用命令行添加。</p></blockquote><p># 如需要修改网络端口IP，可以如下修改：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@node-15:~<span class="comment"># neutron port-list</span></span><br><span class="line">+--------------------------------------+------+-------------------+--------------------------------------------------------------------------------------+</span><br><span class="line">| id                                   | name | mac_address       | fixed_ips                                                                            |</span><br><span class="line">+--------------------------------------+------+-------------------+--------------------------------------------------------------------------------------+</span><br><span class="line">| 03ecb6fc-a695-4151-aef8-87a64c863be3 |      | fa:16:3e:0c:e0:60 | &#123;<span class="string">"subnet_id"</span>: <span class="string">"2f286f76-3532-41ab-81d8-6273ed5a3c6a"</span>, <span class="string">"ip_address"</span>: <span class="string">"172.16.0.132"</span>&#125;  |</span><br><span class="line">| 194d33d5-5184-41cb-9a30-09e580bc4d3f |      | fa:16:3e:1a:20:66 | &#123;<span class="string">"subnet_id"</span>: <span class="string">"5dd3709e-3171-40a5-891c-bc2d73c0a9a0"</span>, <span class="string">"ip_address"</span>: <span class="string">"192.168.111.3"</span>&#125; |</span><br><span class="line">| 29c50618-af2d-401b-bfe3-3ef38d2292c4 |      | fa:16:3e:71:c4:d0 | &#123;<span class="string">"subnet_id"</span>: <span class="string">"2f286f76-3532-41ab-81d8-6273ed5a3c6a"</span>, <span class="string">"ip_address"</span>: <span class="string">"172.16.0.137"</span>&#125;  |</span><br><span class="line">| 2bf7f2e0-3172-4c52-bcc1-40750492bca6 |      | fa:16:3e:ec:8f:87 | &#123;<span class="string">"subnet_id"</span>: <span class="string">"2f286f76-3532-41ab-81d8-6273ed5a3c6a"</span>, <span class="string">"ip_address"</span>: <span class="string">"172.16.0.136"</span>&#125;  |</span><br><span class="line">| 3299792b-07b3-48a0-9213-506034c05744 |      | fa:16:3e:88:ae:10 | &#123;<span class="string">"subnet_id"</span>: <span class="string">"2f286f76-3532-41ab-81d8-6273ed5a3c6a"</span>, <span class="string">"ip_address"</span>: <span class="string">"172.16.0.133"</span>&#125;  |</span><br><span class="line">| 421171b2-1abc-4423-8a46-c9ffa1ad11a0 |      | fa:16:3e:f0:d7:93 | &#123;<span class="string">"subnet_id"</span>: <span class="string">"2f286f76-3532-41ab-81d8-6273ed5a3c6a"</span>, <span class="string">"ip_address"</span>: <span class="string">"172.16.0.138"</span>&#125;  |</span><br><span class="line">| 421682b0-d76c-4d64-8cf7-a62c40733109 |      | fa:16:3e:fa:30:e4 | &#123;<span class="string">"subnet_id"</span>: <span class="string">"956d685c-e7b3-420c-a127-3eedda941e4b"</span>, <span class="string">"ip_address"</span>: <span class="string">"192.168.112.2"</span>&#125; |</span><br><span class="line">| 55b5a275-7db8-4a31-8c84-089af254d3e1 |      | fa:16:3e:28:<span class="built_in">cd</span>:fd | &#123;<span class="string">"subnet_id"</span>: <span class="string">"2f286f76-3532-41ab-81d8-6273ed5a3c6a"</span>, <span class="string">"ip_address"</span>: <span class="string">"172.16.0.135"</span>&#125;  |</span><br><span class="line">| 6948a94a-b90d-4cbd-b8e5-a25ea78fc407 |      | fa:16:3e:17:1f:98 | &#123;<span class="string">"subnet_id"</span>: <span class="string">"2f286f76-3532-41ab-81d8-6273ed5a3c6a"</span>, <span class="string">"ip_address"</span>: <span class="string">"172.16.0.131"</span>&#125;  |</span><br><span class="line">| 70ef22b5-dd3a-4efe-9335-3c67a096fa22 |      | fa:16:3e:78:43:60 | &#123;<span class="string">"subnet_id"</span>: <span class="string">"2f286f76-3532-41ab-81d8-6273ed5a3c6a"</span>, <span class="string">"ip_address"</span>: <span class="string">"172.16.0.140"</span>&#125;  |</span><br><span class="line">| 7c1286e7-e606-46f5-976e-508de1872c8b |      | fa:16:3e:01:20:c4 | &#123;<span class="string">"subnet_id"</span>: <span class="string">"2f286f76-3532-41ab-81d8-6273ed5a3c6a"</span>, <span class="string">"ip_address"</span>: <span class="string">"172.16.0.134"</span>&#125;  |</span><br><span class="line">| 80bb3f49-8cf5-4841-afe1-fa60379bfeef |      | fa:16:3e:a5:14:61 | &#123;<span class="string">"subnet_id"</span>: <span class="string">"5dd3709e-3171-40a5-891c-bc2d73c0a9a0"</span>, <span class="string">"ip_address"</span>: <span class="string">"192.168.111.1"</span>&#125; |</span><br><span class="line">| 99b119c9-5062-48e9-a0f4-55b36c70596f |      | fa:16:3e:<span class="built_in">fc</span>:8e:c9 | &#123;<span class="string">"subnet_id"</span>: <span class="string">"956d685c-e7b3-420c-a127-3eedda941e4b"</span>, <span class="string">"ip_address"</span>: <span class="string">"192.168.112.3"</span>&#125; |</span><br><span class="line">| a7863873-60b7-4372-9cd5-3a8a934a5ace |      | fa:16:3e:2f:23:69 | &#123;<span class="string">"subnet_id"</span>: <span class="string">"2f286f76-3532-41ab-81d8-6273ed5a3c6a"</span>, <span class="string">"ip_address"</span>: <span class="string">"172.16.0.139"</span>&#125;  |</span><br><span class="line">| bc753c4c-ad8b-4a62-aebf-4432e2376db4 |      | fa:16:3e:76:da:b7 | &#123;<span class="string">"subnet_id"</span>: <span class="string">"5dd3709e-3171-40a5-891c-bc2d73c0a9a0"</span>, <span class="string">"ip_address"</span>: <span class="string">"192.168.111.2"</span>&#125; |</span><br><span class="line">| de4bb0a0-24ad-4aa6-9263-665bc9ff633b |      | fa:16:3e:75:c5:00 | &#123;<span class="string">"subnet_id"</span>: <span class="string">"2f286f76-3532-41ab-81d8-6273ed5a3c6a"</span>, <span class="string">"ip_address"</span>: <span class="string">"172.16.0.130"</span>&#125;  |</span><br><span class="line">+--------------------------------------+------+-------------------+--------------------------------------------------------------------------------------+</span><br><span class="line"></span><br><span class="line">root@node-15:~<span class="comment"># neutron port-update 421682b0-d76c-4d64-8cf7-a62c40733109 -- --fixed_ips type=dict list=true ip_address=192.168.112.1</span></span><br><span class="line">Updated port: 421682b0-d76c-4d64-8cf7-a62c40733109</span><br></pre></td></tr></table></figure><h2 id="在Openstack上启动CoreOS集群"><a href="#在Openstack上启动CoreOS集群" class="headerlink" title="在Openstack上启动CoreOS集群"></a>在Openstack上启动CoreOS集群</h2><p># 设置认证权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># cat creds-admin</span></span><br><span class="line"><span class="built_in">export</span> OS_TENANT_NAME=admin</span><br><span class="line"><span class="built_in">export</span> OS_USERNAME=admin</span><br><span class="line"><span class="built_in">export</span> OS_PASSWORD=admin</span><br><span class="line"><span class="built_in">export</span> OS_AUTH_URL=<span class="string">"http://172.16.200.2:5000/v2.0/“</span></span><br></pre></td></tr></table></figure><p># 使认证权限生效</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># . creds-admin</span></span><br></pre></td></tr></table></figure><p># 下载CoreOS镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># wget http://alpha.release.core-os.net/amd64-usr/current/coreos_production_openstack_image.img.bz2</span></span><br></pre></td></tr></table></figure><p># 解压CoreOS镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># bunzip2 coreos_production_openstack_image.img.bz2</span></span><br></pre></td></tr></table></figure><p># 通过glance将镜像导入Openstack中</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># glance image-create --name "CoreOS Stable 410.0.0" \</span></span><br><span class="line">--container-format bare \</span><br><span class="line">--disk-format qcow2 \</span><br><span class="line">--file coreos_production_openstack_image.img \</span><br><span class="line">--is-public True</span><br><span class="line">+------------------+--------------------------------------+</span><br><span class="line">| Property         | Value                                |</span><br><span class="line">+------------------+--------------------------------------+</span><br><span class="line">| checksum         | 2dc4d85f15f1de1c945cd2363418512b     |</span><br><span class="line">| container_format | bare                                 |</span><br><span class="line">| created_at       | 2014-09-03T05:08:26                  |</span><br><span class="line">| deleted          | False                                |</span><br><span class="line">| deleted_at       | None                                 |</span><br><span class="line">| disk_format      | qcow2                                |</span><br><span class="line">| id               | c3c0b86d-b2a6-4129-9bbd-b27fa4f88e06 |</span><br><span class="line">| is_public        | True                                 |</span><br><span class="line">| min_disk         | 0                                    |</span><br><span class="line">| min_ram          | 0                                    |</span><br><span class="line">| name             | CoreOS Stable 410.0.0                |</span><br><span class="line">| owner            | f51b22163f504dd6a6014f4700e9ee48     |</span><br><span class="line">| protected        | False                                |</span><br><span class="line">| size             | 448790528                            |</span><br><span class="line">| status           | active                               |</span><br><span class="line">| updated_at       | 2014-09-03T05:08:41                  |</span><br><span class="line">| virtual_size     | None                                 |</span><br><span class="line">+------------------+--------------------------------------+</span><br></pre></td></tr></table></figure><p># 获取etcd token</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># curl https://discovery.etcd.io/new</span></span><br><span class="line">https://discovery.etcd.io/c964af3ff154db796db834fedae038d4</span><br></pre></td></tr></table></figure><p># 修改cloud-config.yaml文件，填入获取的token和要登录机器的ssh key</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># cat cloud-config.yaml</span></span><br><span class="line"><span class="comment">#cloud-config</span></span><br><span class="line">coreos:</span><br><span class="line">  etcd:</span><br><span class="line">    <span class="comment"># generate a new token for each unique cluster from https://discovery.etcd.io/new</span></span><br><span class="line">    discovery: https://discovery.etcd.io/c964af3ff154db796db834fedae038d4</span><br><span class="line">    <span class="comment"># multi-region and multi-cloud deployments need to use $public_ipv4</span></span><br><span class="line">    addr: <span class="variable">$private_ipv4</span>:4001</span><br><span class="line">    peer-addr: <span class="variable">$private_ipv4</span>:7001</span><br><span class="line">  units:</span><br><span class="line">    - name: etcd.service</span><br><span class="line">      <span class="built_in">command</span>: start</span><br><span class="line">    - name: fleet.service</span><br><span class="line">      <span class="built_in">command</span>: start</span><br><span class="line">ssh_authorized_keys:</span><br><span class="line">  <span class="comment"># include one or more SSH public keys</span></span><br><span class="line">  - ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA2DwT6v5NUUBNBOjC4Z9ZCLLQW0efG+0gpLP5Axi9uslrfCIpVt4MwMktXFegI4eulqATlA+la7pw65MYF8Gm0H9binmqJkDyPilhQkgHltrHOibRww3SddBrQtPddzcD3UPMAWyOiq/3LUhHutMguoKvp2KFoMoakofy6LBsD2xrSnavqycVqw2yb9RDg3c4VVECnVpgDiPPxo8woBWL3PooWZDxEnTqNhm37NXrpRw0xOqLy0x44/1fucwBWpzTXLD2fGLz4JAcgJ8oZHv8hhgadMYMqRRrlYpq0Sx2HiTY/0Co3AzyzQ8kRK0gVLIm3eLE3yzEVEVsa2Bm7LUq4w== root@fuel.example.com</span><br></pre></td></tr></table></figure><p># 以上user-data会通过Openstack Metadata服务注入虚拟机，在虚拟机里访问Metadata接口可以看到注入的用户数据：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># curl http://169.254.169.254/openstack/2012-08-10/user_data</span></span><br><span class="line"><span class="comment">#cloud-config</span></span><br><span class="line">coreos:</span><br><span class="line">  etcd:</span><br><span class="line">    <span class="comment"># generate a new token for each unique cluster from https://discovery.etcd.io/new</span></span><br><span class="line">    discovery: https://discovery.etcd.io/c964af3ff154db796db834fedae038d4</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p># 列出网络信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># nova net-list</span></span><br><span class="line">+--------------------------------------+-----------------+------+</span><br><span class="line">| ID                                   | Label           | CIDR |</span><br><span class="line">+--------------------------------------+-----------------+------+</span><br><span class="line">| 284d3f00-042b-41b2-bec4-f5bc7dcee037 | net_admin       | -    |</span><br><span class="line">| 35030315-0abb-4321-bd2d-fa02ecebe4a4 | net04           | -    |</span><br><span class="line">| 429f5040-ca24-42ff-9260-a5148ff47391 | net_op_leju_com | -    |</span><br><span class="line">| c4448c0d-f633-449a-861a-a39a304cad21 | net04_ext       | -    |</span><br><span class="line">+--------------------------------------+-----------------+------+</span><br></pre></td></tr></table></figure><p># 列出虚拟机规格信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># nova flavor-list</span></span><br><span class="line">+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+</span><br><span class="line">| ID | Name      | Memory_MB | Disk | Ephemeral | Swap | VCPUs | RXTX_Factor | Is_Public |</span><br><span class="line">+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+</span><br><span class="line">| 1  | m1.tiny   | 512       | 1    | 0         |      | 1     | 1.0         | True      |</span><br><span class="line">| 2  | m1.small  | 2048      | 20   | 0         |      | 1     | 1.0         | True      |</span><br><span class="line">| 3  | m1.medium | 4096      | 40   | 0         |      | 2     | 1.0         | True      |</span><br><span class="line">| 4  | m1.large  | 8192      | 80   | 0         |      | 4     | 1.0         | True      |</span><br><span class="line">| 5  | m1.xlarge | 16384     | 160  | 0         |      | 8     | 1.0         | True      |</span><br><span class="line">+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+</span><br></pre></td></tr></table></figure><p># 通过nova boot命令启动三个CoreOS虚拟机实例</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># nova boot \  </span></span><br><span class="line">--user-data ./cloud-config.yaml \  </span><br><span class="line">--image c3c0b86d-b2a6-4129-9bbd-b27fa4f88e06 \  </span><br><span class="line">--key-name fuel \  </span><br><span class="line">--flavor m1.small \  </span><br><span class="line">--num-instances 3 \  </span><br><span class="line">--nic net-id=284d3f00-042b-41b2-bec4-f5bc7dcee037 \  </span><br><span class="line">--security-groups default coreos</span><br><span class="line">+--------------------------------------+--------------------------------------------------------------+</span><br><span class="line">| Property                             | Value                                                        |</span><br><span class="line">+--------------------------------------+--------------------------------------------------------------+</span><br><span class="line">| OS-DCF:diskConfig                    | MANUAL                                                       |</span><br><span class="line">| OS-EXT-AZ:availability_zone          | nova                                                         |</span><br><span class="line">| OS-EXT-SRV-ATTR:host                 | -                                                            |</span><br><span class="line">| OS-EXT-SRV-ATTR:hypervisor_hostname  | -                                                            |</span><br><span class="line">| OS-EXT-SRV-ATTR:instance_name        | instance-00000031                                            |</span><br><span class="line">| OS-EXT-STS:power_state               | 0                                                            |</span><br><span class="line">| OS-EXT-STS:task_state                | scheduling                                                   |</span><br><span class="line">| OS-EXT-STS:vm_state                  | building                                                     |</span><br><span class="line">| OS-SRV-USG:launched_at               | -                                                            |</span><br><span class="line">| OS-SRV-USG:terminated_at             | -                                                            |</span><br><span class="line">| accessIPv4                           |                                                              |</span><br><span class="line">| accessIPv6                           |                                                              |</span><br><span class="line">| adminPass                            | UWDaX8vxvzZn                                                 |</span><br><span class="line">| config_drive                         |                                                              |</span><br><span class="line">| created                              | 2014-09-03T06:14:10Z                                         |</span><br><span class="line">| flavor                               | m1.small (2)                                                 |</span><br><span class="line">| hostId                               |                                                              |</span><br><span class="line">| id                                   | a51d1492-9352-4979-8049-6e089af4fa65                         |</span><br><span class="line">| image                                | CoreOS Stable 410.0.0 (c3c0b86d-b2a6-4129-9bbd-b27fa4f88e06) |</span><br><span class="line">| key_name                             | fuel                                                         |</span><br><span class="line">| metadata                             | &#123;&#125;                                                           |</span><br><span class="line">| name                                 | coreos-a51d1492-9352-4979-8049-6e089af4fa65                  |</span><br><span class="line">| os-extended-volumes:volumes_attached | []                                                           |</span><br><span class="line">| progress                             | 0                                                            |</span><br><span class="line">| security_groups                      | default                                                      |</span><br><span class="line">| status                               | BUILD                                                        |</span><br><span class="line">| tenant_id                            | f51b22163f504dd6a6014f4700e9ee48                             |</span><br><span class="line">| updated                              | 2014-09-03T06:14:10Z                                         |</span><br><span class="line">| user_id                              | 8ad92b9cf95c4468b7718bbce22a39e0                             |</span><br><span class="line">+--------------------------------------+--------------------------------------------------------------+</span><br></pre></td></tr></table></figure><p># 列出浮动IP地址</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># nova floating-ip-list</span></span><br><span class="line">+----------------+-----------+----------------+-----------+</span><br><span class="line">| Ip             | Server Id | Fixed Ip       | Pool      |</span><br><span class="line">+----------------+-----------+----------------+-----------+</span><br><span class="line">| 172.16.200.138 |           | -              | net04_ext |</span><br><span class="line">| 172.16.200.134 |           | -              | net04_ext |</span><br><span class="line">| 172.16.200.137 |           | -              | net04_ext |</span><br><span class="line">| 172.16.200.135 |           | -              | net04_ext |</span><br><span class="line">| 172.16.200.131 |           | -              | net04_ext |</span><br><span class="line">| 172.16.200.132 |           | -              | net04_ext |</span><br><span class="line">| 172.16.200.136 |           | -              | net04_ext |</span><br><span class="line">| 172.16.200.139 |           | -              | net04_ext |</span><br><span class="line">| 172.16.200.133 |           | -              | net04_ext |</span><br><span class="line">| 172.16.200.140 |           | -              | net04_ext |</span><br><span class="line">+----------------+-----------+----------------+-----------+</span><br></pre></td></tr></table></figure><p># 列出虚拟机</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># nova list</span></span><br><span class="line">+--------------------------------------+---------------------------------------------+--------+------------+-------------+------------------------------------------+</span><br><span class="line">| ID                                   | Name                                        | Status | Task State | Power State | Networks                                 |</span><br><span class="line">+--------------------------------------+---------------------------------------------+--------+------------+-------------+------------------------------------------+</span><br><span class="line">| 3198baad-9a01-469f-af5b-13665b01c7f0 | coreos-3198baad-9a01-469f-af5b-13665b01c7f0 | ACTIVE | -          | Running     | net_admin=192.168.101.22                 |</span><br><span class="line">| 71a03186-1327-4608-bd66-b59f6c49c85c | coreos-71a03186-1327-4608-bd66-b59f6c49c85c | ACTIVE | -          | Running     | net_admin=192.168.101.23                 |</span><br><span class="line">| a51d1492-9352-4979-8049-6e089af4fa65 | coreos-a51d1492-9352-4979-8049-6e089af4fa65 | ACTIVE | -          | Running     | net_admin=192.168.101.21                 |</span><br><span class="line">| e2a5901b-cfd7-41d7-bd7f-f8e4e18cfc0f | vm_centos_7                                 | ACTIVE | -          | Running     | net04=192.168.100.12, 172.16.200.134     |</span><br><span class="line">+--------------------------------------+---------------------------------------------+--------+------------+-------------+------------------------------------------+</span><br></pre></td></tr></table></figure><p># 为虚拟机绑定浮动IP</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># nova add-floating-ip coreos-a51d1492-9352-4979-8049-6e089af4fa65 172.16.200.131</span></span><br><span class="line">[root@node-9 ~]<span class="comment"># nova add-floating-ip coreos-3198baad-9a01-469f-af5b-13665b01c7f0 172.16.200.132</span></span><br><span class="line">[root@node-9 ~]<span class="comment"># nova add-floating-ip coreos-71a03186-1327-4608-bd66-b59f6c49c85c 172.16.200.133</span></span><br></pre></td></tr></table></figure><p># 界面中查看虚拟机情况</p><p><img src="/images/14-09-10/openstack_coreos.png" alt="Openstack CoreOS"></p><p># 通过浮动IP登录CoreOS虚拟机</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@fuel ~]<span class="comment"># ssh core@172.16.200.131</span></span><br><span class="line">CoreOS (stable)</span><br><span class="line">core@coreos-a51d1492-9352-4979-8049-6e089af4fa65 ~ $ sudo su -</span><br><span class="line">coreos-a51d1492-9352-4979-8049-6e089af4fa65 ~ <span class="comment">#</span></span><br></pre></td></tr></table></figure><h2 id="强制删除非正常状态的卷"><a href="#强制删除非正常状态的卷" class="headerlink" title="强制删除非正常状态的卷"></a>强制删除非正常状态的卷</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># . creds-admin</span></span><br><span class="line">[root@node-9 ~]<span class="comment"># cinder list</span></span><br><span class="line">+--------------------------------------+----------+----------------------------+------+-------------+----------+--------------------------------------+</span><br><span class="line">|                  ID                  |  Status  |        Display Name        | Size | Volume Type | Bootable |             Attached to              |</span><br><span class="line">+--------------------------------------+----------+----------------------------+------+-------------+----------+--------------------------------------+</span><br><span class="line">| 2f1219c1-9081-4a1e-ac4f-3b9e77b71bbb | creating | ost1_test-volume1530754005 |  1   |     None    |  <span class="literal">false</span>   |                                      |</span><br><span class="line">| 524bb475-d63f-4479-9a94-4d7eef87cf9a | creating |        domino_data         |  3   |     None    |  <span class="literal">false</span>   |                                      |</span><br><span class="line">| 937fedef-f9c0-4d8c-aca8-fc1aa6de27ab | creating |          vd_test           |  10  |     None    |  <span class="literal">false</span>   |                                      |</span><br><span class="line">| fcfc1fb1-5884-4ed9-a0f7-dd084c953ce4 |  <span class="keyword">in</span>-use  |       vd_domino_test       |  3   |     None    |   <span class="literal">true</span>   | b46e1c74-f442-41ae-b480-fdd4d376dca5 |</span><br><span class="line">+--------------------------------------+----------+----------------------------+------+-------------+----------+--------------------------------------+</span><br><span class="line"></span><br><span class="line">[root@node-9 ~]<span class="comment"># cinder reset-state --state available 937fedef-f9c0-4d8c-aca8-fc1aa6de27ab</span></span><br><span class="line">[root@node-9 ~]<span class="comment"># cinder delete 937fedef-f9c0-4d8c-aca8-fc1aa6de27ab</span></span><br><span class="line">[root@node-9 ~]<span class="comment"># cinder list</span></span><br><span class="line">+--------------------------------------+----------+----------------------------+------+-------------+----------+--------------------------------------+</span><br><span class="line">|                  ID                  |  Status  |        Display Name        | Size | Volume Type | Bootable |             Attached to              |</span><br><span class="line">+--------------------------------------+----------+----------------------------+------+-------------+----------+--------------------------------------+</span><br><span class="line">| 2f1219c1-9081-4a1e-ac4f-3b9e77b71bbb | creating | ost1_test-volume1530754005 |  1   |     None    |  <span class="literal">false</span>   |                                      |</span><br><span class="line">| 524bb475-d63f-4479-9a94-4d7eef87cf9a | creating |        domino_data         |  3   |     None    |  <span class="literal">false</span>   |                                      |</span><br><span class="line">| fcfc1fb1-5884-4ed9-a0f7-dd084c953ce4 |  <span class="keyword">in</span>-use  |       vd_domino_test       |  3   |     None    |   <span class="literal">true</span>   | b46e1c74-f442-41ae-b480-fdd4d376dca5 |</span><br><span class="line">+--------------------------------------+----------+----------------------------+------+-------------+----------+--------------------------------------+</span><br></pre></td></tr></table></figure><h2 id="强制删除ERROR状态的虚拟机"><a href="#强制删除ERROR状态的虚拟机" class="headerlink" title="强制删除ERROR状态的虚拟机"></a>强制删除ERROR状态的虚拟机</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[root@node-9 ~]<span class="comment"># nova list</span></span><br><span class="line">+--------------------------------------+--------------+--------+------------+-------------+----------------------------------------------+</span><br><span class="line">| ID                                   | Name         | Status | Task State | Power State | Networks                                     |</span><br><span class="line">+--------------------------------------+--------------+--------+------------+-------------+----------------------------------------------+</span><br><span class="line">| c915770b-b2d3-4196-bb68-fc19aa2a6da9 | vm_cirros_op | ERROR  | deleting   | Shutdown    | net_op_leju_com=172.16.102.4, 172.16.200.142 |</span><br><span class="line">+--------------------------------------+--------------+--------+------------+-------------+----------------------------------------------+</span><br><span class="line"></span><br><span class="line">[root@node-9 ~]<span class="comment"># nova reset-state --active c915770b-b2d3-4196-bb68-fc19aa2a6da9</span></span><br><span class="line">[root@node-9 ~]<span class="comment"># nova show c915770b-b2d3-4196-bb68-fc19aa2a6da9</span></span><br><span class="line">+--------------------------------------+----------------------------------------------------------+</span><br><span class="line">| Property                             | Value                                                    |</span><br><span class="line">+--------------------------------------+----------------------------------------------------------+</span><br><span class="line">| OS-DCF:diskConfig                    | AUTO                                                     |</span><br><span class="line">| OS-EXT-AZ:availability_zone          | nova                                                     |</span><br><span class="line">| OS-EXT-SRV-ATTR:host                 | node-11.example.com                                         |</span><br><span class="line">| OS-EXT-SRV-ATTR:hypervisor_hostname  | node-11.example.com                                         |</span><br><span class="line">| OS-EXT-SRV-ATTR:instance_name        | instance-00000014                                        |</span><br><span class="line">| OS-EXT-STS:power_state               | 4                                                        |</span><br><span class="line">| OS-EXT-STS:task_state                | -                                                        |</span><br><span class="line">| OS-EXT-STS:vm_state                  | active                                                   |</span><br><span class="line">| OS-SRV-USG:launched_at               | 2014-09-02T07:46:46.000000                               |</span><br><span class="line">| OS-SRV-USG:terminated_at             | -                                                        |</span><br><span class="line">| accessIPv4                           |                                                          |</span><br><span class="line">| accessIPv6                           |                                                          |</span><br><span class="line">| config_drive                         |                                                          |</span><br><span class="line">| created                              | 2014-09-02T07:46:38Z                                     |</span><br><span class="line">| flavor                               | m1.tiny (1)                                              |</span><br><span class="line">| hostId                               | b51d791c8cc535dc723deed170df51ca5c415932f01b2c6b3fb67508 |</span><br><span class="line">| id                                   | c915770b-b2d3-4196-bb68-fc19aa2a6da9                     |</span><br><span class="line">| image                                | TestVM (722f1732-8a7a-4024-bd99-e039c2681360)            |</span><br><span class="line">| key_name                             | fuel                                                     |</span><br><span class="line">| metadata                             | &#123;&#125;                                                       |</span><br><span class="line">| name                                 | vm_cirros_op                                             |</span><br><span class="line">| net_op_leju_com network              | 172.16.102.4, 172.16.200.142                             |</span><br><span class="line">| os-extended-volumes:volumes_attached | []                                                       |</span><br><span class="line">| progress                             | 0                                                        |</span><br><span class="line">| status                               | ACTIVE                                                   |</span><br><span class="line">| tenant_id                            | 2e8def45720343fb9d648bd561a99c06                         |</span><br><span class="line">| updated                              | 2014-09-12T03:39:08Z                                     |</span><br><span class="line">| user_id                              | 181390a3b29d4e3fa9938aa7d65bb0b3                         |</span><br><span class="line">+--------------------------------------+----------------------------------------------------------+</span><br><span class="line"></span><br><span class="line">[root@node-9 ~]<span class="comment"># nova delete c915770b-b2d3-4196-bb68-fc19aa2a6da9</span></span><br><span class="line">[root@node-9 ~]<span class="comment"># nova list</span></span><br><span class="line">+----+------+--------+------------+-------------+----------+</span><br><span class="line">| ID | Name | Status | Task State | Power State | Networks |</span><br><span class="line">+----+------+--------+------------+-------------+----------+</span><br><span class="line">+----+------+--------+------------+-------------+----------+</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      OpenStack作为基础设施即服务（简称IaaS）资源的通用前端。首要任务是简化云的部署过程并为其带来良好的可扩展性。本文希望通过提供必要的指导信息，帮助大家利用OpenStack前端来设置及管理自己的私有云。
    
    </summary>
    
      <category term="虚拟化" scheme="https://istone.dev/categories/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
    
      <category term="Openstack" scheme="https://istone.dev/tags/Openstack/"/>
    
      <category term="KVM" scheme="https://istone.dev/tags/KVM/"/>
    
      <category term="Ceph" scheme="https://istone.dev/tags/Ceph/"/>
    
      <category term="CoreOS" scheme="https://istone.dev/tags/CoreOS/"/>
    
  </entry>
  
  <entry>
    <title>Openstack 安装</title>
    <link href="https://istone.dev/2014/09/10/openstack-install/"/>
    <id>https://istone.dev/2014/09/10/openstack-install/</id>
    <published>2014-09-10T02:00:00.000Z</published>
    <updated>2019-06-26T09:57:40.901Z</updated>
    
    <content type="html"><![CDATA[<p>OpenStack 是由 Rackspace 和 NASA 共同开发的云计算平台，帮助服务商和企业内部实现类似于 Amazon EC2 和 S3 的云基础架构服务(Infrastructure as a Service, IaaS)。OpenStack 包含两个主要模块：Nova 和 Swift，前者是 NASA 开发的虚拟服务器部署和业务计算模块；后者是Rackspace开发的分布式云存储模块，两者可以一起用，也可以分开单独用。OpenStack 是开源项目，除了有 Rackspace 和 NASA 的大力支持外，后面还有包括 Dell、Citrix、 Cisco、 Canonical 这些重量级公司的贡献和支持，发展速度非常快。</p><p>Openstack集群搭建使用5台机器，一台Fuel管理机，一台Controller，一台Compute，两台Storage。这是一个最小化的安装，安装完成后可以对集群进行扩容。</p><h2 id="1-网络环境准备"><a href="#1-网络环境准备" class="headerlink" title="1. 网络环境准备"></a>1. 网络环境准备</h2><p>网络规划：</p><ul><li>Floating/Public 网络 172.16.200.0/24 in VLAN 100 (untagged on servers) • Floating IP range 172.16.200.130 - 254  # 用于集群公网和虚拟机浮动IP，需要能与外网通信</li><li>Internal network (private) 192.168.100.0/24  # 用于虚拟机间通信</li><li>Gateway 192.168.100.1  # 虚拟机的网关地址</li><li>DNS 8.8.4.4, 8.8.8.8  # DNS地址</li><li>Management network 192.168.0.0/24 in VLAN 501 # 管理网络</li><li>Storage network 192.168.1.0/24 in VLAN 502  # 存储网络</li><li>Administrative network (for Fuel) 10.20.0.0/24 in VLAN 503  # Fuel集群管理网络</li></ul><p>服务器网卡配置：</p><p>Fuel管理节点（Openstack集群管理）：</p><ul><li>eth0 10.20.0.2 — 插到交换机5 - 10口上</li><li>eth1 172.16.200.128  — 插到交换机11 - 16口上</li></ul><p>控制节点，计算节点，存储节点：</p><ul><li>eth0  10.20.0.0/24   — 插到交换机5 - 10口上</li><li>eth1 公有网络172.16.200.0/24，管理网络192.168.0.0/24， 存储网络192.168.1.0/24  — 插到交换机11 - 16口上</li><li>eth2 私有网络，192.168.100.0/24  — 插到交换机17 - 21口上</li></ul><p>使用一台Cisco 2960交换机，配置如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">switch<span class="comment">#configure t</span></span><br><span class="line">Enter configuration commands, one per line.  End with CNTL/Z.</span><br><span class="line">switch(config)<span class="comment">#vlan 500</span></span><br><span class="line">switch(config-vlan)<span class="comment">#name cloud_public</span></span><br><span class="line">switch(config-vlan)<span class="comment">#exit</span></span><br><span class="line">switch(config)<span class="comment">#vlan 501</span></span><br><span class="line">switch(config-vlan)<span class="comment">#name cloud_management</span></span><br><span class="line">switch(config-vlan)<span class="comment">#exit</span></span><br><span class="line">switch(config)<span class="comment">#vlan 502</span></span><br><span class="line">switch(config-vlan)<span class="comment">#name cloud_storage</span></span><br><span class="line">switch(config-vlan)<span class="comment">#exit</span></span><br><span class="line">switch(config)<span class="comment">#vlan 503</span></span><br><span class="line">switch(config-vlan)<span class="comment">#name cloud_admin</span></span><br><span class="line">switch(config-vlan)<span class="comment">#exit</span></span><br><span class="line">switch(config)<span class="comment">#vlan 510-530</span></span><br><span class="line">switch(config-vlan)<span class="comment">#exit</span></span><br><span class="line">switch(config)<span class="comment">#interface range gigabitethernet1/0/5 - 10</span></span><br><span class="line">switch(config-if-range)<span class="comment">#switchport access vlan 503</span></span><br><span class="line">switch(config-if-range)<span class="comment">#switchport mode access</span></span><br><span class="line">switch(config-if-range)<span class="comment">#spanning-tree portfast</span></span><br><span class="line">switch(config-if-range)<span class="comment">#no shut</span></span><br><span class="line">switch(config-if-range)<span class="comment">#exit</span></span><br><span class="line">switch(config)<span class="comment">#interface range gigabitethernet1/0/11 - 16</span></span><br><span class="line">switch(config-if-range)<span class="comment">#switchport trunk native vlan 500</span></span><br><span class="line">switch(config-if-range)<span class="comment">#switchport trunk allowed vlan 500-503</span></span><br><span class="line">switch(config-if-range)<span class="comment">#switchport mode trunk</span></span><br><span class="line">switch(config-if-range)<span class="comment">#no shut</span></span><br><span class="line">switch(config-if-range)<span class="comment">#spanning-tree portfast trunk</span></span><br><span class="line">%Warning: portfast should only be enabled on ports connected to a single</span><br><span class="line"> host. Connecting hubs, concentrators, switches, bridges, etc... to this</span><br><span class="line"> interface  when portfast is enabled, can cause temporary bridging loops.</span><br><span class="line"> Use with CAUTION</span><br><span class="line"></span><br><span class="line">switch(config-if-range)<span class="comment">#exit</span></span><br><span class="line">switch(config)<span class="comment">#interface range gigabitethernet1/0/17 - 22</span></span><br><span class="line">switch(config-if-range)<span class="comment">#switchport trunk allowed vlan 510-530</span></span><br><span class="line">switch(config-if-range)<span class="comment">#switchport mode trunk</span></span><br><span class="line">switch(config-if-range)<span class="comment">#no shut</span></span><br><span class="line">switch(config-if-range)<span class="comment">#spanning-tree portfast trunk</span></span><br><span class="line">switch(config-if-range)<span class="comment">#exit</span></span><br><span class="line"></span><br><span class="line">switch<span class="comment">#copy running-config startup-config</span></span><br></pre></td></tr></table></figure><h2 id="2-Fuel管理节点安装"><a href="#2-Fuel管理节点安装" class="headerlink" title="2. Fuel管理节点安装"></a>2. Fuel管理节点安装</h2><p>从Mirantis下载镜像：<a href="https://software.mirantis.com/，本次安装使用MirantisOpenStack-5.0.1.iso镜像。" target="_blank" rel="noopener">https://software.mirantis.com/，本次安装使用MirantisOpenStack-5.0.1.iso镜像。</a></p><p>通过远程管理卡进行安装，打开虚拟介质，挂载下载好的镜像，从虚拟镜像启动服务器。</p><p>到如下界面时按tab键，修改参数，hostname改为你的主机名，showmenu改为yes，回车继续：</p><p><img src="/images/14-09-10/openstack_k.png" alt="Openstack Fuel内核参数设置"></p><p>到如下界面，设置网络、PXE启动、DNS&amp;主机名、root密码等，网络配置界面，每配置一块网卡都需要Apply，然后再配置下一块网卡，都配置完成后保存退出。</p><p><img src="/images/14-09-10/openstack_fuel_setting.png" alt="Openstack Fuel设置"></p><p>安装完成后通过浏览访问<a href="http://10.20.0.2:8000/#clusters，点击新建Openstack环境，填写名称，并选择Openstack版本，然后点前进。" target="_blank" rel="noopener">http://10.20.0.2:8000/#clusters，点击新建Openstack环境，填写名称，并选择Openstack版本，然后点前进。</a></p><p><img src="/images/14-09-10/openstack_env_1.png" alt="新建Openstack环境1"></p><p>选择部署模式，本文使用多节点，非HA模式，然后点前进。</p><p><img src="/images/14-09-10/openstack_env_2.png" alt="新建Openstack环境2"></p><p>选择虚拟化管理器类型，本文选择KVM，然后点前进。</p><p><img src="/images/14-09-10/openstack_env_3.png" alt="新建Openstack环境3"></p><p>选择网络模式，本文选择Neutron VLAN模式，然后点前进。</p><p><img src="/images/14-09-10/openstack_env_4.png" alt="新建Openstack环境4"></p><p>选择存储类型，本文使用Ceph做后端存储，然后点前进。</p><p><img src="/images/14-09-10/openstack_env_5.png" alt="新建Openstack环境5"></p><p>附加服务，不选择，直接点前进。</p><p><img src="/images/14-09-10/openstack_env_6.png" alt="新建Openstack环境6"></p><p>点击完成，完成环境设置。</p><p><img src="/images/14-09-10/openstack_env_7.png" alt="新建Openstack环境7"></p><h2 id="3-Openstack部署"><a href="#3-Openstack部署" class="headerlink" title="3. Openstack部署"></a>3. Openstack部署</h2><p>启动各节点设置磁盘Raid：</p><p>控制节点和计算节点使用Raid 5；存储节点两块磁盘做Raid 1，剩下四块磁盘做单盘Raid 0（每块磁盘启动一个Ceph进程，以保证性能）。</p><p>计算节点需要在BIOS中打开虚拟化选项，否则在创建虚拟机时会报如下错误：</p><pre><code>Error: No valid host was found.</code></pre><p>查看Nova日志中有如下报错：</p><pre><code>libvirtError: internal error no supported architecture for os type ‘hvm&apos;</code></pre><p>配置完成后从网卡启动服务器，启动完成后，回到管理界面，四台服务器已经被发现。</p><p>点击 网络 选选卡，对网络进行如下配置：</p><p><img src="/images/14-09-10/openstack_network_1.png" alt="Openstack网络设置1"></p><p><img src="/images/14-09-10/openstack_network_2.png" alt="Openstack网络设置2"></p><p><img src="/images/14-09-10/openstack_network_3.png" alt="Openstack网络设置3"></p><p>修改完成后点 保存设置，然后点 验证网络，如果网络配置正确会显示验证成功。</p><p>点击 设置 选项卡，如下进行设置：</p><p><img src="/images/14-09-10/openstack_setting_1.png" alt="Openstack设置1"></p><p>勾选Nova quotas，这样可以对虚拟资源做配额。</p><p><img src="/images/14-09-10/openstack_setting_2.png" alt="Openstack设置2"></p><p>CentOS 6.5 需要设置OVS VLAN splinters特性。</p><p><img src="/images/14-09-10/openstack_setting_3.png" alt="Openstack设置3"></p><p>存储勾选以上四个选项，其中 Ceph RBD选项运行虚拟机进行热迁移，完成后点 保存设置。</p><p>以上设置完成后，点击 节点 选项卡，然后点 增加节点。</p><p><img src="/images/14-09-10/openstack_addnode_1.png" alt="Openstack添加节点1"></p><p>依次选择控制节点、计算节点、和存储节点。</p><p><img src="/images/14-09-10/openstack_addnode_2_compute.png" alt="Openstack添加节点2"></p><p><img src="/images/14-09-10/openstack_addnode_3_storage_ceph_osd.png" alt="Openstack添加节点3"></p><p>选择完成后配置各角色 磁盘，以存储节点为例：</p><p><img src="/images/14-09-10/openstack_dist_1.png" alt="Openstack磁盘1"></p><p><img src="/images/14-09-10/openstack_dist_2.png" alt="Openstack磁盘2"></p><p><img src="/images/14-09-10/openstack_dist_3.png" alt="Openstack磁盘3"></p><p>配置各角色 网络，以存储节点为例：</p><p><img src="/images/14-09-10/openstack_network_1.png" alt="Openstack网络1"></p><p><img src="/images/14-09-10/openstack_network_2.png" alt="Openstack网络2"></p><p><img src="/images/14-09-10/openstack_network_3.png" alt="Openstack网络3"></p><p>根据上图配置网络，配置完成后返回 节点 选项卡，点 部署变更，开始部署节点：</p><p>部署操作系统：</p><p><img src="/images/14-09-10/openstack_dist_1.png" alt="Openstack部署1"></p><p>部署Openstack：</p><p><img src="/images/14-09-10/openstack_dist_2.png" alt="Openstack部署2"></p><p>完成部署：</p><p><img src="/images/14-09-10/openstack_dist_3.png" alt="Openstack部署3"></p><p>可以点击日志选项卡，查看安装日志；点击健康检查选项卡进行健康检查：</p><p><img src="/images/14-09-10/openstack_h.png" alt="Openstack健康检查"></p><p>访问Openstack 管理控制台<a href="http://10.20.0.10/：" target="_blank" rel="noopener">http://10.20.0.10/：</a></p><p><img src="/images/14-09-10/openstack_c.png" alt="Openstack控制台"></p><h2 id="4-参考文档"><a href="#4-参考文档" class="headerlink" title="4. 参考文档"></a>4. 参考文档</h2><ul><li><a href="http://ceph.com/cloud/ceph-and-mirantis-openstack/" target="_blank" rel="noopener">Ceph and Mirantis OpenStack</a></li><li><a href="http://docs.mirantis.com/openstack/fuel/fuel-5.0/" target="_blank" rel="noopener">Mirantis OpenStack Documentation</a></li></ul>]]></content>
    
    <summary type="html">
    
      Openstack集群搭建使用5台机器，一台Fuel管理机，一台Controller，一台Compute，两台Storage。这是一个最小化的安装，安装完成后可以对集群进行扩容。
    
    </summary>
    
      <category term="虚拟化" scheme="https://istone.dev/categories/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
    
      <category term="Openstack" scheme="https://istone.dev/tags/Openstack/"/>
    
      <category term="KVM" scheme="https://istone.dev/tags/KVM/"/>
    
      <category term="Ceph" scheme="https://istone.dev/tags/Ceph/"/>
    
  </entry>
  
  <entry>
    <title>Saltstack：Salt模块的扩展</title>
    <link href="https://istone.dev/2014/06/17/saltstack-expand/"/>
    <id>https://istone.dev/2014/06/17/saltstack-expand/</id>
    <published>2014-06-17T02:00:00.000Z</published>
    <updated>2019-06-26T10:05:27.440Z</updated>
    
    <content type="html"><![CDATA[<p>对Salt进行模块化设计就是为了扩展，另外将变量抽象出来放到pillar中也是为了模块可以重用。当你需要配置两个web平台，而这两个平台又有些许不同时你该怎么办？需要重新再写个nginx模块适配新的平台吗？</p><p>对于上面问题的回答是否定的，我们无需再重新写一个nginx模块，我们只需要对新的平台传递新的配置文件或者使用同一个模板传递不同的参数。</p><h4 id="使用不同的配置文件"><a href="#使用不同的配置文件" class="headerlink" title="使用不同的配置文件"></a>使用不同的配置文件</h4><p>当两个平台配置相差比较大时可能传递一个不同的配置文件会更合适，如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">/etc/rsyncd.conf:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://rsync/files/etc/&#123;&#123;salt['pillar.get']('rsync_template',</span> <span class="string">'rsyncd.conf'</span><span class="string">)&#125;&#125;</span></span><br><span class="line"><span class="attr">    - template:</span> <span class="string">jinja</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br></pre></td></tr></table></figure><p>为不同的节点在pillar中配置不同的rsync_template变量即可。</p><h4 id="使用同一个模板传递不同的参数"><a href="#使用同一个模板传递不同的参数" class="headerlink" title="使用同一个模板传递不同的参数"></a>使用同一个模板传递不同的参数</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">/etc/keepalived/keepalived.conf:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://keepalived/files/etc/keepalived/keepalived.conf</span></span><br><span class="line"><span class="attr">    - template:</span> <span class="string">jinja</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br></pre></td></tr></table></figure><p>对于主服务器(/srv/salt/pillar/nodes/ha1.sls )使用如下pillar变量：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">keepalived:</span></span><br><span class="line"><span class="attr">  notification_email:</span> <span class="string">'dongliang@mall.com'</span></span><br><span class="line"><span class="attr">  notification_email_from:</span> <span class="string">'haproxy@mall.com'</span></span><br><span class="line"><span class="attr">  smtp_server:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="attr">  state:</span> <span class="string">MASTER</span></span><br><span class="line"><span class="attr">  priority:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">  auth_type:</span> <span class="string">PASS</span></span><br><span class="line"><span class="attr">  auth_pass:</span> <span class="string">mall</span></span><br><span class="line"><span class="attr">  virtual_ipaddress_internal:</span> <span class="number">172.16</span><span class="number">.100</span><span class="number">.100</span></span><br><span class="line"><span class="attr">  virtual_ipaddress_external:</span> <span class="number">60.60</span><span class="number">.60</span><span class="number">.100</span></span><br></pre></td></tr></table></figure><p>对于从服务器(/srv/salt/pillar/nodes/ha2.sls )使用如下pillar变量：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">keepalived:</span></span><br><span class="line"><span class="attr">  notification_email:</span> <span class="string">'dongliang@mall.com'</span></span><br><span class="line"><span class="attr">  notification_email_from:</span> <span class="string">'haproxy@mall.com'</span></span><br><span class="line"><span class="attr">  smtp_server:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="attr">  state:</span> <span class="string">BACKUP</span></span><br><span class="line"><span class="attr">  priority:</span> <span class="number">99</span></span><br><span class="line"><span class="attr">  auth_type:</span> <span class="string">PASS</span></span><br><span class="line"><span class="attr">  auth_pass:</span> <span class="string">mall</span></span><br><span class="line"><span class="attr">  virtual_ipaddress_internal:</span> <span class="number">172.16</span><span class="number">.100</span><span class="number">.100</span></span><br><span class="line"><span class="attr">  virtual_ipaddress_external:</span> <span class="number">60.60</span><span class="number">.60</span><span class="number">.100</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      本文以一个小的电商网站（www.mall.com）为例，讲述Saltstack在真实场景中的应用。
    
    </summary>
    
      <category term="Saltstack" scheme="https://istone.dev/categories/Saltstack/"/>
    
    
      <category term="devops" scheme="https://istone.dev/tags/devops/"/>
    
      <category term="saltstack" scheme="https://istone.dev/tags/saltstack/"/>
    
      <category term="salt" scheme="https://istone.dev/tags/salt/"/>
    
  </entry>
  
  <entry>
    <title>Saltstack：自动化监控</title>
    <link href="https://istone.dev/2014/06/16/saltstack-zabbix-monitor/"/>
    <id>https://istone.dev/2014/06/16/saltstack-zabbix-monitor/</id>
    <published>2014-06-16T02:00:00.000Z</published>
    <updated>2019-06-26T10:11:49.337Z</updated>
    
    <content type="html"><![CDATA[<p>本节参考了<a href="http://pengyao.org/" target="_blank" rel="noopener">绿肥</a>的《记saltstack和zabbix的一次联姻》，对zabbix添加监控脚本（add_monitors.py）进行部分修改而成，此脚本基于@超大杯摩卡星冰乐 同学的zapi进行更高级别的封装而成，在此表示感谢。</p><p>自动化监控的过程如下：</p><ol><li>通过Saltstack部署Zabbix server、Zabbix web、Zabbix api；</li><li>完成安装后需要手动导入Zabbix监控模板；</li><li>通过Saltstack部署服务及Zabbix agent；</li><li>Saltstack在安装完服务后通过Salt Mine将服务角色汇报给Salt Master；</li><li>Zabbix api拿到各服务角色后添加相应监控到Zabbix server。</li></ol><p><a href="http://docs.saltstack.com/en/latest/ref/modules/all/salt.modules.mine.html" target="_blank" rel="noopener">Salt Mine</a>用于将Salt Minion的信息存储到Salt Master，供其他Salt Minion使用。</p><p>下面以对nginx模块的监控为例讲述整个监控过程，其中Zabbix服务（Zabbix server、Zabbix web、Zabbix api）安装使用/srv/salt/zabbix进行管理，服务部署在admin.grid.mall.com上。Zabbix agent使用/srv/salt/zabbix进行管理。nginx使用/srv/salt/nginx模块进行管理。</p><p>安装完nginx和php后定义相应的角色：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nginx-role:</span></span><br><span class="line">  <span class="string">file.append:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/salt/roles</span></span><br><span class="line"><span class="attr">    - text:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'nginx'</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">roles</span></span><br><span class="line"><span class="attr">      - service:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      - service:</span> <span class="string">salt-minion</span></span><br><span class="line"><span class="attr">    - watch_in:</span></span><br><span class="line"><span class="attr">      - module:</span> <span class="string">sync_grains</span></span><br><span class="line"></span><br><span class="line"><span class="attr">php-fpm-role:</span>  <span class="comment"># 定义php-fpm角色</span></span><br><span class="line">  <span class="string">file.append:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/salt/roles</span></span><br><span class="line"><span class="attr">    - text:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'php-fpm'</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">roles</span></span><br><span class="line"><span class="attr">      - service:</span> <span class="string">php-fpm</span></span><br><span class="line"><span class="attr">      - service:</span> <span class="string">salt-minion</span></span><br><span class="line"><span class="attr">    - watch_in:</span></span><br><span class="line"><span class="attr">      - module:</span> <span class="string">sync_grains</span></span><br></pre></td></tr></table></figure><p>/srv/salt/nginx/monitor.sls用于配置zabbix agent和监控脚本：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">zabbix.agent</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line"><span class="attr">nginx-monitor:</span></span><br><span class="line">  <span class="string">pkg.installed:</span>  <span class="comment"># 安装脚本依赖的软件包</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">perl-libwww-perl</span></span><br><span class="line"></span><br><span class="line"><span class="attr">php-fpm-monitor-script:</span>  <span class="comment"># 管理监控脚本，如果脚本存放目录不存在自动创建</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/zabbix/ExternalScripts/php-fpm_status.pl</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://nginx/files/etc/zabbix/ExternalScripts/php-fpm_status.pl</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">755</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - service:</span> <span class="string">php-fpm</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">nginx-monitor</span></span><br><span class="line"><span class="attr">      - cmd:</span> <span class="string">php-fpm-monitor-script</span></span><br><span class="line">  <span class="string">cmd.run:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">mkdir</span> <span class="bullet">-p</span> <span class="string">/etc/zabbix/ExternalScripts</span></span><br><span class="line"><span class="attr">    - unless:</span> <span class="string">test</span> <span class="bullet">-d</span> <span class="string">/etc/zabbix/ExternalScripts</span></span><br><span class="line"></span><br><span class="line"><span class="attr">php-fpm-monitor-config:</span>  <span class="comment"># 定义zabbix客户端用户配置文件</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/zabbix/zabbix_agentd.conf.d/php_fpm.conf</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://nginx/files/etc/zabbix/zabbix_agentd.conf.d/php_fpm.conf</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">php-fpm-monitor-script</span></span><br><span class="line"><span class="attr">      - service:</span> <span class="string">php-fpm</span></span><br><span class="line"><span class="attr">    - watch_in:</span></span><br><span class="line"><span class="attr">      - service:</span> <span class="string">zabbix-agent</span></span><br><span class="line"></span><br><span class="line"><span class="attr">nginx-monitor-config:</span>  <span class="comment"># 定义zabbix客户端用户配置文件</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/zabbix/zabbix_agentd.conf.d/nginx.conf</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://nginx/files/etc/zabbix/zabbix_agentd.conf.d/nginx.conf</span></span><br><span class="line"><span class="attr">    - template:</span> <span class="string">jinja</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - service:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    - watch_in:</span></span><br><span class="line"><span class="attr">      - service:</span> <span class="string">zabbix-agent</span></span><br></pre></td></tr></table></figure><p>Salt Minion收集各个角色到/etc/salt/roles中，并生成grains，Salt Mine通过grains roles获取角色信息，当roles改变后通知Salt Mine更新。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">roles:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/salt/roles</span></span><br><span class="line"></span><br><span class="line"><span class="attr">sync_grains:</span></span><br><span class="line">  <span class="string">module.wait:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">saltutil.sync_grains</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mine_update:</span></span><br><span class="line">  <span class="string">module.run:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">mine.update</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - module:</span> <span class="string">sync_grains</span></span><br></pre></td></tr></table></figure><p>/srv/pillar/salt/minion.sls 定义Salt Mine functions：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mine_functions:</span></span><br><span class="line">  <span class="string">test.ping:</span> <span class="string">[]</span></span><br><span class="line">  <span class="string">grains.item:</span> <span class="string">[id,</span> <span class="string">hostgroup,</span> <span class="string">roles,</span> <span class="string">ipv4]</span></span><br></pre></td></tr></table></figure><p>grains类似puppet facer，用于收集客户端相关的信息。本文grains脚本（/srv/salt/_grains/roles.py）通过读取/etc/salt/roles文件生成grains roles:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os.path</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">roles</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">'''define host roles'''</span></span><br><span class="line"></span><br><span class="line">    roles_file = <span class="string">"/etc/salt/roles"</span></span><br><span class="line">    roles_list = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> os.path.isfile(roles_file):</span><br><span class="line">        roles_fd = open(roles_file, <span class="string">"r"</span>)</span><br><span class="line">        <span class="keyword">for</span> eachroles <span class="keyword">in</span> roles_fd:</span><br><span class="line">            roles_list.append(eachroles[:<span class="number">-1</span>])</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">'roles'</span>: roles_list&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">print</span> roles()</span><br></pre></td></tr></table></figure><p>Zabbix api的配置通过/srv/salt/zabbix/api.sls进行管理，主要完成对zapi的安装、Zabbix api角色的添加、Zabbix api配置文件的管理、添加监控脚本的管理以及更新监控配置并添加监控。此配置未实现zabbix模板的自动导入，所以需要手动导入模板(/srv/salt/zabbix/files/etc/zabbix/api/templates/zbx_export_templates.xml)。</p><p><img src="/images/14-06-16/zabbix_api_1.png" alt="zabbix api 1"><br><img src="/images/14-06-16/zabbix_api_2.png" alt="zabbix api 2"></p><p>上面配置读取/srv/pillar/zabbix/api.sls配置文件：</p><p><img src="/images/14-06-16/zabbix_api_pillar.png" alt="zabbix api pillar"></p><p>zabbix-api中定义zabbix url、用户名、密码以及监控配置目录和模板目录等。zabbix-base-templates定义基本监控模板，基本监控模板是需要加到所有机器上的。zabbix-templates定义角色与模板的对应关系。</p><p>添加监控脚本（/srv/salt/zabbix/files/etc/zabbix/api/add_monitors.py ）如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/env python</span></span><br><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##########################################################</span></span><br><span class="line"><span class="comment"># Add Monitor To Zabbix</span></span><br><span class="line"><span class="comment">##########################################################</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys, os.path</span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> zabbix.zapi <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_config</span><span class="params">(config_file)</span>:</span></span><br><span class="line">    <span class="string">'''get config'''</span></span><br><span class="line"></span><br><span class="line">    config_fd = open(config_file)</span><br><span class="line">    config = yaml.load(config_fd)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> config</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_get_templates</span><span class="params">(api_obj, templates_list)</span>:</span></span><br><span class="line">    <span class="string">'''get templates ids'''</span></span><br><span class="line"></span><br><span class="line">    templates_id = &#123;&#125;</span><br><span class="line">    templates_result = api_obj.Template.getobjects(&#123;<span class="string">"host"</span>: templates_list&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> each_template <span class="keyword">in</span> templates_result:</span><br><span class="line">        template_name = each_template[<span class="string">'name'</span>]</span><br><span class="line">        template_id = each_template[<span class="string">'templateid'</span>]</span><br><span class="line">        templates_id[template_name] = template_id</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> templates_id</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_get_host_templates</span><span class="params">(api_obj, hostid)</span>:</span></span><br><span class="line">    <span class="string">'''get the host has linked templates'''</span></span><br><span class="line"></span><br><span class="line">    templates_id = []</span><br><span class="line">    templates_result = api_obj.Template.get(&#123;<span class="string">'hostids'</span>: hostid&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> each_template <span class="keyword">in</span> templates_result:</span><br><span class="line">        template_id = each_template[<span class="string">'templateid'</span>]</span><br><span class="line">        templates_id.append(template_id)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> templates_id</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_create_hostgroup</span><span class="params">(api_obj, group_name)</span>:</span></span><br><span class="line">    <span class="string">'''create hostgroup'''</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">##check hostgroup exists</span></span><br><span class="line">    hostgroup_status = api_obj.Hostgroup.exists(&#123;<span class="string">"name"</span>: <span class="string">"%s"</span> %(group_name)&#125;)</span><br><span class="line">    <span class="keyword">if</span> hostgroup_status:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Hostgroup(%s) is already exists"</span> %(group_name)</span><br><span class="line">        group_id = api_obj.Hostgroup.getobjects(&#123;<span class="string">"name"</span>: <span class="string">"%s"</span> %(group_name)&#125;)[<span class="number">0</span>][<span class="string">"groupid"</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        hostgroup_status = api_obj.Hostgroup.create(&#123;<span class="string">"name"</span>: <span class="string">"%s"</span> %(group_name)&#125;)</span><br><span class="line">        <span class="keyword">if</span> hostgroup_status:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Hostgroup(%s) create success"</span> %(group_name)</span><br><span class="line">            group_id = hostgroup_status[<span class="string">"groupids"</span>][<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            sys.stderr.write(<span class="string">"Hostgroup(%s) create failed, please connect administrator\n"</span> %(group_name))</span><br><span class="line">            exit(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> group_id</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_create_host</span><span class="params">(api_obj, hostname, hostip, group_ids)</span>:</span></span><br><span class="line">    <span class="string">'''create host'''</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">##check host exists</span></span><br><span class="line">    host_status = api_obj.Host.exists(&#123;<span class="string">"name"</span>: <span class="string">"%s"</span> %(hostname)&#125;)</span><br><span class="line">    <span class="keyword">if</span> host_status:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Host(%s) is already exists"</span> %(hostname)</span><br><span class="line">        hostid = api_obj.Host.getobjects(&#123;<span class="string">"name"</span>: <span class="string">"%s"</span> %(hostname)&#125;)[<span class="number">0</span>][<span class="string">"hostid"</span>]</span><br><span class="line">        <span class="comment">##update host groups</span></span><br><span class="line">        groupids = [group[<span class="string">'groupid'</span>] <span class="keyword">for</span> group <span class="keyword">in</span> api_obj.Host.get(&#123;<span class="string">"output"</span>: [<span class="string">"hostid"</span>], <span class="string">"selectGroups"</span>: <span class="string">"extend"</span>, <span class="string">"filter"</span>: &#123;<span class="string">"host"</span>: [<span class="string">"%s"</span> %(hostname)]&#125;&#125;)[<span class="number">0</span>][<span class="string">'groups'</span>]]</span><br><span class="line">        is_hostgroup_update = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> groupid <span class="keyword">in</span> group_ids:</span><br><span class="line">            <span class="keyword">if</span> groupid <span class="keyword">not</span> <span class="keyword">in</span> groupids:</span><br><span class="line">                is_hostgroup_update = <span class="number">1</span></span><br><span class="line">                groupids.append(groupid)</span><br><span class="line">        <span class="keyword">if</span> is_hostgroup_update == <span class="number">1</span>:</span><br><span class="line">            groups = []</span><br><span class="line">            <span class="keyword">for</span> groupid <span class="keyword">in</span> groupids:</span><br><span class="line">                groups.append(&#123;<span class="string">"groupid"</span>: <span class="string">"%s"</span> %(groupid)&#125;)</span><br><span class="line">            host_status = api_obj.Host.update(&#123;<span class="string">"hostid"</span>: <span class="string">"%s"</span> %(hostid), <span class="string">"groups"</span>: groups&#125;)</span><br><span class="line">            <span class="keyword">if</span> host_status:</span><br><span class="line">                <span class="keyword">print</span> <span class="string">"Host(%s) group update success"</span> %(hostname)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                sys.stderr.write(<span class="string">"Host(%s) group update failed, please connect administrator\n"</span> %(hostname))</span><br><span class="line">                exit(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        groups = []</span><br><span class="line">        <span class="keyword">for</span> groupid <span class="keyword">in</span> group_ids:</span><br><span class="line">            groups.append(&#123;<span class="string">"groupid"</span>: <span class="string">"%s"</span> %(groupid)&#125;)</span><br><span class="line">        host_status = api_obj.Host.create(&#123;<span class="string">"host"</span>: <span class="string">"%s"</span> %(hostname), <span class="string">"interfaces"</span>: [&#123;<span class="string">"type"</span>: <span class="number">1</span>, <span class="string">"main"</span>: <span class="number">1</span>, <span class="string">"useip"</span>: <span class="number">1</span>, <span class="string">"ip"</span>: <span class="string">"%s"</span> %(hostip), <span class="string">"dns"</span>: <span class="string">""</span>, <span class="string">"port"</span>: <span class="string">"10050"</span>&#125;], <span class="string">"groups"</span>: groups&#125;)</span><br><span class="line">        <span class="keyword">if</span> host_status:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Host(%s) create success"</span> %(hostname)</span><br><span class="line">            hostid = host_status[<span class="string">"hostids"</span>][<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            sys.stderr.write(<span class="string">"Host(%s) create failed, please connect administrator\n"</span> %(hostname))</span><br><span class="line">            exit(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> hostid</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_create_host_usermacro</span><span class="params">(api_obj, hostname, usermacro)</span>:</span></span><br><span class="line">    <span class="string">'''create host usermacro'''</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> macro <span class="keyword">in</span> usermacro.keys():</span><br><span class="line">        value = usermacro[macro]</span><br><span class="line"></span><br><span class="line">    <span class="comment">##check host exists</span></span><br><span class="line">    host_status = api_obj.Host.exists(&#123;<span class="string">"name"</span>: <span class="string">"%s"</span> %(hostname)&#125;)</span><br><span class="line">    <span class="keyword">if</span> host_status:</span><br><span class="line">        hostid = api_obj.Host.getobjects(&#123;<span class="string">"name"</span>: <span class="string">"%s"</span> %(hostname)&#125;)[<span class="number">0</span>][<span class="string">"hostid"</span>]</span><br><span class="line">        <span class="comment">##check usermacro exists</span></span><br><span class="line">        usermacros = api_obj.Usermacro.get(&#123;<span class="string">"output"</span>: <span class="string">"extend"</span>, <span class="string">"hostids"</span>: <span class="string">"%s"</span> %(hostid)&#125;)</span><br><span class="line">        is_macro_exists = <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> usermacros:</span><br><span class="line">            <span class="keyword">for</span> usermacro <span class="keyword">in</span> usermacros:</span><br><span class="line">                <span class="keyword">if</span> usermacro[<span class="string">"macro"</span>] == macro:</span><br><span class="line">                    is_macro_exists = <span class="number">1</span></span><br><span class="line">                    <span class="keyword">if</span> usermacro[<span class="string">"value"</span>] == str(value):</span><br><span class="line">                        <span class="keyword">print</span> <span class="string">"Host(%s) usermacro(%s) is already exists"</span> %(hostname, macro)</span><br><span class="line">                        hostmacroid = usermacro[<span class="string">"hostmacroid"</span>]</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="comment">##usermacro exists, but value is not the same, update</span></span><br><span class="line">                        usermacro_status = api_obj.Usermacro.update(&#123;<span class="string">"hostmacroid"</span>: usermacro[<span class="string">"hostmacroid"</span>], <span class="string">"value"</span>: <span class="string">"%s"</span> %(value)&#125;)</span><br><span class="line">                        <span class="keyword">if</span> usermacro_status:</span><br><span class="line">                            <span class="keyword">print</span> <span class="string">"Host(%s) usermacro(%s) update success"</span> %(hostname, macro)</span><br><span class="line">                            hostmacroid = usermacro_status[<span class="string">"hostmacroids"</span>][<span class="number">0</span>]</span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            sys.stderr.write(<span class="string">"Host(%s) usermacro(%s) update failed, please connect administrator\n"</span> %(hostname, macro))</span><br><span class="line">                            exit(<span class="number">3</span>)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> is_macro_exists == <span class="number">0</span>:</span><br><span class="line">            usermacro_status = api_obj.Usermacro.create(&#123;<span class="string">"hostid"</span>: <span class="string">"%s"</span> %(hostid), <span class="string">"macro"</span>: <span class="string">"%s"</span> %(macro), <span class="string">"value"</span>: <span class="string">"%s"</span> %(value)&#125;)</span><br><span class="line">            <span class="keyword">if</span> usermacro_status:</span><br><span class="line">                <span class="keyword">print</span> <span class="string">"Host(%s) usermacro(%s) create success"</span> %(hostname, macro)</span><br><span class="line">                hostmacroid = usermacro_status[<span class="string">"hostmacroids"</span>][<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                sys.stderr.write(<span class="string">"Host(%s) usermacro(%s) create failed, please connect administrator\n"</span> %(hostname, macro))</span><br><span class="line">                exit(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sys.stderr.write(<span class="string">"Host(%s) is not exists"</span> %(hostname))</span><br><span class="line">        exit(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> hostmacroid</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_link_templates</span><span class="params">(api_obj, hostname, hostid, templates_list, donot_unlink_templates)</span>:</span></span><br><span class="line">    <span class="string">'''link templates'''</span></span><br><span class="line"></span><br><span class="line">    all_templates = []</span><br><span class="line">    clear_templates = []</span><br><span class="line">    <span class="comment">##get templates id</span></span><br><span class="line">    <span class="keyword">if</span> donot_unlink_templates <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        donot_unlink_templates_id = &#123;&#125;</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        donot_unlink_templates_id = _get_templates(api_obj, donot_unlink_templates)</span><br><span class="line">    templates_id = _get_templates(api_obj, templates_list)</span><br><span class="line">    <span class="comment">##get the host currently linked tempaltes</span></span><br><span class="line">    curr_linked_templates = _get_host_templates(api_obj, hostid)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> each_template <span class="keyword">in</span> templates_id:</span><br><span class="line">        <span class="keyword">if</span> templates_id[each_template] <span class="keyword">in</span> curr_linked_templates:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Host(%s) is already linked %s"</span> %(hostname, each_template)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Host(%s) will link %s"</span> %(hostname, each_template)</span><br><span class="line">        all_templates.append(templates_id[each_template])</span><br><span class="line"></span><br><span class="line">    <span class="comment">##merge templates list</span></span><br><span class="line">    <span class="keyword">for</span> each_template <span class="keyword">in</span> curr_linked_templates:</span><br><span class="line">        <span class="keyword">if</span> each_template <span class="keyword">not</span> <span class="keyword">in</span> all_templates:</span><br><span class="line">            <span class="keyword">if</span> each_template <span class="keyword">in</span> donot_unlink_templates_id.values():</span><br><span class="line">                all_templates.append(each_template)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                clear_templates.append(each_template)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">##convert to zabbix api style</span></span><br><span class="line">    templates_list = []</span><br><span class="line">    clear_templates_list = []</span><br><span class="line">    <span class="keyword">for</span> each_template <span class="keyword">in</span> all_templates:</span><br><span class="line">        templates_list.append(&#123;<span class="string">"templateid"</span>: each_template&#125;)</span><br><span class="line">    <span class="keyword">for</span> each_template <span class="keyword">in</span> clear_templates:</span><br><span class="line">        clear_templates_list.append(&#123;<span class="string">"templateid"</span>: each_template&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">##update host to link templates</span></span><br><span class="line">    update_status = api_obj.Host.update(&#123;<span class="string">"hostid"</span>: hostid, <span class="string">"templates"</span>: templates_list&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> update_status:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Host(%s) link templates success"</span> %(hostname)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Host(%s) link templates failed, please contact administrator"</span> %(hostname)</span><br><span class="line"></span><br><span class="line">    <span class="comment">##host unlink templates</span></span><br><span class="line">    <span class="keyword">if</span> clear_templates_list != []:</span><br><span class="line">        clear_status = api_obj.Host.update(&#123;<span class="string">"hostid"</span>: hostid, <span class="string">"templates_clear"</span>: clear_templates_list&#125;)</span><br><span class="line">        <span class="keyword">if</span> clear_status:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Host(%s) unlink templates success"</span> %(hostname)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Host(%s) unlink templates failed, please contact administrator"</span> %(hostname)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">'''main function'''</span></span><br><span class="line"></span><br><span class="line">    hosts = []</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">        hosts = sys.argv[<span class="number">1</span>:]</span><br><span class="line"></span><br><span class="line">    config_dir = os.path.dirname(sys.argv[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">if</span> config_dir:</span><br><span class="line">        config_file = config_dir+<span class="string">"/"</span>+<span class="string">"config.yaml"</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        config_file = <span class="string">"config.yaml"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">###get config options</span></span><br><span class="line">    config = _config(config_file)</span><br><span class="line">    Monitor_DIR = config[<span class="string">"Monitors_DIR"</span>]</span><br><span class="line">    Zabbix_URL = config[<span class="string">"Zabbix_URL"</span>]</span><br><span class="line">    Zabbix_User = config[<span class="string">"Zabbix_User"</span>]</span><br><span class="line">    Zabbix_Pass = config[<span class="string">"Zabbix_Pass"</span>]</span><br><span class="line">    Zabbix_Donot_Unlink_Template = config[<span class="string">"Zabbix_Donot_Unlink_Template"</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> hosts:</span><br><span class="line">        hosts = os.listdir(Monitor_DIR)</span><br><span class="line"></span><br><span class="line">    <span class="comment">###Login Zabbix</span></span><br><span class="line">    zapi = ZabbixAPI(url=Zabbix_URL, user=Zabbix_User, password=Zabbix_Pass)</span><br><span class="line">    zapi.login()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> each_host <span class="keyword">in</span> hosts:</span><br><span class="line">        each_config_fd = open(Monitor_DIR+<span class="string">"/"</span>+each_host)</span><br><span class="line">        each_config = yaml.load(each_config_fd)</span><br><span class="line"></span><br><span class="line">        <span class="comment">##Get config options</span></span><br><span class="line">        each_ip = each_config[<span class="string">"IP"</span>]</span><br><span class="line">        hostgroups = each_config[<span class="string">"Hostgroup"</span>]</span><br><span class="line">        each_templates = each_config[<span class="string">"Templates"</span>]</span><br><span class="line">        each_usermacros = each_config[<span class="string">"Usermacros"</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment">###Create Hostgroup</span></span><br><span class="line">        groupids = []</span><br><span class="line">        <span class="keyword">for</span> each_hostgroup <span class="keyword">in</span> hostgroups:</span><br><span class="line">            group_id = _create_hostgroup(zapi, each_hostgroup)</span><br><span class="line">            groupids.append(group_id)</span><br><span class="line"></span><br><span class="line">        <span class="comment">##Create Host</span></span><br><span class="line">        hostid = _create_host(zapi, each_host, each_ip, groupids)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> each_usermacros:</span><br><span class="line">            <span class="comment">##Create Host Usermacros</span></span><br><span class="line">            <span class="keyword">for</span> usermacro <span class="keyword">in</span> each_usermacros:</span><br><span class="line">                <span class="keyword">if</span> usermacro:</span><br><span class="line">                    usermacrosid = _create_host_usermacro(zapi, each_host, usermacro)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> each_templates:</span><br><span class="line">            <span class="comment">##Link tempaltes</span></span><br><span class="line">            _link_templates(zapi, each_host, hostid, each_templates, Zabbix_Donot_Unlink_Template)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    _main()</span><br></pre></td></tr></table></figure><p>参考：<a href="https://www.zabbix.com/documentation/2.2/manual/api" target="_blank" rel="noopener">zabbix api</a></p><p>此脚本读取的配置文件（/srv/salt/zabbix/files/etc/zabbix/api/config.yaml）:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Monitors_DIR:</span> <span class="string">&#123;&#123;Monitors_DIR&#125;&#125;</span></span><br><span class="line"><span class="attr">Templates_DIR:</span> <span class="string">&#123;&#123;Templates_DIR&#125;&#125;</span></span><br><span class="line"><span class="attr">Zabbix_URL:</span> <span class="string">&#123;&#123;Zabbix_URL&#125;&#125;</span></span><br><span class="line"><span class="attr">Zabbix_User:</span> <span class="string">&#123;&#123;Zabbix_User&#125;&#125;</span></span><br><span class="line"><span class="attr">Zabbix_Pass:</span> <span class="string">&#123;&#123;Zabbix_Pass&#125;&#125;</span></span><br><span class="line"><span class="attr">Zabbix_Donot_Unlink_Template:</span>  <span class="comment"># zabbix自动维护连接的模板，手动连接到主机上的模板需要在此处列出</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">'Template OS Linux'</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      本文以一个小的电商网站（www.mall.com）为例，讲述Saltstack在真实场景中的应用。
    
    </summary>
    
      <category term="Saltstack" scheme="https://istone.dev/categories/Saltstack/"/>
    
    
      <category term="devops" scheme="https://istone.dev/tags/devops/"/>
    
      <category term="saltstack" scheme="https://istone.dev/tags/saltstack/"/>
    
      <category term="salt" scheme="https://istone.dev/tags/salt/"/>
    
  </entry>
  
  <entry>
    <title>Saltstack：代码部署系统搭建</title>
    <link href="https://istone.dev/2014/06/15/saltstack-publish/"/>
    <id>https://istone.dev/2014/06/15/saltstack-publish/</id>
    <published>2014-06-15T02:00:00.000Z</published>
    <updated>2019-06-26T10:07:01.296Z</updated>
    
    <content type="html"><![CDATA[<p>部署系统基于Salt Runner编写，Salt Runner使用salt-run命令执行的命令行工具，可以通过调用Salt API很轻松构建。Salt Runner与Salt的执行模块很像，但是在Salt Master上运行而非Salt Minion上。</p><h4 id="配置Salt-Master"><a href="#配置Salt-Master" class="headerlink" title="配置Salt Master"></a>配置Salt Master</h4><p>配置文件（/etc/salt/master.d/publish.conf）如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">svn:</span></span><br><span class="line"><span class="attr">  username:</span> <span class="string">'publish'</span>  <span class="comment"># 定义svn用户名，用于检出代码</span></span><br><span class="line"><span class="attr">  password:</span> <span class="string">'#1qaz@WSX#ht'</span>  <span class="comment"># svn密码</span></span><br><span class="line"><span class="attr">publish:</span></span><br><span class="line"><span class="attr">    master:</span> <span class="string">'admin.grid.mall.com'</span>  <span class="comment"># salt master主机名</span></span><br><span class="line"><span class="attr">    cwd:</span> <span class="string">'/data1/vhosts'</span>  <span class="comment"># 代码检出目录</span></span><br><span class="line"><span class="attr">projects:</span></span><br><span class="line">  <span class="string">www.mall.com:</span>  <span class="comment"># 定义项目名</span></span><br><span class="line"><span class="attr">    remote:</span> <span class="string">'svn://172.16.100.81/www.mall.com'</span> <span class="comment"># svn存放路径</span></span><br><span class="line"><span class="attr">    target:</span>  <span class="comment"># 定义代码部署列表 ip::rsync模块</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'172.16.100.21::www_mall_com'</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'172.16.100.22::www_mall_com'</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'172.16.100.23::www_mall_com'</span></span><br></pre></td></tr></table></figure><p>另外还要配置runner的放置目录：runner_dirs: [/srv/salt/_runners]，配置完成后要重启Puppet master。</p><h4 id="Web前端部署rsync服务"><a href="#Web前端部署rsync服务" class="headerlink" title="Web前端部署rsync服务"></a>Web前端部署rsync服务</h4><p>rsync服务由/srv/salt/rsync模块进行管理，rsync配置文件(etc/rsyncd.conf)如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># File Managed by Salt</span></span><br><span class="line"></span><br><span class="line"><span class="string">uid</span> <span class="string">=</span> <span class="string">nobody</span></span><br><span class="line"><span class="string">gid</span> <span class="string">=</span> <span class="string">nobody</span></span><br><span class="line"><span class="string">use</span> <span class="string">chroot</span> <span class="string">=</span> <span class="literal">yes</span></span><br><span class="line"><span class="string">max</span> <span class="string">connections</span> <span class="string">=</span> <span class="number">150</span></span><br><span class="line"><span class="string">pid</span> <span class="string">file</span> <span class="string">=</span> <span class="string">/var/run/rsyncd.pid</span></span><br><span class="line"><span class="string">log</span> <span class="string">file</span> <span class="string">=</span> <span class="string">/var/log/rsyncd.log</span></span><br><span class="line"><span class="string">transfer</span> <span class="string">logging</span> <span class="string">=</span> <span class="literal">yes</span></span><br><span class="line"><span class="string">log</span> <span class="string">format</span> <span class="string">=</span> <span class="string">%t</span> <span class="string">%a</span> <span class="string">%m</span> <span class="string">%f</span> <span class="string">%b</span></span><br><span class="line"><span class="string">syslog</span> <span class="string">facility</span> <span class="string">=</span> <span class="string">local3</span></span><br><span class="line"><span class="string">timeout</span> <span class="string">=</span> <span class="number">300</span></span><br><span class="line"><span class="string">incoming</span> <span class="string">chmod</span> <span class="string">=</span> <span class="string">Du=rwx,Dog=rx,Fu=rw,Fgo=r</span></span><br><span class="line"><span class="string">hosts</span> <span class="string">allow=172.16.100.0/24</span></span><br><span class="line"></span><br><span class="line"><span class="string">[www_mall_com]</span></span><br><span class="line"><span class="string">path=/data1/vhosts/www.mall.com/htdocs/</span></span><br><span class="line"><span class="string">read</span> <span class="string">only=no</span></span><br></pre></td></tr></table></figure><h4 id="编写runner脚本"><a href="#编写runner脚本" class="headerlink" title="编写runner脚本"></a>编写runner脚本</h4><p>部署系统在Salt Master上把代码从SVN中检出，通过rsync命令部署到web前端。runner脚本(/srv/salt/_runners/publish.py)如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">Functions to publish code on the master</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Import salt libs</span></span><br><span class="line"><span class="keyword">import</span> salt.client</span><br><span class="line"><span class="keyword">import</span> salt.output</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">push</span><span class="params">(project, output=True)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    publish code to web server.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    CLI Example:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    .. code-block:: bash</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        salt-run publish.push project</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line"></span><br><span class="line">    client = salt.client.LocalClient(__opts__[<span class="string">'conf_file'</span>])</span><br><span class="line">    ret = client.cmd(__opts__[<span class="string">'publish'</span>][<span class="string">'master'</span>],</span><br><span class="line">                      <span class="string">'svn.checkout'</span>,</span><br><span class="line">                       [</span><br><span class="line">                         __opts__[<span class="string">'publish'</span>][<span class="string">'cwd'</span>],</span><br><span class="line">                         __opts__[<span class="string">'projects'</span>][project][<span class="string">'remote'</span>]</span><br><span class="line">                       ],</span><br><span class="line">                       kwarg=&#123;</span><br><span class="line">                               <span class="string">'target'</span>:project,</span><br><span class="line">                               <span class="string">'username'</span>:__opts__[<span class="string">'svn'</span>][<span class="string">'username'</span>],</span><br><span class="line">                               <span class="string">'password'</span>:__opts__[<span class="string">'svn'</span>][<span class="string">'password'</span>]</span><br><span class="line">                             &#125;</span><br><span class="line">                    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ret:</span><br><span class="line">        msg = <span class="string">'URL: %s\n%s'</span> %(__opts__[<span class="string">'projects'</span>][project][<span class="string">'remote'</span>], ret[__opts__[<span class="string">'publish'</span>][<span class="string">'master'</span>]])</span><br><span class="line">        ret = &#123;<span class="string">'Check out code'</span>: msg&#125;</span><br><span class="line">    <span class="keyword">if</span> output:</span><br><span class="line">        salt.output.display_output(ret, <span class="string">''</span>, __opts__)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> target <span class="keyword">in</span> __opts__[<span class="string">'projects'</span>][project][<span class="string">'target'</span>]:</span><br><span class="line">        cmd = <span class="string">'/usr/bin/rsync -avz --exclude=".svn" %s/%s/trunk/* %s/'</span> %(__opts__[<span class="string">'publish'</span>][<span class="string">'cwd'</span>], project, target)</span><br><span class="line">        ret[target] = client.cmd(__opts__[<span class="string">'publish'</span>][<span class="string">'master'</span>],</span><br><span class="line">                           <span class="string">'cmd.run'</span>,</span><br><span class="line">                           [</span><br><span class="line">                             cmd,</span><br><span class="line">                           ],</span><br><span class="line">                         )</span><br><span class="line"></span><br><span class="line">        title = <span class="string">'\nSending file to %s'</span> %target.split(<span class="string">':'</span>)[<span class="number">0</span>]</span><br><span class="line">        ret = &#123;title: ret[target][__opts__[<span class="string">'publish'</span>][<span class="string">'master'</span>]]&#125;</span><br><span class="line">        <span class="keyword">if</span> output:</span><br><span class="line">            salt.output.display_output(ret, <span class="string">''</span>, __opts__)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret</span><br></pre></td></tr></table></figure><p>注意，一个项目（svn://172.16.100.81/<a href="http://www.mall.com" target="_blank" rel="noopener">www.mall.com</a> ）通常会建立三个SVN子目录：trunk、branches、tags，上面脚本推送时只会将trunk目录下的代码部署到web前端。</p><h4 id="代码部署"><a href="#代码部署" class="headerlink" title="代码部署"></a>代码部署</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># salt-run publish.push www.mall.com</span></span><br></pre></td></tr></table></figure><p>publish为上文runner脚本名，push为此脚本中定义的推送函数，<a href="http://www.mall.com为salt" target="_blank" rel="noopener">www.mall.com为salt</a> master中定义的项目名。</p><p>参考：<br><a href="http://docs.saltstack.com/en/latest/ref/runners/" target="_blank" rel="noopener">Salt Runners</a><br><a href="http://docs.saltstack.com/en/latest/ref/clients/index.html" target="_blank" rel="noopener">Python client API</a></p>]]></content>
    
    <summary type="html">
    
      本文以一个小的电商网站（www.mall.com）为例，讲述Saltstack在真实场景中的应用。
    
    </summary>
    
      <category term="Saltstack" scheme="https://istone.dev/categories/Saltstack/"/>
    
    
      <category term="devops" scheme="https://istone.dev/tags/devops/"/>
    
      <category term="saltstack" scheme="https://istone.dev/tags/saltstack/"/>
    
      <category term="salt" scheme="https://istone.dev/tags/salt/"/>
    
  </entry>
  
  <entry>
    <title>Saltstack：服务部署</title>
    <link href="https://istone.dev/2014/06/14/saltstack-service/"/>
    <id>https://istone.dev/2014/06/14/saltstack-service/</id>
    <published>2014-06-14T02:00:00.000Z</published>
    <updated>2019-06-26T10:09:29.053Z</updated>
    
    <content type="html"><![CDATA[<p>本文以web服务器为例介绍salt服务的部署。把不同的服务组织成不同的角色，然后将角色应用到不同的节点上。通过角色的划分能够清晰的对不同的服务模块进行组织，所有角色的配置放到/srv/salt/roles下，角色用到的相关变量放到/srv/pillar/roles和/srv/pillar/nodes下，其中/srv/pillar/nodes下放置与具体节点相关的变量。</p><h3 id="角色与配置文件"><a href="#角色与配置文件" class="headerlink" title="角色与配置文件"></a>角色与配置文件</h3><p>/srv/salt/roles/web.sls配置如下，包括nginx模块、rsync模块、limits模块和nfs.client：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nginx</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">rsync</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">limits</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nfs.client</span></span><br></pre></td></tr></table></figure><p>变量/srv/pillar/roles/web.sls如下，没有单独应用到节点的变量:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hostgroup:</span> <span class="string">web</span>  <span class="comment"># 定义zabbix分组，具体见后文的自动化监控一节</span></span><br><span class="line"><span class="attr">vhostsdir:</span> <span class="string">/data1/vhosts</span>  <span class="comment"># 代码发布目录</span></span><br><span class="line"><span class="attr">vhostscachedir:</span> <span class="string">/data1/cache</span>  <span class="comment"># 程序临时目录</span></span><br><span class="line"><span class="attr">logdir:</span> <span class="string">/data1/logs</span>  <span class="comment"># nginx日志目录</span></span><br><span class="line"><span class="attr">vhosts:</span>  <span class="comment"># 虚拟主机名，用于创建对用的代码发布目录</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">www.mall.com</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">static.mall.com</span></span><br><span class="line"><span class="attr">limit_users:</span>  <span class="comment"># 对用户打开文件数做设置</span></span><br><span class="line"><span class="attr">  nginx:</span></span><br><span class="line"><span class="attr">    limit_hard:</span> <span class="number">65535</span></span><br><span class="line"><span class="attr">    limit_soft:</span> <span class="number">65535</span></span><br><span class="line"><span class="attr">    limit_type:</span> <span class="string">nofile</span></span><br><span class="line"><span class="attr">mounts:</span> <span class="comment"># nfs共享存储挂载相关配置</span></span><br><span class="line">  <span class="string">/data1/vhosts/static.mall.com/htdocs:</span></span><br><span class="line"><span class="attr">    device:</span> <span class="number">172.16</span><span class="number">.100</span><span class="number">.71</span><span class="string">:/data1/share</span></span><br><span class="line"><span class="attr">    fstype:</span> <span class="string">nfs</span></span><br><span class="line"><span class="attr">    mkmnt:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">    opts:</span> <span class="string">async,noatime,noexec,nosuid,soft,timeo=3,retrans=3,intr,retry=3,rsize=16384,wsize=16384</span></span><br></pre></td></tr></table></figure><h3 id="Nginx-PHP配置"><a href="#Nginx-PHP配置" class="headerlink" title="Nginx+PHP配置"></a>Nginx+PHP配置</h3><p>管理模块：/srv/salt/nginx/<br>nginx配置文件：/srv/salt/nginx/files/etc/nginx/，其中包括主配置文件、虚拟主机配置文件、和环境变量配置文件。<br>php配置文件：主配置文件：/srv/salt/nginx/files/etc/php.ini 模块配置文件：/srv/salt/nginx/files/etc/php.d/<br>php-fpm配置文件：主配置文件：/srv/salt/nginx/files/etc/php-fpm.conf 其他配置文件：/srv/salt/nginx/files/etc/php-fpm.d/<br>角色配置：/srv/pillar/roles/web.sls</p><h4 id="详细说明"><a href="#详细说明" class="headerlink" title="详细说明"></a>详细说明</h4><p>/srv/salt/nginx/init.sls用于组织整个nginx模块：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nginx.server</span>  <span class="comment"># 包含nginx相关配置</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nginx.php</span>  <span class="comment"># 包含php相关配置</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nginx.monitor</span> <span class="comment"># 包含监控相关配置</span></span><br></pre></td></tr></table></figure><p>/srv/salt/nginx/server.sls用于配置nginx服务：</p><p>定义nginx相关配置，主要包括安装nginx软件包配置相关配置文件，并启动nginx服务。<br><img src="/images/14-06-14/nginx_server_1.png" alt="nginx server 1"></p><p>创建日志目录、代码发布目录、代码缓存目录。并配置服务角色，角色也用于对服务的监控，详见后文自动化监控。<br><img src="/images/14-06-14/nginx_server_2.png" alt="nginx server 2"></p><p>/srv/salt/nginx/php.sls用于配置php服务：</p><p>定义php相关配置，主要包括安装php软件包配置相关配置文件，启动php-fpm服务，并配置服务角色。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">php-fpm:</span></span><br><span class="line"><span class="attr">  pkg:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">php-fpm</span></span><br><span class="line"><span class="attr">    - pkgs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">php-fpm</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">php-common</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">php-cli</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">php-devel</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">php-pecl-memcache</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">php-pecl-memcached</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">php-gd</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">php-pear</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">php-mbstring</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">php-mysql</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">php-xml</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">php-bcmath</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">php-pdo</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">installed</span></span><br><span class="line"><span class="attr">  service:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">running</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">php-fpm</span></span><br><span class="line"><span class="attr">    - watch:</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">php-fpm</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">/etc/php.ini</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">/etc/php.d/</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">/etc/php-fpm.conf</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">/etc/php-fpm.d/</span></span><br><span class="line"></span><br><span class="line"><span class="string">/etc/php.ini:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://nginx/files/etc/php.ini</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"></span><br><span class="line"><span class="string">/etc/php.d/:</span></span><br><span class="line">  <span class="string">file.recurse:</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://nginx/files/etc/php.d/</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - dir_mode:</span> <span class="number">755</span></span><br><span class="line"><span class="attr">    - file_mode:</span> <span class="number">644</span></span><br><span class="line"></span><br><span class="line"><span class="string">/etc/php-fpm.conf:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://nginx/files/etc/php-fpm.conf</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"></span><br><span class="line"><span class="string">/etc/php-fpm.d/:</span></span><br><span class="line">  <span class="string">file.recurse:</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://nginx/files/etc/php-fpm.d/</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - dir_mode:</span> <span class="number">755</span></span><br><span class="line"><span class="attr">    - file_mode:</span> <span class="number">644</span></span><br><span class="line"></span><br><span class="line"><span class="attr">php-fpm-role:</span>  <span class="comment"># 定义php-fpm角色</span></span><br><span class="line">  <span class="string">file.append:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/salt/roles</span></span><br><span class="line"><span class="attr">    - text:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'php-fpm'</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">roles</span></span><br><span class="line"><span class="attr">      - service:</span> <span class="string">php-fpm</span></span><br><span class="line"><span class="attr">      - service:</span> <span class="string">salt-minion</span></span><br><span class="line"><span class="attr">    - watch_in:</span></span><br><span class="line"><span class="attr">      - module:</span> <span class="string">sync_grains</span></span><br></pre></td></tr></table></figure><p>/srv/salt/nginx/monitor.sls用于配置对服务的监控：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">zabbix.agent</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line"><span class="attr">nginx-monitor:</span></span><br><span class="line">  <span class="string">pkg.installed:</span>  <span class="comment"># 安装脚本依赖的软件包</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">perl-libwww-perl</span></span><br><span class="line"></span><br><span class="line"><span class="attr">php-fpm-monitor-script:</span>  <span class="comment"># 管理监控脚本，如果脚本存放目录不存在自动创建</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/zabbix/ExternalScripts/php-fpm_status.pl</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://nginx/files/etc/zabbix/ExternalScripts/php-fpm_status.pl</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">755</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - service:</span> <span class="string">php-fpm</span></span><br><span class="line"><span class="attr">      - pkg:</span> <span class="string">nginx-monitor</span></span><br><span class="line"><span class="attr">      - cmd:</span> <span class="string">php-fpm-monitor-script</span></span><br><span class="line">  <span class="string">cmd.run:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">mkdir</span> <span class="bullet">-p</span> <span class="string">/etc/zabbix/ExternalScripts</span></span><br><span class="line"><span class="attr">    - unless:</span> <span class="string">test</span> <span class="bullet">-d</span> <span class="string">/etc/zabbix/ExternalScripts</span></span><br><span class="line"></span><br><span class="line"><span class="attr">php-fpm-monitor-config:</span>  <span class="comment"># 定义zabbix客户端用户配置文件</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/zabbix/zabbix_agentd.conf.d/php_fpm.conf</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://nginx/files/etc/zabbix/zabbix_agentd.conf.d/php_fpm.conf</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - file:</span> <span class="string">php-fpm-monitor-script</span></span><br><span class="line"><span class="attr">      - service:</span> <span class="string">php-fpm</span></span><br><span class="line"><span class="attr">    - watch_in:</span></span><br><span class="line"><span class="attr">      - service:</span> <span class="string">zabbix-agent</span></span><br><span class="line"></span><br><span class="line"><span class="attr">nginx-monitor-config:</span>  <span class="comment"># 定义zabbix客户端用户配置文件</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/zabbix/zabbix_agentd.conf.d/nginx.conf</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://nginx/files/etc/zabbix/zabbix_agentd.conf.d/nginx.conf</span></span><br><span class="line"><span class="attr">    - template:</span> <span class="string">jinja</span></span><br><span class="line"><span class="attr">    - require:</span></span><br><span class="line"><span class="attr">      - service:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    - watch_in:</span></span><br><span class="line"><span class="attr">      - service:</span> <span class="string">zabbix-agent</span></span><br></pre></td></tr></table></figure><p>其他角色的部署跟web相似，不一一列出。</p>]]></content>
    
    <summary type="html">
    
      本文以一个小的电商网站（www.mall.com）为例，讲述Saltstack在真实场景中的应用。
    
    </summary>
    
      <category term="Saltstack" scheme="https://istone.dev/categories/Saltstack/"/>
    
    
      <category term="devops" scheme="https://istone.dev/tags/devops/"/>
    
      <category term="saltstack" scheme="https://istone.dev/tags/saltstack/"/>
    
      <category term="salt" scheme="https://istone.dev/tags/salt/"/>
    
  </entry>
  
  <entry>
    <title>Saltstack：基础服务部署</title>
    <link href="https://istone.dev/2014/05/29/saltstack-base-service/"/>
    <id>https://istone.dev/2014/05/29/saltstack-base-service/</id>
    <published>2014-05-29T02:00:00.000Z</published>
    <updated>2019-06-26T10:03:31.191Z</updated>
    
    <content type="html"><![CDATA[<p>对基础服务的管理包括配置管理系统、用户账号管理、yum配置管理、hosts文件管理、时间同步管理、DNS配置管理。</p><h3 id="配置管理系统"><a href="#配置管理系统" class="headerlink" title="配置管理系统"></a>配置管理系统</h3><p>配置管理系统使用模块化设计，每个服务一个模块，将多个模块组织到一起形成角色（/srv/salt/roles/）。所有模块放置到：/srv/salt下，入口配置文件为：/srv/salt/top.sls。模块使用的变量放置到：/srv/pillar，入口配置文件：/srv/pillar/top.sls。针对变量的作用域不同，将变量分为三级级，一级应用于模块（/srv/pillar/模块名），一级应用于角色（/srv/pillar/roles/），一级应用于主机节点（/srv/pillar/nodes）。具体配置在此不一一列出，具体参见salt配置文件。</p><p>入口配置/srv/salt/top.sls，直接引用各种角色：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">base:</span></span><br><span class="line">  <span class="string">'*'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">roles.common</span></span><br><span class="line">  <span class="string">'admin.grid.mall.com'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">roles.admin</span></span><br><span class="line">  <span class="string">'ha.grid.mall.com'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">roles.ha</span></span><br><span class="line">  <span class="string">'web*.grid.mall.com'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">roles.web</span></span><br><span class="line">  <span class="string">'cache*.grid.mall.com'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">roles.cache</span></span><br><span class="line">  <span class="string">'mc*.grid.mall.com'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">roles.mc</span></span><br><span class="line">  <span class="string">'db*.grid.mall.com'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">roles.db</span></span><br><span class="line">  <span class="string">'search*.grid.mall.com'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">roles.search</span></span><br><span class="line">  <span class="string">'storage*'</span><span class="string">.grid.mall.com':</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">roles.storage</span></span><br></pre></td></tr></table></figure><p>变量入口配置文件/srv/pillar/top.sls：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">base:</span></span><br><span class="line">  <span class="string">'*'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">roles.common</span></span><br><span class="line">  <span class="comment"># 引用角色级变量</span></span><br><span class="line">  <span class="comment"># 模块级变量在角色级变量中引用</span></span><br><span class="line">  <span class="string">'admin.grid.mall.com'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">roles.admin</span></span><br><span class="line">  <span class="string">'ha.grid.mall.com'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">roles.ha</span></span><br><span class="line">  <span class="string">'web*.grid.mall.com'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">roles.web</span></span><br><span class="line">  <span class="string">'cache*.grid.mall.com'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">roles.cache</span></span><br><span class="line">  <span class="string">'mc*.grid.mall.com'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">roles.mc</span></span><br><span class="line">  <span class="string">'db*.grid.mall.com'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">roles.db</span></span><br><span class="line">  <span class="string">'search*.grid.mall.com'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">roles.search</span></span><br><span class="line">  <span class="string">'storage*'</span><span class="string">.grid.mall.com':</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">roles.storage</span></span><br><span class="line">  <span class="comment"># 引用节点级变量</span></span><br><span class="line">  <span class="string">'ha1.grid.mall.com'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">nodes.ha1</span></span><br><span class="line">  <span class="string">'ha2.grid.mall.com'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">nodes.ha2</span></span><br><span class="line">  <span class="string">'mc1.grid.mall.com'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">nodes.mc1</span></span><br><span class="line">  <span class="string">'mc2.grid.mall.com'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">nodes.mc2</span></span><br><span class="line">  <span class="string">'db1.grid.mall.com'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">nodes.db1</span></span><br><span class="line">  <span class="string">'db2.grid.mall.com'</span><span class="string">:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">nodes.db2</span></span><br></pre></td></tr></table></figure><h3 id="用户账号管理"><a href="#用户账号管理" class="headerlink" title="用户账号管理"></a>用户账号管理</h3><p>用户管理模块：/srv/salt/users</p><p>此模块用到pillar，pillar和grains都可以用来获取变量，但是grains偏向于获取客户端相关信息，比如客户端硬件架构、cpu核数、操作系统版本等信息，相当于puppet的facter；pillar用于定义用户变量，通过pillar变量的传递，使salt state模块易于重用，相当于puppet的hiera。使用pillar变量之前需要执行salt ‘*’ saltutil.refresh_pillar命令使变量生效。使用命令salt ‘admin.grid.mall.com’ pillar.item users获取users变量：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># salt 'admin.grid.mall.com' pillar.item users</span></span><br><span class="line"><span class="string">admin.grid.mall.com:</span></span><br><span class="line"><span class="bullet">    -</span><span class="bullet">---------</span></span><br><span class="line"><span class="attr">    users:</span></span><br><span class="line"><span class="bullet">        -</span><span class="bullet">---------</span></span><br><span class="line"><span class="attr">        dongliang:</span></span><br><span class="line"><span class="bullet">            -</span><span class="bullet">---------</span></span><br><span class="line"><span class="attr">            fullname:</span></span><br><span class="line">                <span class="string">Shi</span> <span class="string">Dongliang</span></span><br><span class="line"><span class="attr">            gid:</span></span><br><span class="line">                <span class="number">1000</span></span><br><span class="line"><span class="attr">            group:</span></span><br><span class="line">                <span class="string">dongliang</span></span><br><span class="line"><span class="attr">            password:</span></span><br><span class="line">                <span class="string">$6$BZpX5dWZ$.......</span></span><br><span class="line"><span class="attr">            shell:</span></span><br><span class="line">                <span class="string">/bin/bash</span></span><br><span class="line"><span class="attr">            ssh_auth:</span></span><br><span class="line"><span class="bullet">                -</span><span class="bullet">---------</span></span><br><span class="line"><span class="attr">                comment:</span></span><br><span class="line">                    <span class="string">dongliang@leju.com</span></span><br><span class="line"><span class="attr">                key:</span></span><br><span class="line">                    <span class="string">AAAAB3......==</span></span><br><span class="line"><span class="attr">            sudo:</span></span><br><span class="line">                <span class="literal">True</span></span><br><span class="line"><span class="attr">            uid:</span></span><br><span class="line">                <span class="number">1000</span></span><br></pre></td></tr></table></figure><p>获取admin.grid.mall.com上面定义的所有pillar变量：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># salt 'admin.grid.mall.com' pillar.items</span></span><br></pre></td></tr></table></figure><p>添加用户：</p><p>/srv/salt/users/user.sls用于管理用户</p><p><img src="/images/14-05-29/user1.png" alt="user1定义"><br><img src="/images/14-05-29/user2.png" alt="user2定义"></p><p>sudo.sls为用户添加sudo权限：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sudoers:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">/etc/sudoers</span></span><br></pre></td></tr></table></figure><p>/srv/salt/users/user.sls读取/srv/pillar/users/init.sls中的users变量。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="attr">  dongliang:</span>  <span class="comment"># 定义用户名</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">dongliang</span>  <span class="comment"># 用户所在组</span></span><br><span class="line"><span class="attr">    uid:</span> <span class="number">1000</span>  <span class="comment"># 用户uid</span></span><br><span class="line"><span class="attr">    gid:</span> <span class="number">1000</span>  <span class="comment"># 用户gid</span></span><br><span class="line"><span class="attr">    fullname:</span> <span class="string">Shi</span> <span class="string">Dongliang</span></span><br><span class="line"><span class="attr">    password:</span>   <span class="string">$6$BZpX5dWZ$......</span>  <span class="comment"># 密码，注意是hash后的密码</span></span><br><span class="line"><span class="attr">    shell:</span> <span class="string">/bin/bash</span>  <span class="comment"># 用户shell</span></span><br><span class="line"><span class="attr">    sudo:</span> <span class="literal">true</span>  <span class="comment"># 是否给sudo权限</span></span><br><span class="line"><span class="attr">    ssh_auth:</span>  <span class="comment"># 无密码登录，可选项</span></span><br><span class="line"><span class="attr">      key:</span> <span class="string">AAAAB3......==</span></span><br><span class="line"><span class="attr">      comment:</span> <span class="string">dongliang@mall.com</span></span><br></pre></td></tr></table></figure><p>在salt-master上执行下面命令使配置生效</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># salt '*' saltutil.refresh_pillar</span></span><br><span class="line"><span class="comment"># salt '*' state.highstate</span></span><br></pre></td></tr></table></figure><h3 id="yum配置管理"><a href="#yum配置管理" class="headerlink" title="yum配置管理"></a>yum配置管理</h3><p>yum配置管理：/srv/salt/base/repo.sls<br>配置文件：/srv/salt/base/files/mall.repo  # 此配置文件可以通过salt协议下发到客户端</p><p>/srv/salt/base/repo.sls定义，管理mall.repo文件，当文件改变后执行yum clean all清理缓存，是配置生效。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">/etc/yum.repos.d/mall.repo:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://base/files/mall.repo</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - order:</span> <span class="number">1</span></span><br><span class="line">  <span class="string">cmd.wait:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">yum</span> <span class="string">clean</span> <span class="string">all</span></span><br><span class="line"><span class="attr">    - watch:</span></span><br><span class="line"><span class="attr">       - file:</span> <span class="string">/etc/yum.repos.d/mall.repo</span></span><br></pre></td></tr></table></figure><h3 id="hosts文件管理"><a href="#hosts文件管理" class="headerlink" title="hosts文件管理"></a>hosts文件管理</h3><p>hosts文件管理：/srv/salt/base/hosts.sls</p><p>/srv/salt/base/hosts.sls 定义了每个主机名和IP的对应关系。如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">admin.grid.mall.com:</span></span><br><span class="line">  <span class="string">host.present:</span></span><br><span class="line"><span class="attr">    - ip:</span> <span class="number">172.16</span><span class="number">.100</span><span class="number">.81</span></span><br><span class="line"><span class="attr">    - order:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">    - names:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">admin.grid.mall.com</span></span><br></pre></td></tr></table></figure><h3 id="时间同步管理"><a href="#时间同步管理" class="headerlink" title="时间同步管理"></a>时间同步管理</h3><p>时间同步作为一个cron，定义文件为：/srv/salt/base/crons.sls</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 引用ntp模块</span></span><br><span class="line"><span class="attr">include:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ntp</span></span><br><span class="line"></span><br><span class="line"><span class="string">'/usr/sbin/ntpdate 1.cn.pool.ntp.org 1.asia.pool.ntp.org'</span><span class="string">:</span></span><br><span class="line">  <span class="string">cron.present:</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - minute:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">    - hour:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure><p>ntp模块：ntp/init.sls</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装ntpdate软件包</span></span><br><span class="line"><span class="attr">ntpdate:</span></span><br><span class="line">  <span class="string">pkg.installed:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">ntpdate</span></span><br></pre></td></tr></table></figure><h3 id="DNS配置管理"><a href="#DNS配置管理" class="headerlink" title="DNS配置管理"></a>DNS配置管理</h3><p>配置DNS服务器定义在resolv.sls，控制/etc/resolv.conf配置文件:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">/etc/resolv.conf:</span></span><br><span class="line">  <span class="string">file.managed:</span></span><br><span class="line"><span class="attr">    - source:</span> <span class="attr">salt://base/files/resolv.conf</span></span><br><span class="line"><span class="attr">    - user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    - mode:</span> <span class="number">644</span></span><br><span class="line"><span class="attr">    - template:</span> <span class="string">jinja</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      本文以一个小的电商网站（www.mall.com）为例，讲述Saltstack在真实场景中的应用。
    
    </summary>
    
      <category term="Saltstack" scheme="https://istone.dev/categories/Saltstack/"/>
    
    
      <category term="devops" scheme="https://istone.dev/tags/devops/"/>
    
      <category term="saltstack" scheme="https://istone.dev/tags/saltstack/"/>
    
      <category term="salt" scheme="https://istone.dev/tags/salt/"/>
    
  </entry>
  
  <entry>
    <title>Saltstack：安装</title>
    <link href="https://istone.dev/2014/05/28/saltstack-install/"/>
    <id>https://istone.dev/2014/05/28/saltstack-install/</id>
    <published>2014-05-28T02:00:00.000Z</published>
    <updated>2019-06-26T10:05:47.068Z</updated>
    
    <content type="html"><![CDATA[<p>本文以一个小的电商网站（<a href="http://www.mall.com）为例，讲述Saltstack在真实场景中的应用。本节主要讲述Saltstack的安装过程。" target="_blank" rel="noopener">www.mall.com）为例，讲述Saltstack在真实场景中的应用。本节主要讲述Saltstack的安装过程。</a></p><h2 id="Saltstack安装"><a href="#Saltstack安装" class="headerlink" title="Saltstack安装"></a>Saltstack安装</h2><p>Saltstack源码地址：<a href="https://github.com/saltstack/salt，最新版本为v2014.1.4。" target="_blank" rel="noopener">https://github.com/saltstack/salt，最新版本为v2014.1.4。</a><br>需要自己<a href="http://yoyolive.com/%E5%85%B6%E4%BB%96/2014/05/22/rpm-pkg.html" target="_blank" rel="noopener">打rpm包</a>，salt描述文件：<a href="https://github.com/saltstack/salt/blob/develop/pkg/rpm/salt.spec，另外最新版本的salt需要python-libcloud，也需要提前打好包。如果是在CentOS" target="_blank" rel="noopener">https://github.com/saltstack/salt/blob/develop/pkg/rpm/salt.spec，另外最新版本的salt需要python-libcloud，也需要提前打好包。如果是在CentOS</a> 5.x 上安装salt，需要升级zeromq到3.x版。将所有打好的rpm包放入yum仓库，开始安装。</p><h3 id="Salt-Master安装"><a href="#Salt-Master安装" class="headerlink" title="Salt Master安装"></a>Salt Master安装</h3><p>注意：安装前确保主机名已按角色划分部分进行配置。</p><p>安装salt-master：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum install -y salt-master</span></span><br></pre></td></tr></table></figure><p>修改配置文件：/etc/salt/master，使salt监听在内网网卡上。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">interface: 172.16.100.81</span><br></pre></td></tr></table></figure><p>启动Salt Master：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/init.d/salt-master start</span></span><br></pre></td></tr></table></figure><p>查看启动情况，4505端口处于监听状态：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># netstat -tunlp |grep 4505</span></span><br></pre></td></tr></table></figure><h3 id="Salt-Minion安装"><a href="#Salt-Minion安装" class="headerlink" title="Salt Minion安装"></a>Salt Minion安装</h3><p>注意：安装前确保主机名已按角色划分部分进行配置。</p><p>安装salt-minion：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum install -y salt-minion</span></span><br></pre></td></tr></table></figure><p>修改配置文件：/etc/salt/minion，使其连接到master。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">master: 172.16.100.81</span><br></pre></td></tr></table></figure><p>启动Salt Minion：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/init.d/salt-minion start</span></span><br></pre></td></tr></table></figure><p>查看启动情况，4506端口处于监听状态：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># netstat -tunlp |grep 4506</span></span><br></pre></td></tr></table></figure><h3 id="在Salt-Master上为Salt-Minion授权"><a href="#在Salt-Master上为Salt-Minion授权" class="headerlink" title="在Salt Master上为Salt Minion授权"></a>在Salt Master上为Salt Minion授权</h3><p>查看Salt Minion是否已经向Salt Master请求授权：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># salt-key -L</span></span><br><span class="line">Accepted Keys:</span><br><span class="line">Unaccepted Keys:</span><br><span class="line">admin.grid.mall.com</span><br></pre></td></tr></table></figure><p>为Salt Minion授权：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># salt-key -a admin.grid.mall.com</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      本文以一个小的电商网站（www.mall.com）为例，讲述Saltstack在真实场景中的应用。
    
    </summary>
    
      <category term="Saltstack" scheme="https://istone.dev/categories/Saltstack/"/>
    
    
      <category term="devops" scheme="https://istone.dev/tags/devops/"/>
    
      <category term="saltstack" scheme="https://istone.dev/tags/saltstack/"/>
    
      <category term="salt" scheme="https://istone.dev/tags/salt/"/>
    
  </entry>
  
  <entry>
    <title>Saltstack：网站架构介绍</title>
    <link href="https://istone.dev/2014/05/27/saltstack-example-introduction/"/>
    <id>https://istone.dev/2014/05/27/saltstack-example-introduction/</id>
    <published>2014-05-27T02:00:00.000Z</published>
    <updated>2019-06-26T09:03:21.414Z</updated>
    
    <content type="html"><![CDATA[<p>本文以一个小的电商网站（<a href="http://www.mall.com）为例，讲述Saltstack在真实场景中的应用。主要介绍如何使用salt对电商网站各种服务进行管理、基于角色对应用进行自动化监控、基于Saltstack" target="_blank" rel="noopener">www.mall.com）为例，讲述Saltstack在真实场景中的应用。主要介绍如何使用salt对电商网站各种服务进行管理、基于角色对应用进行自动化监控、基于Saltstack</a> runner的代码部署系统等，主要包括以下主题：</p><ul><li><a href="http://yoyolive.com/saltstack/2014/05/27/saltstack-example-introduction.html" target="_blank" rel="noopener">网站架构介绍</a></li><li><a href="http://yoyolive.com/saltstack/2014/05/28/saltstack-install.html" target="_blank" rel="noopener">Saltstack安装</a></li><li><a href="http://yoyolive.com/saltstack/2014/05/29/saltstack-base-service.html" target="_blank" rel="noopener">基础服务部署</a></li><li><a href="http://yoyolive.com/saltstack/2014/06/14/saltstack-service.html" target="_blank" rel="noopener">服务部署</a></li><li><a href="http://yoyolive.com/saltstack/2014/06/15/saltstack-publish.html" target="_blank" rel="noopener">代码部署系统搭建</a></li><li><a href="http://yoyolive.com/saltstack/2014/06/16/saltstack-zabbix-monitor.html" target="_blank" rel="noopener">自动化监控</a></li><li><a href="http://yoyolive.com/saltstack/2014/06/17/saltstack-expand.html" target="_blank" rel="noopener">Salt模块的扩展</a></li></ul><p>项目代码已放到GitHub上，地址：<a href="https://github.com/ist0ne/salt-states" target="_blank" rel="noopener">https://github.com/ist0ne/salt-states</a></p><h2 id="网站架构介绍"><a href="#网站架构介绍" class="headerlink" title="网站架构介绍"></a>网站架构介绍</h2><h3 id="网络架构"><a href="#网络架构" class="headerlink" title="网络架构"></a>网络架构</h3><ol><li>使用Haproxy做负载均衡，一主一备，当主服务器宕机后备服务器自动接替主服务器角色对外提供服务。</li><li>WEB前端采用Nginx+PHP提供动态页面的访问；所有前端服务器通过NFS协议挂载共享存储，商品展示图片上传至存储中，图片访问时通过Varnish进行缓存加速。</li><li>使用memcached做缓冲层来提高访问速度和减轻数据库的压力；使用Redis做队列服务。</li><li>数据持久层使用MySQL，MySQL采用主从模式，通过主从分离提高访问速度。</li><li>使用Salt对整个系统进行配置管理；使用Zabbix进行系统监控；所有服务器通过跳板机进行登录。</li><li>使用SVN统一管理代码和配置信息。</li></ol><p><img src="/images/14-05-27/net.png" alt="网络架构"></p><p>说明:上面网络架构未按实际服务器数量画出，具体服务器见角色划分部分。</p><h3 id="系统架构"><a href="#系统架构" class="headerlink" title="系统架构"></a>系统架构</h3><ol><li>统一管理：整个系统通过Salt进行配置管理，所有配置文件统一存储到SVN中，通过SVN版本控制能够在系统故障时轻松回退到上一个正常版本。</li><li>代码部署：通过命令行部署工具从SVN中检出代码并部署到WEB前端，做到简单轻松部署。</li><li>应用架构：采用经典的三层架构–代码解析层、缓冲层、数据持久化层。缓冲层对用户数据进行缓存，不必每次都去数据库提取数据，减轻数据库压力；数据库采用主从架构，读写分离，减轻主库负载，提高了用户的访问速度。</li><li>动静态分离：图片、CSS、JS与动态程序分离，通过Varnish进行加速，提升用户体验。</li><li>Zabbix监控：基于角色的自动监控机制，通过Zabbix对系统状态、应用状态进行自动监控。</li></ol><p><img src="/images/14-05-27/sys.png" alt="系统架构"></p><h3 id="角色划分（主机名、IP地址分配）"><a href="#角色划分（主机名、IP地址分配）" class="headerlink" title="角色划分（主机名、IP地址分配）"></a>角色划分（主机名、IP地址分配）</h3><p>说明：所有服务器配置内、外双网卡，eth0为内网，eth1为外网。操作系统统一部署CentOS 6.5 64位。</p><h4 id="负载均衡（ha）"><a href="#负载均衡（ha）" class="headerlink" title="负载均衡（ha）"></a>负载均衡（ha）</h4><p>需要两台服务器作为负载均衡器使用，两台服务器配置为主备模式，当主服务器宕机后从服务器自动接管服务。</p><ul><li>ha1.grid.mall.com 60.60.60.11 172.16.100.11</li><li>ha2.grid.mall.com 60.60.60.12 172.16.100.12</li></ul><h4 id="Web前端（web）"><a href="#Web前端（web）" class="headerlink" title="Web前端（web）"></a>Web前端（web）</h4><p>需要三台服务器作为Web前端服务器，对外提供Web服务，Web服务通过负载均衡供用户访问。</p><ul><li>web1.grid.mall.com 60.60.60.21 172.16.100.21</li><li>web2.grid.mall.com 60.60.60.22 172.16.100.22</li><li>web3.grid.mall.com 60.60.60.23 172.16.100.23</li></ul><h4 id="图片缓存（cache）"><a href="#图片缓存（cache）" class="headerlink" title="图片缓存（cache）"></a>图片缓存（cache）</h4><p>需要两台服务器作为商品图片的缓存服务器，缓存服务器通过负载均衡供用户访问。</p><ul><li>cache1.grid.mall.com 60.60.60.31 172.16.100.31</li><li>cache2.grid.mall.com 60.60.60.32 172.16.100.32</li></ul><h4 id="缓存服务和队列服务（mc）"><a href="#缓存服务和队列服务（mc）" class="headerlink" title="缓存服务和队列服务（mc）"></a>缓存服务和队列服务（mc）</h4><p>需要两台服务器提供缓冲服务器和队列服务。</p><ul><li>mc1.grid.mall.com 60.60.60.41 172.16.100.41</li><li>mc2.grid.mall.com 60.60.60.42 172.16.100.42</li></ul><h4 id="数据库（db）"><a href="#数据库（db）" class="headerlink" title="数据库（db）"></a>数据库（db）</h4><p>需要两台服务器提供数据库服务，两台服务器通过主从复制同步数据。</p><ul><li>db1.grid.mall.com 60.60.60.51 172.16.100.51</li><li>db2.grid.mall.com 60.60.60.52 172.16.100.52</li></ul><h4 id="搜索（search）"><a href="#搜索（search）" class="headerlink" title="搜索（search）"></a>搜索（search）</h4><p>需要两台服务器提供搜索服务。</p><ul><li>search1.grid.mall.com 60.60.60.61 172.16.100.61</li><li>search2.grid.mall.com 60.60.60.62 172.16.100.62</li></ul><h4 id="共享存储（storage）"><a href="#共享存储（storage）" class="headerlink" title="共享存储（storage）"></a>共享存储（storage）</h4><p>需要一台服务器提供存储服务。</p><ul><li>storage1.grid.mall.com 60.60.60.71 172.16.100.71</li></ul><h4 id="管理机（admin）"><a href="#管理机（admin）" class="headerlink" title="管理机（admin）"></a>管理机（admin）</h4><p>需要一台管理机，上面部署Salt master，zabbix，svn等管理服务。</p><ul><li>admin.grid.mall.com 60.60.60.81 172.16.100.81</li></ul>]]></content>
    
    <summary type="html">
    
      本文以一个小的电商网站（www.mall.com）为例，讲述Saltstack在真实场景中的应用。
    
    </summary>
    
      <category term="Saltstack" scheme="https://istone.dev/categories/Saltstack/"/>
    
    
      <category term="devops" scheme="https://istone.dev/tags/devops/"/>
    
      <category term="saltstack" scheme="https://istone.dev/tags/saltstack/"/>
    
      <category term="salt" scheme="https://istone.dev/tags/salt/"/>
    
  </entry>
  
  <entry>
    <title>rpm打包</title>
    <link href="https://istone.dev/2014/05/22/rpm-pkg/"/>
    <id>https://istone.dev/2014/05/22/rpm-pkg/</id>
    <published>2014-05-22T02:00:00.000Z</published>
    <updated>2019-06-26T09:01:32.838Z</updated>
    
    <content type="html"><![CDATA[<p>为了方便批量进行软件安装，我们通常将源代码打包，放到yum仓库中进行统一管理，本文记录了一次rpm打包过程。</p><h2 id="1、安装rpm-build"><a href="#1、安装rpm-build" class="headerlink" title="1、安装rpm-build"></a>1、安装rpm-build</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y rpm-build</span><br></pre></td></tr></table></figure><h2 id="2、安装编译依赖包"><a href="#2、安装编译依赖包" class="headerlink" title="2、安装编译依赖包"></a>2、安装编译依赖包</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y make gcc gcc-c++ libtool autoconf automake imake</span><br></pre></td></tr></table></figure><h2 id="3、安装软件本身依赖的软件包"><a href="#3、安装软件本身依赖的软件包" class="headerlink" title="3、安装软件本身依赖的软件包"></a>3、安装软件本身依赖的软件包</h2><p>以CoreSeek安装为例，<a href="http://www.coreseek.cn/products-install/" target="_blank" rel="noopener">Coreseek</a> 是一款中文全文检索/搜索软件，以GPLv2许可协议开源发布，基于Sphinx研发并独立发布，专攻中文搜索和信息处理领域，适用于行业/垂直搜索、论坛/站内搜索、数据库搜索、文档/文献检索、信息检索、数据挖掘等应用场景。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y libxml2-devel expat-devel mysql-devel python-devel</span><br></pre></td></tr></table></figure><h2 id="4、如下创建rpmbuild"><a href="#4、如下创建rpmbuild" class="headerlink" title="4、如下创建rpmbuild"></a>4、如下创建rpmbuild</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@salt ~]<span class="comment"># ls /root/rpmbuild</span></span><br><span class="line">BUILD  BUILDROOT  RPMS  SOURCES  SPECS  SRPMS</span><br></pre></td></tr></table></figure><h2 id="5、编写描述文件"><a href="#5、编写描述文件" class="headerlink" title="5、编写描述文件"></a>5、编写描述文件</h2><p>CoreSeek依赖mmseg中文分词库，所有先给mmseg打包。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@salt SPECS]<span class="comment"># vi mmseg.spec</span></span><br><span class="line">Name: mmseg</span><br><span class="line">Version: 3.2.14</span><br><span class="line">Release: 1%&#123;?dist&#125;</span><br><span class="line">Summary: A Word Identification System <span class="keyword">for</span> Mandarin Chinese Text Based on Two Variants of the Maximum Matching Algorithm</span><br><span class="line">Group:   System Environment/Daemons</span><br><span class="line">License: Free <span class="keyword">for</span> noncommercial use</span><br><span class="line">URL:     http://www.coreseek.cn/opensource/mmseg/</span><br><span class="line">Source0: http://www.coreseek.cn/uploads/csft/3.2/mmseg-3.2.14.tar.gz</span><br><span class="line">BuildRoot: %&#123;_tmppath&#125;/%&#123;name&#125;-%&#123;version&#125;-%&#123;release&#125;-root-%(%&#123;__id_u&#125; -n)</span><br><span class="line"></span><br><span class="line">%description</span><br><span class="line">A Word Identification System <span class="keyword">for</span> Mandarin Chinese Text Based on Two Variants of the Maximum Matching Algorithm</span><br><span class="line"></span><br><span class="line">%prep</span><br><span class="line">%setup -q -n %&#123;name&#125;-%&#123;version&#125;</span><br><span class="line"></span><br><span class="line">%build</span><br><span class="line">./bootstrap</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/mmseg</span><br><span class="line">make</span><br><span class="line"></span><br><span class="line">%install</span><br><span class="line">rm -rf <span class="variable">$RPM_BUILD_ROOT</span></span><br><span class="line">make DESTDIR=<span class="variable">$RPM_BUILD_ROOT</span> install</span><br><span class="line"></span><br><span class="line">%clean</span><br><span class="line">/bin/rm -rf <span class="variable">$RPM_BUILD_ROOT</span></span><br><span class="line">/bin/rm -rf <span class="variable">$RPM_BUILD_DIR</span>/%&#123;name&#125;-%&#123;version&#125;</span><br><span class="line"></span><br><span class="line">%files</span><br><span class="line">%defattr(-,root,root)</span><br><span class="line">%dir</span><br><span class="line">/usr/<span class="built_in">local</span>/mmseg</span><br><span class="line"></span><br><span class="line">%changelog</span><br></pre></td></tr></table></figure><p>CoreSeek描述文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">[root@salt SPECS]<span class="comment"># vi coreseek.spec</span></span><br><span class="line">Name: coreseek</span><br><span class="line">Version: 4.1b</span><br><span class="line">Release: 1%&#123;?dist&#125;</span><br><span class="line">Summary: 支持中文全文检索的Sphinx定制版本</span><br><span class="line">Group:   System Environment/Daemons</span><br><span class="line">License: GPLv2</span><br><span class="line">URL:     http://www.coreseek.cn/</span><br><span class="line">Source0: csft-4.1.tar.gz</span><br><span class="line">BuildRoot: %&#123;_tmppath&#125;/%&#123;name&#125;-%&#123;version&#125;-%&#123;release&#125;-root-%(%&#123;__id_u&#125; -n)</span><br><span class="line">Requires: mmseg</span><br><span class="line">Requires: mysql-devel</span><br><span class="line">Requires: libxml2-devel</span><br><span class="line">Requires: expat-devel</span><br><span class="line">Requires: python-devel</span><br><span class="line"></span><br><span class="line">Requires(post): chkconfig</span><br><span class="line">Requires(preun): chkconfig</span><br><span class="line">Requires(preun): initscripts</span><br><span class="line">Requires(postun): initscripts</span><br><span class="line"></span><br><span class="line">%description</span><br><span class="line">支持中文全文检索的Sphinx定制版本</span><br><span class="line"></span><br><span class="line">%prep</span><br><span class="line">%setup -q -n csft-4.1</span><br><span class="line"></span><br><span class="line">%build</span><br><span class="line">sh buildconf.sh</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/coreseek --without-unixodbc --with-mmseg --with-mmseg-includes=/usr/<span class="built_in">local</span>/mmseg/include/mmseg/ --with-mmseg-libs=/usr/<span class="built_in">local</span>/mmseg/lib/ --with-mysql --with-python</span><br><span class="line">make</span><br><span class="line"></span><br><span class="line">%install</span><br><span class="line">rm -rf <span class="variable">$RPM_BUILD_ROOT</span></span><br><span class="line">make DESTDIR=<span class="variable">$RPM_BUILD_ROOT</span> install</span><br><span class="line">mv <span class="variable">$RPM_BUILD_ROOT</span>/usr/<span class="built_in">local</span>/coreseek/etc/sphinx.conf.dist <span class="variable">$RPM_BUILD_ROOT</span>/usr/<span class="built_in">local</span>/coreseek/etc/sphinx.conf</span><br><span class="line">mkdir -p <span class="variable">$RPM_BUILD_ROOT</span>%&#123;_initrddir&#125;</span><br><span class="line">cp /etc/init.d/searchd <span class="variable">$RPM_BUILD_ROOT</span>%&#123;_initrddir&#125;/</span><br><span class="line"></span><br><span class="line">%clean</span><br><span class="line">/bin/rm -rf <span class="variable">$RPM_BUILD_ROOT</span></span><br><span class="line">/bin/rm -rf <span class="variable">$RPM_BUILD_DIR</span>/%&#123;name&#125;-%&#123;version&#125;</span><br><span class="line"></span><br><span class="line">%files</span><br><span class="line">%defattr(-,root,root)</span><br><span class="line"></span><br><span class="line">%attr(0755, root, root) %&#123;_initrddir&#125;/</span><br><span class="line">%config(noreplace) /usr/<span class="built_in">local</span>/coreseek/etc/sphinx.conf</span><br><span class="line">/usr/<span class="built_in">local</span>/coreseek/etc/example.sql</span><br><span class="line">/usr/<span class="built_in">local</span>/coreseek/etc/sphinx-min.conf.dist</span><br><span class="line"></span><br><span class="line">%dir</span><br><span class="line">/usr/<span class="built_in">local</span>/coreseek/bin</span><br><span class="line">/usr/<span class="built_in">local</span>/coreseek/share</span><br><span class="line">%attr(-, sphinx, root) /usr/<span class="built_in">local</span>/coreseek/var</span><br><span class="line"></span><br><span class="line">%preun</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$1</span> -eq 0 ] ; <span class="keyword">then</span></span><br><span class="line">    /sbin/service searchd stop &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">    /sbin/chkconfig --del searchd</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">%post</span><br><span class="line">cat /etc/passwd |grep -q <span class="string">'^sphinx:'</span></span><br><span class="line"><span class="keyword">if</span> (( $? != 0 )); <span class="keyword">then</span></span><br><span class="line">    /usr/sbin/groupadd -g 495 sphinx &amp;&gt;/dev/null</span><br><span class="line">    /usr/sbin/useradd -g 495 -u 495 -m -c <span class="string">'Sphinx Search'</span> -d /var/lib/sphinx -s /sbin/nologin www &amp;&gt;/dev/null</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">/sbin/chkconfig --add searchd</span><br><span class="line"></span><br><span class="line">%changelog</span><br></pre></td></tr></table></figure><p>searchd启动脚本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># sphinx searchd Free open-source SQL full-text search engine</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># chkconfig:   - 20 80</span></span><br><span class="line"><span class="comment"># description: Starts and stops the sphinx searchd daemon that handles \</span></span><br><span class="line"><span class="comment">#          all search requests.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### BEGIN INIT INFO</span></span><br><span class="line"><span class="comment"># Provides: searchd</span></span><br><span class="line"><span class="comment"># Required-Start: $local_fs $network</span></span><br><span class="line"><span class="comment"># Required-Stop: $local_fs $network</span></span><br><span class="line"><span class="comment"># Should-Start: $remote_fs</span></span><br><span class="line"><span class="comment"># Should-Stop: $remote_fs</span></span><br><span class="line"><span class="comment"># Default-Start: </span></span><br><span class="line"><span class="comment"># Default-Stop: 0 1 2 3 4 5 6</span></span><br><span class="line"><span class="comment"># Short-Description: start and stop sphinx searchd daemon</span></span><br><span class="line"><span class="comment"># Description: Sphinx is a free open-source SQL full-text search engine     </span></span><br><span class="line"><span class="comment">### END INIT INFO</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Source function library.</span></span><br><span class="line">. /etc/rc.d/init.d/<span class="built_in">functions</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span>=<span class="string">"/usr/local/coreseek/bin/searchd"</span></span><br><span class="line">prog=<span class="string">"searchd"</span></span><br><span class="line">config=<span class="string">"/usr/local/coreseek/etc/sphinx.conf"</span></span><br><span class="line">username=<span class="string">"sphinx"</span></span><br><span class="line"></span><br><span class="line">lockfile=/var/lock/subsys/searchd</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">start</span></span>() &#123;</span><br><span class="line">    [ -x <span class="variable">$exec</span> ] || <span class="built_in">exit</span> 5</span><br><span class="line">    [ -f <span class="variable">$config</span> ] || <span class="built_in">exit</span> 6</span><br><span class="line">    <span class="built_in">echo</span> -n $<span class="string">"Starting <span class="variable">$prog</span>: "</span></span><br><span class="line">    <span class="comment"># if not running, start it up here, usually something like "daemon $exec"</span></span><br><span class="line">    daemon --user=<span class="variable">$username</span> <span class="variable">$exec</span> --config <span class="variable">$config</span></span><br><span class="line">    retval=$?</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    [ <span class="variable">$retval</span> -eq 0 ] &amp;&amp; touch <span class="variable">$lockfile</span></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$retval</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">stop</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> -n $<span class="string">"Stopping <span class="variable">$prog</span>: "</span></span><br><span class="line">    <span class="comment"># stop it here, often "killproc $prog"</span></span><br><span class="line">    killproc <span class="variable">$prog</span></span><br><span class="line">    retval=$?</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    [ <span class="variable">$retval</span> -eq 0 ] &amp;&amp; rm -f <span class="variable">$lockfile</span></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$retval</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">restart</span></span>() &#123;</span><br><span class="line">    stop</span><br><span class="line">    start</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">reload</span></span>() &#123;</span><br><span class="line">    restart</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">force_reload</span></span>() &#123;</span><br><span class="line">    restart</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">rh_status</span></span>() &#123;</span><br><span class="line">    <span class="comment"># run checks to determine if the service is running or use generic status</span></span><br><span class="line">    status <span class="variable">$prog</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">rh_status_q</span></span>() &#123;</span><br><span class="line">    rh_status &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">    start)</span><br><span class="line">        rh_status_q &amp;&amp; <span class="built_in">exit</span> 0</span><br><span class="line">        <span class="variable">$1</span></span><br><span class="line">        ;;</span><br><span class="line">    stop)</span><br><span class="line">        rh_status_q || <span class="built_in">exit</span> 0</span><br><span class="line">        <span class="variable">$1</span></span><br><span class="line">        ;;</span><br><span class="line">    restart)</span><br><span class="line">        <span class="variable">$1</span></span><br><span class="line">        ;;</span><br><span class="line">    reload)</span><br><span class="line">        rh_status_q || <span class="built_in">exit</span> 7</span><br><span class="line">        <span class="variable">$1</span></span><br><span class="line">        ;;</span><br><span class="line">    force-reload)</span><br><span class="line">        force_reload</span><br><span class="line">        ;;</span><br><span class="line">    status)</span><br><span class="line">        rh_status</span><br><span class="line">        ;;</span><br><span class="line">    condrestart|try-restart)</span><br><span class="line">        rh_status_q || <span class="built_in">exit</span> 0</span><br><span class="line">        restart</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        <span class="built_in">echo</span> $<span class="string">"Usage: <span class="variable">$0</span> &#123;start|stop|status|restart|condrestart|try-restart|reload|force-reload&#125;"</span></span><br><span class="line">        <span class="built_in">exit</span> 2</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="built_in">exit</span> $?</span><br></pre></td></tr></table></figure><h2 id="6、打包"><a href="#6、打包" class="headerlink" title="6、打包"></a>6、打包</h2><p>执行下面命令为mmseg打包：</p><p>rpmbuild -ba mmseg.spec</p><p>如果没问题，软件包会根据服务器架构放置到相应目录中。如：/root/rpmbuild/RPMS/x86_64/mmseg-3.2.14-1.el6.x86_64.rpm</p><p>安装好编译的mmseg包再开始编译coreseek：</p><p>rpm -ivh /root/rpmbuild/RPMS/x86_64/mmseg-3.2.14-1.el6.x86_64.rpm</p><p>rpmbuild -ba coreseek.spec</p><p>完成后编译包为：/root/rpmbuild/RPMS/x86_64/coreseek-4.1b-1.el6.x86_64.rpm</p>]]></content>
    
    <summary type="html">
    
      如何将源代码打成rpm包？
    
    </summary>
    
      <category term="其他" scheme="https://istone.dev/categories/%E5%85%B6%E4%BB%96/"/>
    
    
      <category term="rpm" scheme="https://istone.dev/tags/rpm/"/>
    
      <category term="rpm-build" scheme="https://istone.dev/tags/rpm-build/"/>
    
  </entry>
  
  <entry>
    <title>CentOS 6.4 Puppet 3.2.4安装</title>
    <link href="https://istone.dev/2014/05/19/puppet-install/"/>
    <id>https://istone.dev/2014/05/19/puppet-install/</id>
    <published>2014-05-19T02:00:00.000Z</published>
    <updated>2019-06-26T09:29:19.888Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要描述puppet的安装、加固、Puppet-dashboard安装、Puppet模块、hiera使用以及自定义facts。</p><h2 id="1、在Puppet-Server和Puppet-Client上关闭防火墙和selinux"><a href="#1、在Puppet-Server和Puppet-Client上关闭防火墙和selinux" class="headerlink" title="1、在Puppet Server和Puppet Client上关闭防火墙和selinux"></a>1、在Puppet Server和Puppet Client上关闭防火墙和selinux</h2><p>清除防火墙设置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -F</span><br></pre></td></tr></table></figure><p>保存设置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/iptables save</span><br></pre></td></tr></table></figure><p>设置selinux为disable</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysconfig/selinux</span><br><span class="line">SELINUX=disabled</span><br></pre></td></tr></table></figure><h2 id="2、在Puppet-Server和Puppet-Client上设置hosts，puppet通过主机名区分各节点"><a href="#2、在Puppet-Server和Puppet-Client上设置hosts，puppet通过主机名区分各节点" class="headerlink" title="2、在Puppet Server和Puppet Client上设置hosts，puppet通过主机名区分各节点"></a>2、在Puppet Server和Puppet Client上设置hosts，puppet通过主机名区分各节点</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">10.10.10.10     puppet.example.com</span><br><span class="line">10.10.10.11     zabbix.example.com</span><br></pre></td></tr></table></figure><h2 id="3、在Puppet-Server和Puppet-Client上安装puppetlabs-com仓库"><a href="#3、在Puppet-Server和Puppet-Client上安装puppetlabs-com仓库" class="headerlink" title="3、在Puppet Server和Puppet Client上安装puppetlabs.com仓库"></a>3、在Puppet Server和Puppet Client上安装puppetlabs.com仓库</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y http://yum.puppetlabs.com/el/6Server/products/x86_64/puppetlabs-release-6-7.noarch.rpm</span><br></pre></td></tr></table></figure><h2 id="4、在Puppet-Server上安装puppet-server"><a href="#4、在Puppet-Server上安装puppet-server" class="headerlink" title="4、在Puppet Server上安装puppet-server"></a>4、在Puppet Server上安装puppet-server</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y puppet-server</span><br></pre></td></tr></table></figure><h2 id="5、在Puppet-Server上启动puppetmaster服务"><a href="#5、在Puppet-Server上启动puppetmaster服务" class="headerlink" title="5、在Puppet Server上启动puppetmaster服务"></a>5、在Puppet Server上启动puppetmaster服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># /etc/init.d/puppetmaster start</span></span><br><span class="line">启动 puppetmaster：                                        [确定]</span><br></pre></td></tr></table></figure><h2 id="6、在Puppet-Server上查看证书"><a href="#6、在Puppet-Server上查看证书" class="headerlink" title="6、在Puppet Server上查看证书"></a>6、在Puppet Server上查看证书</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># puppet cert list --all</span></span><br><span class="line">\+ <span class="string">"puppet.example.com"</span> (SHA256) 44:E4:8C:B2:F9:9D:38:3B:7C:68:7B:D3:21:0D:2F:64:B5:FB:8C:F7:78:85:BE:50:D9:A2:C7:CA:67:98:13:00 (alt names: <span class="string">"DNS:puppet"</span>, <span class="string">"DNS:puppet.example.com"</span>)</span><br></pre></td></tr></table></figure><h2 id="7、使用apache-passenger-运行puppet-server"><a href="#7、使用apache-passenger-运行puppet-server" class="headerlink" title="7、使用apache + passenger 运行puppet-server"></a>7、使用apache + passenger 运行puppet-server</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install httpd httpd-devel ruby-devel mod_ssl make gcc gcc-c++ curl-devel openssl-devel zlib-devel</span><br></pre></td></tr></table></figure><p>安装rack和passenger</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># gem install -v=1.5.2 rack</span></span><br><span class="line">Successfully installed rack-1.5.2</span><br><span class="line">1 gem installed</span><br><span class="line">Installing ri documentation <span class="keyword">for</span> rack-1.5.2...</span><br><span class="line">Installing RDoc documentation <span class="keyword">for</span> rack-1.5.2...</span><br><span class="line"></span><br><span class="line">[root@puppet ~]<span class="comment"># gem install -v=4.0.14 passenger</span></span><br><span class="line">Building native extensions.  This could take a <span class="keyword">while</span>...</span><br><span class="line">Successfully installed passenger-4.0.14</span><br><span class="line">1 gem installed</span><br><span class="line">Installing ri documentation <span class="keyword">for</span> passenger-4.0.14...</span><br><span class="line">Installing RDoc documentation <span class="keyword">for</span> passenger-4.0.14...</span><br></pre></td></tr></table></figure><p>编译passenger</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passenger-install-apache2-module</span><br></pre></td></tr></table></figure><p>配置Puppet rack应用：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/puppet/rack/</span><br><span class="line">mkdir /etc/puppet/rack/public /etc/puppet/rack/tmp</span><br><span class="line">cp /usr/share/puppet/ext/rack/example-passenger-vhost.conf /etc/httpd/conf.d/puppetmasterd.conf</span><br><span class="line">cp /usr/share/puppet/ext/rack/config.ru /etc/puppet/rack/</span><br><span class="line">chown -R puppet.puppet /etc/puppet/rack/</span><br><span class="line"></span><br><span class="line">ln -s /var/lib/puppet/ssl/ /etc/puppet/</span><br><span class="line"></span><br><span class="line">[root@puppet ~]<span class="comment"># vi /etc/httpd/conf.d/passenger.conf</span></span><br><span class="line">LoadModule passenger_module /usr/lib/ruby/gems/1.8/gems/passenger-4.0.14/buildout/apache2/mod_passenger.so</span><br><span class="line">PassengerRoot /usr/lib/ruby/gems/1.8/gems/passenger-4.0.14</span><br><span class="line">PassengerDefaultRuby /usr/bin/ruby</span><br><span class="line">PassengerMaxPoolSize 30</span><br><span class="line">PassengerPoolIdleTime 1500</span><br><span class="line">PassengerMaxRequests 1000</span><br><span class="line">PassengerStatThrottleRate 120</span><br></pre></td></tr></table></figure><p>如下修改puppetmasterd.conf</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/httpd/conf.d/puppetmasterd.conf</span><br><span class="line"></span><br><span class="line">Listen <span class="number">8140</span></span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *<span class="symbol">:</span><span class="number">8140</span>&gt;</span><br><span class="line">        SSLEngine on</span><br><span class="line">        SSLProtocol -ALL +SSLv3 +TLSv1</span><br><span class="line">        SSLCipherSuite <span class="symbol">ALL:</span>!<span class="symbol">ADH:</span>RC4+<span class="symbol">RSA:</span>+<span class="symbol">HIGH:</span>+<span class="symbol">MEDIUM:</span>-<span class="symbol">LOW:</span>-<span class="symbol">SSLv2:</span>-EXP</span><br><span class="line"></span><br><span class="line">        SSLCertificateFile      /etc/puppet/ssl/certs/puppet.example.com.pem</span><br><span class="line">        SSLCertificateKeyFile   /etc/puppet/ssl/private_keys/puppet.example.com.pem</span><br><span class="line">        SSLCertificateChainFile /etc/puppet/ssl/ca/ca_crt.pem</span><br><span class="line">        SSLCACertificateFile    /etc/puppet/ssl/ca/ca_crt.pem</span><br><span class="line">        <span class="comment"># If Apache complains about invalid signatures on the CRL, you can try disabling</span></span><br><span class="line">        <span class="comment"># CRL checking by commenting the next line, but this is not recommended.</span></span><br><span class="line">        SSLCARevocationFile     /etc/puppet/ssl/ca/ca_crl.pem</span><br><span class="line">        SSLVerifyClient optional</span><br><span class="line">        SSLVerifyDepth  <span class="number">1</span></span><br><span class="line">        <span class="comment"># The `ExportCertData` option is needed for agent certificate expiration warnings</span></span><br><span class="line">        SSLOptions +StdEnvVars +ExportCertData</span><br><span class="line"></span><br><span class="line">        <span class="comment"># This header needs to be set if using a loadbalancer or proxy</span></span><br><span class="line">        RequestHeader unset X-Forwarded-For</span><br><span class="line"></span><br><span class="line">        RequestHeader set X-SSL-Subject <span class="string">%&#123;SSL_CLIENT_S_DN&#125;</span>e</span><br><span class="line">        RequestHeader set X-Client-DN <span class="string">%&#123;SSL_CLIENT_S_DN&#125;</span>e</span><br><span class="line">        RequestHeader set X-Client-Verify <span class="string">%&#123;SSL_CLIENT_VERIFY&#125;</span>e</span><br><span class="line"></span><br><span class="line">        DocumentRoot /etc/puppet/rack/public/</span><br><span class="line">        RackBaseURI /</span><br><span class="line">        &lt;Directory /etc/puppet/rack/public/&gt;</span><br><span class="line">                Options None</span><br><span class="line">                AllowOverride None</span><br><span class="line">                Order allow,deny</span><br><span class="line">                allow from all</span><br><span class="line">        &lt;<span class="regexp">/Directory&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>VirtualHost&gt;</span><br></pre></td></tr></table></figure><p>设置apache以puppet用户启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/httpd/conf/httpd.conf</span><br><span class="line">User puppet</span><br><span class="line">Group puppet</span><br></pre></td></tr></table></figure><p>设置 /etc/puppet/puppet.conf</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># vi /etc/puppet/puppet.conf</span></span><br><span class="line">[main]</span><br><span class="line">    <span class="comment"># The Puppet log directory.</span></span><br><span class="line">    <span class="comment"># The default value is '$vardir/log'.</span></span><br><span class="line">    logdir = <span class="regexp">/var/log</span><span class="regexp">/puppet</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    # Where Puppet PID files are kept.</span></span><br><span class="line"><span class="regexp">    # The default value is '$vardir/run</span><span class="string">'.</span></span><br><span class="line"><span class="string">    rundir = /var/run/puppet</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    # Where SSL certificates are kept.</span></span><br><span class="line"><span class="string">    # The default value is '</span>$confdir/ssl<span class="string">'.</span></span><br><span class="line"><span class="string">    ssldir = $vardir/ssl</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[master]</span></span><br><span class="line"><span class="string">    ssl_client_header = SSL_CLIENT_S_DN</span></span><br><span class="line"><span class="string">    ssl_client_verify_header = SSL_CLIENT_VERIFY</span></span><br><span class="line"><span class="string">    autosign = true</span></span><br><span class="line"><span class="string">    reports = store</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[agent]</span></span><br><span class="line"><span class="string">    # The file in which puppetd stores a list of the classes</span></span><br><span class="line"><span class="string">    # associated with the retrieved configuratiion.  Can be loaded in</span></span><br><span class="line"><span class="string">    # the separate ``puppet`` executable using the ``--loadclasses``</span></span><br><span class="line"><span class="string">    # option.</span></span><br><span class="line"><span class="string">    # The default value is '</span>$confdir/classes.txt<span class="string">'.</span></span><br><span class="line"><span class="string">    classfile = $vardir/classes.txt</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    # Where puppetd caches the local configuration.  An</span></span><br><span class="line"><span class="string">    # extension indicating the cache format is added automatically.</span></span><br><span class="line"><span class="string">    # The default value is '</span>$confdir/localconfig<span class="string">'.</span></span><br><span class="line"><span class="string">    localconfig = $vardir/localconfig</span></span><br></pre></td></tr></table></figure><p>配置 /etc/sysconfig/puppetmaster</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># vi /etc/sysconfig/puppetmaster</span></span><br><span class="line"><span class="comment"># Location of the main manifest</span></span><br><span class="line"><span class="comment">#PUPPETMASTER_MANIFEST=/etc/puppet/manifests/site.pp</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Where to log general messages to.</span></span><br><span class="line"><span class="comment"># Specify syslog to send log messages to the system log.</span></span><br><span class="line"><span class="comment">#PUPPETMASTER_LOG=syslog</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># You may specify an alternate port on which your puppetmaster should listen. Default is: 8140</span></span><br><span class="line"><span class="comment"># An example with puppetmaster on a different port, run with standard webrick servertype</span></span><br><span class="line"><span class="comment">#PUPPETMASTER_PORTS="8141"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># You may specify other parameters to the puppetmaster here</span></span><br><span class="line"><span class="comment">#PUPPETMASTER_EXTRA_OPTS=--no-ca</span></span><br><span class="line">PUPPETMASTER_EXTRA_OPTS=<span class="string">"--reports store"</span></span><br></pre></td></tr></table></figure><p>配置文件服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># vi /etc/puppet/fileserver.conf</span></span><br><span class="line"> [files]</span><br><span class="line">    path /etc/puppet/files</span><br><span class="line">    allow *</span><br><span class="line"></span><br><span class="line">[modules]</span><br><span class="line">    allow *</span><br><span class="line"></span><br><span class="line">[plugins]</span><br><span class="line">    allow *</span><br></pre></td></tr></table></figure><p>创建文件发布目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/puppet/files</span><br></pre></td></tr></table></figure><h2 id="8、在Puppet-Server上配置puppet-manifests和module"><a href="#8、在Puppet-Server上配置puppet-manifests和module" class="headerlink" title="8、在Puppet Server上配置puppet manifests和module"></a>8、在Puppet Server上配置puppet manifests和module</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet puppet]<span class="comment"># cd manifests/</span></span><br></pre></td></tr></table></figure><p>创建site.pp，此为puppet入口配置文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]<span class="comment"># vi site.pp</span></span><br><span class="line">import <span class="string">"roles.pp"</span></span><br><span class="line">import <span class="string">"nodes.pp"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># General settings for standard types</span></span><br><span class="line">Exec &#123; path =&gt; <span class="string">"/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin"</span> &#125;</span><br><span class="line"></span><br><span class="line">filebucket &#123; main: server =&gt; <span class="string">"puppet.example.com"</span>, path =&gt; <span class="literal">false</span> &#125;</span><br><span class="line">File &#123; backup =&gt; main &#125;</span><br></pre></td></tr></table></figure><p>创建roles.pp，用于定义服务器角色：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]<span class="comment"># vi roles.pp</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">baseclass</span> &#123;</span></span><br><span class="line">        <span class="keyword">include</span> test</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建nodes.pp，用于配置服务器节点：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]<span class="comment"># vi nodes.pp</span></span><br><span class="line">node <span class="string">'basenode'</span> &#123;</span><br><span class="line">        <span class="keyword">include</span> baseclass</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">node <span class="string">'zabbix.example.com'</span> inherits basenode &#123;</span><br><span class="line">        tag(<span class="string">"test"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建一个test模块：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet manifests]<span class="comment"># cd ..</span></span><br><span class="line">[root@puppet puppet]<span class="comment"># mkdir modules</span></span><br><span class="line">[root@puppet modules]<span class="comment"># mkdir -p test/manifests/</span></span><br><span class="line">[root@puppet modules]<span class="comment"># mkdir test/files/</span></span><br><span class="line">[root@puppet modules]<span class="comment"># cd test/files/</span></span><br><span class="line">[root@puppet files]<span class="comment"># vi test.txt</span></span><br><span class="line"><span class="built_in">test</span> line！</span><br></pre></td></tr></table></figure><p>创建test类，用来下发一个文件到客户端：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet files]<span class="comment"># cd ../manifests/</span></span><br><span class="line">[root@puppet manifests]<span class="comment"># vi init.pp</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span> &#123;</span></span><br><span class="line">        file &#123; <span class="string">"/tmp/test.txt"</span><span class="symbol">:</span></span><br><span class="line">                <span class="keyword">ensure</span>  =&gt; present,</span><br><span class="line">                group   =&gt; <span class="string">"root"</span>,</span><br><span class="line">                owner   =&gt; <span class="string">"root"</span>,</span><br><span class="line">                mode    =&gt; <span class="string">"0644"</span>,</span><br><span class="line">                source  =&gt; <span class="string">"puppet:///test/test.txt"</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="9、启动puppet-server"><a href="#9、启动puppet-server" class="headerlink" title="9、启动puppet server"></a>9、启动puppet server</h2><p>开机启动httpd服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># chkconfig --level 2345 httpd on</span></span><br></pre></td></tr></table></figure><p>启动apache服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># /etc/init.d/httpd start</span></span><br><span class="line">[root@puppet ~]<span class="comment"># netstat -tunlp</span></span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name</span><br><span class="line">tcp        0      0 127.0.0.1:37964             0.0.0.0:*                   LISTEN      7358/Passenger Rack</span><br><span class="line">tcp        0      0 :::8140                     :::*                        LISTEN      7297/httpd</span><br></pre></td></tr></table></figure><h2 id="10、配置puppet-client"><a href="#10、配置puppet-client" class="headerlink" title="10、配置puppet client"></a>10、配置puppet client</h2><p>安装puppet</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]<span class="comment"># yum install -y puppet</span></span><br></pre></td></tr></table></figure><p>配置/etc/puppet/puppet.conf</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]<span class="comment"># vi /etc/puppet/puppet.conf</span></span><br><span class="line">[main]</span><br><span class="line">    <span class="comment"># The Puppet log directory.</span></span><br><span class="line">    <span class="comment"># The default value is '$vardir/log'.</span></span><br><span class="line">    logdir = /var/<span class="built_in">log</span>/puppet</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Where Puppet PID files are kept.</span></span><br><span class="line">    <span class="comment"># The default value is '$vardir/run'.</span></span><br><span class="line">    rundir = /var/run/puppet</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Where SSL certificates are kept.</span></span><br><span class="line">    <span class="comment"># The default value is '$confdir/ssl'.</span></span><br><span class="line">    ssldir = <span class="variable">$vardir</span>/ssl</span><br><span class="line"></span><br><span class="line">[agent]</span><br><span class="line">    <span class="comment"># The file in which puppetd stores a list of the classes</span></span><br><span class="line">    <span class="comment"># associated with the retrieved configuratiion.  Can be loaded in</span></span><br><span class="line">    <span class="comment"># the separate ``puppet`` executable using the ``--loadclasses``</span></span><br><span class="line">    <span class="comment"># option.</span></span><br><span class="line">    <span class="comment"># The default value is '$confdir/classes.txt'.</span></span><br><span class="line">    classfile = <span class="variable">$vardir</span>/classes.txt</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Where puppetd caches the local configuration.  An</span></span><br><span class="line">    <span class="comment"># extension indicating the cache format is added automatically.</span></span><br><span class="line">    <span class="comment"># The default value is '$confdir/localconfig'.</span></span><br><span class="line">    localconfig = <span class="variable">$vardir</span>/localconfig</span><br><span class="line"></span><br><span class="line">    report = <span class="literal">true</span>  <span class="comment"># 设置发送报告</span></span><br><span class="line"></span><br><span class="line">    listen = <span class="literal">true</span>  <span class="comment"># 设置为守护进程</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置puppet server地址</span></span><br><span class="line">    server = puppet.example.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 禁用插件同步，puppet 3.0默认开启，如果没有配置插件会报错</span></span><br><span class="line">    pluginsync=<span class="literal">false</span></span><br></pre></td></tr></table></figure><p>配置/etc/sysconfig/puppet</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]<span class="comment"># vi /etc/sysconfig/puppet</span></span><br><span class="line"><span class="comment"># The puppetmaster server</span></span><br><span class="line">PUPPET_SERVER=puppet.example.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># If you wish to specify the port to connect to do so here</span></span><br><span class="line"><span class="comment">#PUPPET_PORT=8140</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Where to log to. Specify syslog to send log messages to the system log.</span></span><br><span class="line"><span class="comment">#PUPPET_LOG=/var/log/puppet/puppet.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># You may specify other parameters to the puppet client here</span></span><br><span class="line"><span class="comment">#PUPPET_EXTRA_OPTS=--waitforcert=500</span></span><br><span class="line"></span><br><span class="line">[root@zabbix ~]<span class="comment"># vi namespaceauth.conf</span></span><br><span class="line">[puppetrunner]    allow puppet.example.com</span><br><span class="line">[root@zabbix ~]<span class="comment">#  vi auth.conf</span></span><br><span class="line"><span class="comment"># 在最后一行添加allow *</span></span><br><span class="line">......</span><br><span class="line">path /</span><br><span class="line">auth any</span><br><span class="line"></span><br><span class="line">allow *</span><br></pre></td></tr></table></figure><p>设置puppet开机自动启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]<span class="comment"># chkconfig puppet on</span></span><br></pre></td></tr></table></figure><p>测试客户端</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]<span class="comment"># puppet agent --test --debug</span></span><br></pre></td></tr></table></figure><p>如果Puppet Server没有设置：autosign = true，需要在Puppet Server上执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># puppet cert list</span></span><br><span class="line">zabbix.example.com</span><br><span class="line">[root@puppet ~]<span class="comment"># puppet cert sign zabbix.example.com</span></span><br></pre></td></tr></table></figure><p>这样为zabbix.example.com签名。然后回到客户端再次执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]<span class="comment"># puppet agent --test --debug</span></span><br></pre></td></tr></table></figure><p>文件已同步</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]<span class="comment"># cat /tmp/test.txt</span></span><br><span class="line"><span class="built_in">test</span> line.</span><br></pre></td></tr></table></figure><p>启动puppet客户端服务，自动抓取配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]<span class="comment"># service puppet start</span></span><br><span class="line">[root@zabbix ~]<span class="comment"># netstat -tunlp</span></span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name</span><br><span class="line">tcp        0      0 0.0.0.0:8139                0.0.0.0:*                   LISTEN      3413/ruby</span><br></pre></td></tr></table></figure><p>也可以在Puppet Server上进行推送：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># puppet kick -d --host zabbix.example.com</span></span><br><span class="line">Triggering zabbix.example.com</span><br><span class="line">Getting status</span><br><span class="line">status is success</span><br><span class="line">zabbix.example.com finished with <span class="built_in">exit</span> code 0</span><br><span class="line">Finished</span><br></pre></td></tr></table></figure><p>返回0说明触发客户端上的puppetd成功。</p><h2 id="11、在Puppet-Server上安装puppetdb"><a href="#11、在Puppet-Server上安装puppetdb" class="headerlink" title="11、在Puppet Server上安装puppetdb"></a>11、在Puppet Server上安装puppetdb</h2><p>安装puppetdb</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># puppet resource package puppetdb ensure=latest</span></span><br><span class="line">Notice: /Package[puppetdb]/ensure: created</span><br><span class="line">package &#123; <span class="string">'puppetdb'</span>:</span><br><span class="line">  ensure =&gt; <span class="string">'1.4.0-1.el6'</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>启动puppetdb并设置开机自启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># puppet resource service puppetdb ensure=running enable=true</span></span><br><span class="line">Notice: /Service[puppetdb]/ensure: ensure changed <span class="string">'stopped'</span> to <span class="string">'running'</span></span><br><span class="line">service &#123; <span class="string">'puppetdb'</span>:</span><br><span class="line">  ensure =&gt; <span class="string">'running'</span>,</span><br><span class="line">  <span class="built_in">enable</span> =&gt; <span class="string">'true'</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>查看启动日志</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># cat /var/log/puppetdb/puppetdb.log</span></span><br><span class="line">2013-08-25 09:46:29,823 INFO  [main] [cli.services] Starting 1 <span class="built_in">command</span> processor threads</span><br><span class="line">2013-08-25 09:46:29,845 INFO  [main] [cli.services] Starting query server</span><br><span class="line">2013-08-25 09:46:29,870 INFO  [pool-2-thread-1] [cli.services] Starting database garbage collection</span><br><span class="line">2013-08-25 09:46:29,904 INFO  [clojure-agent-send-off-pool-2] [server.Server] jetty-7.x.y-SNAPSHOT</span><br><span class="line">2013-08-25 09:46:29,906 INFO  [pool-2-thread-1] [cli.services] Finished database garbage collection</span><br><span class="line">2013-08-25 09:46:29,921 INFO  [pool-2-thread-1] [cli.services] Starting sweep of stale reports (threshold: 14 days)</span><br><span class="line">2013-08-25 09:46:29,933 INFO  [pool-2-thread-1] [cli.services] Finished sweep of stale reports (threshold: 14 days)</span><br><span class="line">2013-08-25 09:46:30,059 INFO  [clojure-agent-send-off-pool-2] [server.AbstractConnector] Started SelectChannelConnector@localhost:8080</span><br><span class="line">2013-08-25 09:46:30,515 INFO  [clojure-agent-send-off-pool-2] [ssl.SslContextFactory] Enabled Protocols [SSLv2Hello, SSLv3, TLSv1] of [SSLv2Hello, SSLv3, TLSv1]</span><br><span class="line">2013-08-25 09:46:30,530 INFO  [clojure-agent-send-off-pool-2] [server.AbstractConnector] Started SslSelectChannelConnector@puppet.example.com:8081</span><br></pre></td></tr></table></figure><p>查看启动端口</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># netstat -tunlp</span></span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name</span><br><span class="line"></span><br><span class="line">tcp        0      0 ::ffff:127.0.0.1:8080       :::*                        LISTEN      6757/java</span><br><span class="line">tcp        0      0 ::ffff:10.10.10.10:8081     :::*                        LISTEN      6757/java</span><br></pre></td></tr></table></figure><p>配置puppet server连接到puppetdb<br>安装puppetdb-terminus插件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># puppet resource package puppetdb-terminus ensure=latest</span></span><br><span class="line">Notice: /Package[puppetdb-terminus]/ensure: created</span><br><span class="line">package &#123; <span class="string">'puppetdb-terminus'</span>:</span><br><span class="line">[main]</span><br><span class="line">  ensure =&gt; <span class="string">'1.4.0-1.el6'</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在/etc/puppet下新建puppetdb.conf，并输入puppetdb server和port</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># cd /etc/puppet</span></span><br><span class="line">[root@puppet puppet]<span class="comment"># vi puppetdb.conf</span></span><br><span class="line">[main]</span><br><span class="line">server = puppet.example.com</span><br><span class="line">port = 8081</span><br></pre></td></tr></table></figure><p>配置puppet server连接到puppetdb</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet puppet]<span class="comment"># vi puppet.conf</span></span><br><span class="line">[master]</span><br><span class="line">    ……</span><br><span class="line">    storeconfigs = <span class="literal">true</span></span><br><span class="line">    storeconfigs_backend = puppetdb</span><br></pre></td></tr></table></figure><p>在/etc/puppet下新建routes.yaml</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet puppet]<span class="comment"># vi routes.yaml</span></span><br><span class="line">---</span><br><span class="line">master:</span><br><span class="line">  facts:</span><br><span class="line">    terminus: puppetdb</span><br><span class="line">    cache: yaml</span><br></pre></td></tr></table></figure><p>重启puppet server</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet puppet]<span class="comment"># /etc/init.d/httpd restart</span></span><br><span class="line">停止 httpd：                                               [确定]</span><br><span class="line">正在启动 httpd：                                           [确定]</span><br></pre></td></tr></table></figure><p>在puppet客户端（[zabbix.example.com）执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]<span class="comment"># puppet agent --test --debug</span></span><br></pre></td></tr></table></figure><p>查看日志，发现zabbix.example.com已推送facts和catalog到puppetdb</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet puppet]<span class="comment"># tail -f /var/log/puppetdb/puppetdb.log</span></span><br><span class="line"></span><br><span class="line">2013-08-25 10:12:52,606 INFO  [<span class="built_in">command</span>-proc-46] [puppetdb.command] [af698348-275d-45ac-9ea9-017c4b1e6947] [replace facts] zabbix.example.com</span><br><span class="line">2013-08-25 10:12:53,824 INFO  [<span class="built_in">command</span>-proc-46] [puppetdb.command] [8d7029f9-e147-4b9f-8076-4b26e21d7a9f] [replace catalog] zabbix.example.com</span><br></pre></td></tr></table></figure><p>参考文档：<a href="http://docs.puppetlabs.com/puppetdb/1.4/install_from_packages.html" target="_blank" rel="noopener">http://docs.puppetlabs.com/puppetdb/1.4/install_from_packages.html</a></p><h2 id="12、在Puppet-Server上安装puppet-dashboard"><a href="#12、在Puppet-Server上安装puppet-dashboard" class="headerlink" title="12、在Puppet Server上安装puppet-dashboard"></a>12、在Puppet Server上安装puppet-dashboard</h2><p>安装MySQL</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># yum install -y mysql mysql-devel mysql-server</span></span><br></pre></td></tr></table></figure><p>配置MySQL</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># vi /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="built_in">bind</span>=10.10.10.10</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">user=mysql</span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links=0</span><br><span class="line"><span class="comment"># Allowing 32MB allows an occasional 17MB row with plenty of spare room</span></span><br><span class="line">max_allowed_packet = 32M</span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line"><span class="built_in">log</span>-error=/var/<span class="built_in">log</span>/mysqld.log</span><br><span class="line">pid-file=/var/run/mysqld/mysqld.pid</span><br></pre></td></tr></table></figure><p>启动MySQL</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># /etc/init.d/mysqld start</span></span><br><span class="line"></span><br><span class="line">正在启动 mysqld：                                          [确定]</span><br><span class="line">[root@puppet ~]<span class="comment"># netstat -tunlp</span></span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name</span><br><span class="line">tcp        0      0 10.10.10.10:3306            0.0.0.0:*                   LISTEN      11677/mysqld</span><br></pre></td></tr></table></figure><p>开机自动启动MySQL</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># chkconfig --level 2345 mysqld on</span></span><br></pre></td></tr></table></figure><p>创建一个dashboard数据库</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># mysql -uroot</span></span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2</span><br><span class="line">Server version: 5.1.69 Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">'help;'</span> or <span class="string">'\h'</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">'\c'</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; CREATE DATABASE dashboard CHARACTER SET utf8;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; CREATE USER <span class="string">'dashboard'</span>@<span class="string">'10.10.10.10'</span> IDENTIFIED BY <span class="string">'dashboard@puppet$'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON dashboard.* TO <span class="string">'dashboard'</span>@<span class="string">'10.10.10.10'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; quit</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure><p>安装puppet-dashboard</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># yum install -y puppet-dashboard</span></span><br></pre></td></tr></table></figure><p>配置Dashboard</p><p>编辑 /usr/share/puppet-dashboard/config/database.yml</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># vi /usr/share/puppet-dashboard/config/database.yml</span></span><br><span class="line">production:</span><br><span class="line">  database: dashboard</span><br><span class="line">  username: dashboard</span><br><span class="line">  password: dashboard@puppet$</span><br><span class="line">  encoding: utf8</span><br><span class="line">  adapter: mysql</span><br><span class="line">  host: 10.10.10.10</span><br></pre></td></tr></table></figure><p>修改时区 /usr/share/puppet-dashboard/config/environment.rb</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># vi /usr/share/puppet-dashboard/config/environment.rb</span></span><br><span class="line"><span class="comment"># config.time_zone = 'UTC'</span></span><br><span class="line">config.time_zone = <span class="string">'Beijing'</span></span><br></pre></td></tr></table></figure><p>初始化数据库</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># cd /usr/share/puppet-dashboard/</span></span><br><span class="line">[root@puppet puppet-dashboard]<span class="comment"># rake RAILS_ENV=production db:migrate</span></span><br></pre></td></tr></table></figure><p>配置apache</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet puppet-dashboard]<span class="comment"># vi /etc/httpd/conf.d/dashboard.conf</span></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">   ServerName puppet.example.com</span><br><span class="line">   DocumentRoot <span class="string">"/usr/share/puppet-dashboard/public/"</span></span><br><span class="line">   &lt;Directory <span class="string">"/usr/share/puppet-dashboard/public/"</span>&gt;</span><br><span class="line">      Options None</span><br><span class="line">      AllowOverride AuthConfig</span><br><span class="line">      Order allow,deny</span><br><span class="line">      allow from all</span><br><span class="line">   &lt;/Directory&gt;</span><br><span class="line">   ErrorLog /var/<span class="built_in">log</span>/httpd/puppet.example.com_error.log</span><br><span class="line">   LogLevel warn</span><br><span class="line">   CustomLog /var/<span class="built_in">log</span>/httpd/puppet.example.com_access.log combined</span><br><span class="line">   ServerSignature On</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure><p>配置Puppet报告到Dashboard</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet puppet-dashboard]<span class="comment"># cd</span></span><br><span class="line">[root@puppet ~]<span class="comment"># vi /etc/puppet/puppet.conf</span></span><br><span class="line">[master]</span><br><span class="line">    ssl_client_header = SSL_CLIENT_S_DN</span><br><span class="line">    ssl_client_verify_header = SSL_CLIENT_VERIFY</span><br><span class="line">    autosign = <span class="literal">true</span></span><br><span class="line">    reports = store, http</span><br><span class="line">    reporturl = http://puppet.example.com/reports/upload</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure><p>配置/etc/sysconfig/puppetmaster</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># vi /etc/sysconfig/puppetmaster</span></span><br><span class="line">PUPPETMASTER_EXTRA_OPTS=<span class="string">"--reports store, puppet_dashboard"</span></span><br></pre></td></tr></table></figure><p>重启apache使配置生效</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># /etc/init.d/httpd restart</span></span><br><span class="line">停止 httpd：                                               [确定]</span><br><span class="line">正在启动 httpd：                                           [确定]</span><br></pre></td></tr></table></figure><p>导入已有报告</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># cd /usr/share/puppet-dashboard</span></span><br><span class="line">[root@puppet puppet-dashboard]<span class="comment">#</span></span><br><span class="line">[root@puppet puppet-dashboard]<span class="comment"># rake RAILS_ENV=production reports:import</span></span><br><span class="line">Importing 29 reports from /var/lib/puppet/reports <span class="keyword">in</span> the background</span><br><span class="line">Importing:     100% |<span class="comment">#############################################################################################################################################| Time: 00:00:00</span></span><br><span class="line">29 of 29 reports queued</span><br></pre></td></tr></table></figure><p>启动dashboard报告分析进程</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># chown -R puppet-dashboard /usr/share/puppet-dashboard/tmp/pids/</span></span><br><span class="line">[root@puppet ~]<span class="comment"># /etc/init.d/puppet-dashboard-workers start</span></span><br><span class="line">正在启动 puppet-dashboard-workers：                        [确定]</span><br><span class="line">[root@puppet ~]<span class="comment"># chkconfig --level 2345 puppet-dashboard-workers on</span></span><br></pre></td></tr></table></figure><p>以上启动脚本有问题，如下启动：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env RAILS_ENV=production /usr/share/puppet-dashboard/script/delayed_job -p dashboard -n 4 -m start</span><br></pre></td></tr></table></figure><p>配置Inventory服务（使用puppetdb）</p><p>配置/usr/share/puppet-dashboard/config/settings.yml</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># vi /usr/share/puppet-dashboard/config/settings.yml</span></span><br><span class="line"><span class="comment"># Node name to use when contacting the puppet master.  This is the</span></span><br><span class="line"><span class="comment"># CN that is used in Dashboard's certificate.</span></span><br><span class="line">cn_name: <span class="string">'puppet.example.com'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ca_crl_path: <span class="string">'certs/puppet.example.com.ca_crl.pem'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ca_certificate_path: <span class="string">'certs/puppet.example.com.ca_cert.pem'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">certificate_path: <span class="string">'certs/puppet.example.com.cert.pem'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">private_key_path: <span class="string">'certs/puppet.example.com.private_key.pem'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public_key_path: <span class="string">'certs/puppet.example.com.public_key.pem'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Hostname of the certificate authority.</span></span><br><span class="line">ca_server: <span class="string">'puppet.example.com'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Port for the certificate authority.</span></span><br><span class="line">ca_port: 8140</span><br><span class="line"></span><br><span class="line"><span class="comment"># Key length for SSL certificates</span></span><br><span class="line">key_length: 1024</span><br><span class="line"></span><br><span class="line"><span class="comment"># The "inventory service" allows you to connect to a puppet master to retrieve and node facts</span></span><br><span class="line">enable_inventory_service: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Hostname of the inventory server.</span></span><br><span class="line">inventory_server: <span class="string">'puppet.example.com'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Port for the inventory server.</span></span><br><span class="line">inventory_port: 8140</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set this to true to allow Dashboard to display diffs on files that</span></span><br><span class="line"><span class="comment"># are archived in the file bucket.</span></span><br><span class="line">use_file_bucket_diffs: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Hostname of the file bucket server.</span></span><br><span class="line">file_bucket_server: <span class="string">'puppet.example.com'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Port for the file bucket server.</span></span><br><span class="line">file_bucket_port: 8140</span><br></pre></td></tr></table></figure><p>配置puppet授权访问文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># vi /etc/puppet/auth.conf</span></span><br><span class="line">……</span><br><span class="line"></span><br><span class="line">path /facts</span><br><span class="line">auth any</span><br><span class="line">allow *</span><br><span class="line"></span><br><span class="line">path /facts_search</span><br><span class="line">allow *</span><br><span class="line"></span><br><span class="line"><span class="comment"># deny everything else; this ACL is not strictly necessary, but</span></span><br><span class="line"><span class="comment"># illustrates the default policy.</span></span><br><span class="line">path /</span><br><span class="line">auth any</span><br></pre></td></tr></table></figure><p>重启puppet server</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># /etc/init.d/httpd restart</span></span><br><span class="line">停止 httpd：                                               [确定]</span><br><span class="line">正在启动 httpd：                                           [确定]</span><br></pre></td></tr></table></figure><p>访问puppet dashboard</p><p>参考文档：<a href="http://docs.puppetlabs.com/guides/inventory_service.htmlInventory" target="_blank" rel="noopener">http://docs.puppetlabs.com/guides/inventory_service.htmlInventory</a> </p><h2 id="13、编写Puppet模块"><a href="#13、编写Puppet模块" class="headerlink" title="13、编写Puppet模块"></a>13、编写Puppet模块</h2><p>可以从<a href="http://forge.puppetlabs.com/" target="_blank" rel="noopener">http://forge.puppetlabs.com/</a> 和<a href="https://github.com查找共享的Puppet模块。" target="_blank" rel="noopener">https://github.com查找共享的Puppet模块。</a></p><p>以ntp模块为例，从github下载代码放到/etc/puppet/modules/</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># cd /etc/puppet/modules/</span></span><br><span class="line">[root@puppet modules]<span class="comment"># git clone https://github.com/puppetlabs/puppetlabs-ntp.git</span></span><br><span class="line">[root@puppet modules]<span class="comment"># mv puppetlabs_ntp ntp</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载ntp依赖的stdlib模块</span></span><br><span class="line">[root@puppet modules]<span class="comment"># git clone https://github.com/puppetlabs/puppetlabs-stdlib.git</span></span><br><span class="line">[root@puppet modules]<span class="comment"># mv puppetlabs_stdlib stdlib</span></span><br></pre></td></tr></table></figure><p>参考文档：<a href="http://docs.puppetlabs.com/puppet/3/reference/modules_fundamentals.html" target="_blank" rel="noopener">http://docs.puppetlabs.com/puppet/3/reference/modules_fundamentals.html</a></p><p>参考文档：stdlib</p><p><a href="http://puppetlabs.com/blog/module-of-the-week-puppetlabsstdlib-puppet-labs-standard-library" target="_blank" rel="noopener">http://puppetlabs.com/blog/module-of-the-week-puppetlabsstdlib-puppet-labs-standard-library</a></p><p><a href="http://puppetlabs.com/blog/module-of-the-week-puppetlabs-stdlib-puppet-labs-standard-library-part-2" target="_blank" rel="noopener">http://puppetlabs.com/blog/module-of-the-week-puppetlabs-stdlib-puppet-labs-standard-library-part-2</a></p><p><a href="http://puppetlabs.com/blog/module-of-the-week-puppetlabsstdlib-puppetlabs-standard-library-part-3" target="_blank" rel="noopener">http://puppetlabs.com/blog/module-of-the-week-puppetlabsstdlib-puppetlabs-standard-library-part-3</a></p><p><a href="http://puppetlabs.com/blog/module-of-the-week-puppetlabs-stdlib-puppet-labs-standard-library-part-4" target="_blank" rel="noopener">http://puppetlabs.com/blog/module-of-the-week-puppetlabs-stdlib-puppet-labs-standard-library-part-4</a></p><h2 id="14、使用hiera"><a href="#14、使用hiera" class="headerlink" title="14、使用hiera"></a>14、使用hiera</h2><p>将数据放到hiera中可以更好的复用puppet代码。</p><p>安装hiera</p><p>hiera已经内置在puppet 3.x中，如果puppet版本是2.7.x需要单独安装hiera、hiera-puppet</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">puppet resource package hiera ensure=installed</span><br><span class="line">puppet resource package hiera-puppet ensure=installed</span><br></pre></td></tr></table></figure><p>参考文档：hiera安装<a href="http://docs.puppetlabs.com/hiera/1/installing.html" target="_blank" rel="noopener">http://docs.puppetlabs.com/hiera/1/installing.html</a></p><p>配置hiera</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># cat /etc/puppet/hiera.yaml</span></span><br><span class="line">---</span><br><span class="line">:backends:</span><br><span class="line">  - yaml</span><br><span class="line">:yaml:</span><br><span class="line">  :datadir: /etc/puppet/hieradata</span><br><span class="line">:hierarchy:</span><br><span class="line">  - node/%&#123;::fqdn&#125;</span><br><span class="line">  - idc/%&#123;::idc&#125;</span><br><span class="line">  - environment/%&#123;::environment&#125;</span><br><span class="line">  - osfamily/%&#123;osfamily&#125;</span><br><span class="line">  - common</span><br><span class="line">:merge_behavior:</span><br><span class="line">  - deeper</span><br></pre></td></tr></table></figure><p>如果merge_behavior使用depper需要安装deep_merge，切hiera版本大于等于1.2.0</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># gem install deep_merge</span></span><br><span class="line">Successfully installed deep_merge-1.0.0</span><br><span class="line">1 gem installed</span><br><span class="line">Installing ri documentation <span class="keyword">for</span> deep_merge-1.0.0...</span><br><span class="line">Installing RDoc documentation <span class="keyword">for</span> deep_merge-1.0.0...</span><br></pre></td></tr></table></figure><p>创建相应的目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet ~]<span class="comment"># ls /etc/puppet/hieradata/</span></span><br><span class="line">environment  idc  node  osfamily</span><br></pre></td></tr></table></figure><p>为配置文件创建连接，hiera命令行使用/etc/hiera.yaml配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@puppet ~]<span class="comment"># ln -s /etc/puppet/hiera.yaml /etc/hiera.yaml</span></span><br></pre></td></tr></table></figure><p>参考文档：</p><p>Hiera配置：<a href="http://docs.puppetlabs.com/hiera/1/configuring.html" target="_blank" rel="noopener">http://docs.puppetlabs.com/hiera/1/configuring.html</a></p><p>创建Hierarchies： <a href="http://docs.puppetlabs.com/hiera/1/hierarchy.html" target="_blank" rel="noopener">http://docs.puppetlabs.com/hiera/1/hierarchy.html</a></p><p>yaml coolbook： <a href="http://www.yaml.org/YAML_for_ruby.html" target="_blank" rel="noopener">http://www.yaml.org/YAML_for_ruby.html</a></p><p>编写数据源</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet puppet]<span class="comment"># cat hieradata/node/puppet.example.com.yaml</span></span><br><span class="line">\---</span><br><span class="line">ntp::package_ensure: present</span><br><span class="line">ntp::service_enable: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">ntp::servers:</span><br><span class="line">  - 0.asia.pool.ntp.org</span><br><span class="line">  - 1.asia.pool.ntp.org</span><br><span class="line">[root@puppet puppet]<span class="comment"># cat hieradata/node/zabbix.example.com.yaml</span></span><br><span class="line">\---</span><br><span class="line">ntp::package_ensure: latest</span><br><span class="line">ntp::service_enable: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">ntp::servers:</span><br><span class="line">  - puppet.example.com</span><br><span class="line">  - 0.asia.pool.ntp.org</span><br><span class="line">  - 1.asia.pool.ntp.org</span><br><span class="line">[root@puppet puppet]<span class="comment"># cat hieradata/idc/m5.yaml</span></span><br><span class="line">\---</span><br><span class="line">ntp::package_ensure: latest</span><br><span class="line">ntp::service_enable: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">ntp::servers:</span><br><span class="line">  - puppet.example.com</span><br><span class="line">  - zabbix.example.com</span><br><span class="line">[root@puppet puppet]<span class="comment"># cat hieradata/common.yaml</span></span><br><span class="line">\---</span><br><span class="line">ntp::package_ensure: latest</span><br><span class="line">ntp::service_enable: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">ntp::servers:</span><br><span class="line">  - 4.asia.pool.ntp.org</span><br><span class="line">  - 5.asia.pool.ntp.org</span><br></pre></td></tr></table></figure><p>测试数据源</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@puppet puppet]<span class="comment"># hiera ntp::servers ::fqdn=puppet.example.com</span></span><br><span class="line">[<span class="string">"0.asia.pool.ntp.org"</span>, <span class="string">"1.asia.pool.ntp.org"</span>]</span><br><span class="line">[root@puppet puppet]<span class="comment"># vi hieradata/node/puppet.example.com.yaml</span></span><br><span class="line">[root@puppet puppet]<span class="comment"># hiera ntp::package_ensure ::fqdn=puppet.example.com</span></span><br><span class="line">present</span><br><span class="line">[root@puppet puppet]<span class="comment"># hiera ntp::servers ::fqdn=zabbix.example.com</span></span><br><span class="line">[<span class="string">"puppet.example.com"</span>, <span class="string">"0.asia.pool.ntp.org"</span>, <span class="string">"1.asia.pool.ntp.org"</span>]</span><br><span class="line">[root@puppet puppet]<span class="comment"># hiera ntp::package_ensure ::fqdn=zabbix.example.com</span></span><br><span class="line">latest</span><br><span class="line">[root@puppet puppet]<span class="comment"># hiera ntp::servers ::fqdn=node.example.com ::idc=m5</span></span><br><span class="line">[<span class="string">"puppet.example.com"</span>, <span class="string">"zabbix.example.com"</span>]</span><br><span class="line">[root@puppet puppet]<span class="comment"># hiera ntp::servers ::fqdn=node.example.com</span></span><br><span class="line">[<span class="string">"4.asia.pool.ntp.org"</span>, <span class="string">"5.asia.pool.ntp.org"</span>]</span><br><span class="line">[root@puppet puppet]<span class="comment"># hiera ntp::package_ensure ::fqdn=node.example.com</span></span><br><span class="line">latest</span><br></pre></td></tr></table></figure><p>puppet.example.com在idc m5机房，使用0.asia.pool.ntp.org和1.asia.pool.ntp.org ntp server，不自动升级<br>zabbix.example.com在idc m5机房，使用puppet.example.com 0.asia.pool.ntp.org 和1.asia.pool.ntp.org ntp server<br>node.example.com在idc m5机房，使用puppet.example.com和zabbix.example.com ntp server<br>其他机房默认使用4.asia.pool.ntp.org和5.asia.pool.ntp.org</p><p>参考文档：</p><p>编写数据源: <a href="http://docs.puppetlabs.com/hiera/1/data_sources.html" target="_blank" rel="noopener">http://docs.puppetlabs.com/hiera/1/data_sources.html</a></p><p>hiera应用完整实例: <a href="http://docs.puppetlabs.com/hiera/1/complete_example.html" target="_blank" rel="noopener">http://docs.puppetlabs.com/hiera/1/complete_example.html</a> </p><h2 id="15、-在上文中用到的-facts-idc需要自定义"><a href="#15、-在上文中用到的-facts-idc需要自定义" class="headerlink" title="15、 在上文中用到的 facts idc需要自定义"></a>15、 在上文中用到的 facts idc需要自定义</h2><p>Stone:puppet dongliang$ cat modules/tags/lib/facter/idc.rb</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Fact: idc</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Purpose: return idc</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'facter'</span></span><br><span class="line"></span><br><span class="line">idc = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">network_eth<span class="number">0</span> = Facter.value(<span class="string">'network_eth0'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> network_eth<span class="number">0</span></span><br><span class="line"><span class="keyword">when</span> /<span class="number">60</span>\.<span class="number">38</span>\.<span class="number">244</span><span class="params">|172\.16\.244/</span></span><br><span class="line"><span class="params">    idc = "tanggu"</span></span><br><span class="line"><span class="params"><span class="keyword">when</span> /121\.24\.32|</span><span class="number">10</span>\.<span class="number">71</span>\.<span class="number">32</span>/</span><br><span class="line">    idc = <span class="string">"qixinggang"</span></span><br><span class="line"><span class="keyword">when</span> /<span class="number">58</span>\.<span class="number">93</span>\.<span class="number">214</span><span class="params">|172\.16\.215/</span></span><br><span class="line"><span class="params">    idc = "m5"</span></span><br><span class="line"><span class="params"><span class="keyword">when</span> /61\.182\.207|</span><span class="number">172</span>\.<span class="number">16</span>\.<span class="number">51</span>/</span><br><span class="line">    idc = <span class="string">"qinzhou"</span></span><br><span class="line"><span class="keyword">when</span> /<span class="number">10</span>\.<span class="number">26</span>\.<span class="number">0</span><span class="params">|10\.27\.0/</span></span><br><span class="line"><span class="params">    idc = "huayuan"</span></span><br><span class="line"><span class="params"><span class="keyword">end</span></span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">Facter.add(:idc) <span class="keyword">do</span></span></span><br><span class="line"><span class="params">    setcode &#123; idc &#125;</span></span><br><span class="line"><span class="params"><span class="keyword">end</span></span></span><br></pre></td></tr></table></figure><p>参考文档：自定义facts<a href="http://docs.puppetlabs.com/guides/custom_facts.html" target="_blank" rel="noopener">http://docs.puppetlabs.com/guides/custom_facts.html</a> </p>]]></content>
    
    <summary type="html">
    
      CentOS 6.4 Puppet 3.2.4安装
    
    </summary>
    
      <category term="Puppet" scheme="https://istone.dev/categories/Puppet/"/>
    
    
      <category term="puppet" scheme="https://istone.dev/tags/puppet/"/>
    
      <category term="devops" scheme="https://istone.dev/tags/devops/"/>
    
  </entry>
  
  <entry>
    <title>Puppet: route模块</title>
    <link href="https://istone.dev/2014/05/14/puppet-route-module/"/>
    <id>https://istone.dev/2014/05/14/puppet-route-module/</id>
    <published>2014-05-14T02:00:00.000Z</published>
    <updated>2019-06-26T08:44:47.793Z</updated>
    
    <content type="html"><![CDATA[<p>本文介绍一个简单地route puppet模块，用来控制系统的路由信息，当你的网络很大时，有可能需要添加很多路由来与其他网段通信，此模块实现系统启动时自动添加路由功能。<br>github地址：<a href="https://github.com/ist0ne/puppet-route" target="_blank" rel="noopener">https://github.com/ist0ne/puppet-route</a></p><h2 id="1、描述"><a href="#1、描述" class="headerlink" title="1、描述"></a>1、描述</h2><p>本模块依赖<a href="https://github.com/puppetlabs/puppetlabs-stdlib" target="_blank" rel="noopener">puppetlabs-stdlib</a>，实现系统路由管理。</p><h2 id="2、用法"><a href="#2、用法" class="headerlink" title="2、用法"></a>2、用法</h2><p>为主机或网段添加路由：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$target_net = [<span class="string">'20.20.20.0/24'</span>, <span class="string">'10.20.0.0/16'</span>, <span class="string">'10.10.20.21'</span>]</span><br><span class="line">route &#123; $target_net: </span><br><span class="line">    gateway     =&gt; <span class="string">'10.10.10.1'</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>为主机和网段删除路由：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$target_net_absent = [<span class="string">'10.10.20.51'</span>, <span class="string">'10.20.30.0/16'</span>]</span><br><span class="line">route &#123; $target_net_absent<span class="symbol">:</span></span><br><span class="line">    <span class="keyword">ensure</span>      =&gt; absent,</span><br><span class="line">    gateway     =&gt; <span class="string">'10.10.10.1'</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3、模块代码解析"><a href="#3、模块代码解析" class="headerlink" title="3、模块代码解析"></a>3、模块代码解析</h2><p>自定义facter，需要开启pluginsync自定义facter才能生效。</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Facter.add(<span class="string">"route"</span>) <span class="keyword">do</span></span><br><span class="line">  setcode <span class="keyword">do</span></span><br><span class="line">    Facter::Util::Resolution.exec(<span class="string">'which route'</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>在route定义中通过${::route}引用自定义的facter。</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">define route (</span><br><span class="line">  $ensure          = present,</span><br><span class="line">  $gateway         = <span class="string">''</span>,</span><br><span class="line">  $route_file      = <span class="string">'S27route'</span>,</span><br><span class="line">  $route_file_path = <span class="string">'/etc/rc3.d'</span></span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">  validate_re($ensure, [present, <span class="string">'add'</span>, absent, <span class="string">'del'</span>])</span><br><span class="line">  validate_string($gateway)</span><br><span class="line">  validate_string($route_file)</span><br><span class="line">  validate_absolute_path($route_file_path)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 判断$gateway变量，必须为IP地址</span></span><br><span class="line">  <span class="keyword">if</span> ! is_ip_address($gateway) &#123;</span><br><span class="line">    fail(<span class="string">"The gateway must be a ipaddress."</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 根据目标地址中是否包含“/”来判断是给网段还是给主机添加路由</span></span><br><span class="line">  <span class="keyword">if</span> $name =~ <span class="regexp">/\//</span> &#123;</span><br><span class="line">    $target_type = <span class="string">'net'</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $target_type = <span class="string">'host'</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 添加路由配置文件，用于开机自动添加路由</span></span><br><span class="line">  exec &#123; <span class="string">"touch_route_file_$name"</span><span class="symbol">:</span></span><br><span class="line">    command =&gt; <span class="string">"touch $&#123;route_file_path&#125;/$&#123;route_file&#125;"</span>,</span><br><span class="line">    <span class="keyword">unless</span>  =&gt; <span class="string">"test -f $&#123;route_file_path&#125;/$&#123;route_file&#125;"</span>,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 添加路由并立即生效</span></span><br><span class="line">  <span class="keyword">if</span> ($ensure <span class="keyword">in</span> [present, <span class="string">'add'</span>]) &#123;</span><br><span class="line">    file_line &#123; <span class="string">"$name"</span><span class="symbol">:</span></span><br><span class="line">      <span class="keyword">ensure</span> =&gt; present,</span><br><span class="line">      line   =&gt; <span class="string">"$&#123;::route&#125; add -$&#123;target_type&#125; $&#123;title&#125; gw $&#123;gateway&#125;"</span>,</span><br><span class="line">      path   =&gt; <span class="string">"$&#123;route_file_path&#125;/$&#123;route_file&#125;"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    exec &#123; <span class="string">"$name"</span><span class="symbol">:</span></span><br><span class="line">      command     =&gt; <span class="string">"$&#123;::route&#125; add -$&#123;target_type&#125; $&#123;title&#125; gw $&#123;gateway&#125;"</span>,</span><br><span class="line">      refreshonly =&gt; <span class="literal">true</span>,</span><br><span class="line">      subscribe   =&gt; File_line[$name],</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment"># 删除路由并立即生效</span></span><br><span class="line">  &#125; <span class="keyword">elsif</span> ($ensure <span class="keyword">in</span> [absent, <span class="string">'del'</span>]) &#123;</span><br><span class="line">    file_line &#123; <span class="string">"$name"</span><span class="symbol">:</span></span><br><span class="line">      <span class="keyword">ensure</span> =&gt; absent,</span><br><span class="line">      line   =&gt; <span class="string">"$&#123;::route&#125; add -$&#123;target_type&#125; $&#123;title&#125; gw $&#123;gateway&#125;"</span>,</span><br><span class="line">      path   =&gt; <span class="string">"$&#123;route_file_path&#125;/$&#123;route_file&#125;"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    exec &#123; <span class="string">"$name"</span><span class="symbol">:</span></span><br><span class="line">      command     =&gt; <span class="string">"$&#123;::route&#125; del -$&#123;target_type&#125; $&#123;title&#125; gw $&#123;gateway&#125;"</span>,</span><br><span class="line">      refreshonly =&gt; <span class="literal">true</span>,</span><br><span class="line">      subscribe   =&gt; File_line[$name],</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Exec[<span class="string">"touch_route_file_$name"</span>] -&gt; File_line[<span class="string">"$name"</span>]</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      介绍puppet自制route模块，实现系统路由管理
    
    </summary>
    
      <category term="Puppet" scheme="https://istone.dev/categories/Puppet/"/>
    
    
      <category term="puppet" scheme="https://istone.dev/tags/puppet/"/>
    
      <category term="devops" scheme="https://istone.dev/tags/devops/"/>
    
      <category term="route" scheme="https://istone.dev/tags/route/"/>
    
  </entry>
  
  <entry>
    <title>Puppet: sudo模块</title>
    <link href="https://istone.dev/2014/05/14/puppet-sudo-module/"/>
    <id>https://istone.dev/2014/05/14/puppet-sudo-module/</id>
    <published>2014-05-14T02:00:00.000Z</published>
    <updated>2019-06-26T08:46:02.709Z</updated>
    
    <content type="html"><![CDATA[<p>本文介绍puppet sudo模块，用来管理Linux (RedHat)上的/etc/sudoers文件。模块实现批量添加、删除用户sudo权限。</p><p>github地址：<a href="https://github.com/ist0ne/puppet-sudo" target="_blank" rel="noopener">https://github.com/ist0ne/puppet-sudo</a></p><h2 id="1、描述"><a href="#1、描述" class="headerlink" title="1、描述"></a>1、描述</h2><p>本模块依赖<a href="https://github.com/puppetlabs/puppetlabs-stdlib" target="_blank" rel="noopener">puppetlabs-stdlib</a>，实现用户批量sudo权限的添加。</p><h2 id="2、用法"><a href="#2、用法" class="headerlink" title="2、用法"></a>2、用法</h2><p>添加用户和组：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo &#123; [<span class="string">'user1'</span>, <span class="string">'user2'</span>]: &#125;</span><br></pre></td></tr></table></figure><p>/etc/sudoers会添加如下行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user1    FILESERVERS=(ALL)    NOPASSWD: ALL</span><br><span class="line">user2    FILESERVERS=(ALL)    NOPASSWD: ALL</span><br></pre></td></tr></table></figure><p>删除用户和组：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo &#123;[<span class="string">'user1'</span>, <span class="string">'user2'</span>]: <span class="keyword">ensure</span> =&gt; absent&#125;</span><br></pre></td></tr></table></figure><p>使用别名添加ADMINS组：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">sudo &#123; <span class="string">'ADMINS'</span><span class="symbol">:</span></span><br><span class="line">    <span class="keyword">ensure</span> =&gt; present,</span><br><span class="line">    alias_hash =&gt; &#123;</span><br><span class="line">        <span class="string">'ADMINS'</span> =&gt; &#123;</span><br><span class="line">            <span class="keyword">ensure</span>        =&gt; present,</span><br><span class="line">            alias_type    =&gt; <span class="string">'User_Alias'</span>,</span><br><span class="line">            alias_name    =&gt; <span class="string">'ADMINS'</span>,</span><br><span class="line">            alias_content =&gt; <span class="string">'jsmith, mikem, jobs'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">'FILESERVERS'</span> =&gt; &#123;</span><br><span class="line">            <span class="keyword">ensure</span>        =&gt; present,</span><br><span class="line">            alias_type    =&gt; <span class="string">'Host_Alias'</span>,</span><br><span class="line">            alias_name    =&gt; <span class="string">'FILESERVERS'</span>,</span><br><span class="line">            alias_content =&gt; <span class="string">'fs1, fs2'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    machine =&gt; <span class="string">'FILESERVERS'</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面命令会添加如下行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ADMINS  FILESERVERS=(ALL)       NOPASSWD: ALL</span><br><span class="line">User_Alias ADMINS = jsmith, mikem, <span class="built_in">jobs</span></span><br><span class="line">Host_Alias FILESERVERS = fs1, fs2</span><br></pre></td></tr></table></figure><p>删除以上建立的别名只需将ensure都改为absent：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">sudo &#123; <span class="string">'ADMINS'</span><span class="symbol">:</span></span><br><span class="line">    <span class="keyword">ensure</span> =&gt; absent,</span><br><span class="line">    alias_hash =&gt; &#123;</span><br><span class="line">        <span class="string">'ADMINS'</span> =&gt; &#123;</span><br><span class="line">            <span class="keyword">ensure</span>        =&gt; absent,</span><br><span class="line">            alias_type    =&gt; <span class="string">'User_Alias'</span>,</span><br><span class="line">            alias_name    =&gt; <span class="string">'ADMINS'</span>,</span><br><span class="line">            alias_content =&gt; <span class="string">'jsmith, mikem, jobs'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">'FILESERVERS'</span> =&gt; &#123;</span><br><span class="line">            <span class="keyword">ensure</span>        =&gt; absent,</span><br><span class="line">            alias_type    =&gt; <span class="string">'Host_Alias'</span>,</span><br><span class="line">            alias_name    =&gt; <span class="string">'FILESERVERS'</span>,</span><br><span class="line">            alias_content =&gt; <span class="string">'fs1, fs2'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    machine =&gt; <span class="string">'FILESERVERS'</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3、模块代码解析"><a href="#3、模块代码解析" class="headerlink" title="3、模块代码解析"></a>3、模块代码解析</h2><p>sudo的定义用到了create_resources函数，这个函数使用一个hash结构创建资源。</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">define sudo (</span><br><span class="line">  $ensure            = present,</span><br><span class="line">  $alias_hash        = <span class="string">'unset'</span>,</span><br><span class="line">  $machine           = <span class="string">'ALL'</span>,</span><br><span class="line">  $commands          = <span class="string">'(ALL)'</span>,</span><br><span class="line">  $nopasswd          = <span class="literal">true</span>,</span><br><span class="line">  $nopasswd_commands = <span class="string">'ALL'</span>,</span><br><span class="line">  $sudo_file         = <span class="string">'sudoers'</span>,</span><br><span class="line">  $sudo_file_path    = <span class="string">'/etc'</span></span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">  validate_re($ensure, [present, absent])</span><br><span class="line">  validate_string($machine)</span><br><span class="line">  validate_string($commands)</span><br><span class="line">  validate_bool($nopasswd)</span><br><span class="line">  validate_string($nopasswd_commands)</span><br><span class="line">  validate_string($sudo_file)</span><br><span class="line">  validate_absolute_path($sudo_file_path)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ($alias_hash != <span class="string">'unset'</span>) &#123;</span><br><span class="line">    create_resources(<span class="string">'sudo::alias'</span>, $alias_hash)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> $nopasswd == <span class="literal">true</span> &#123;</span><br><span class="line">    $nopwd = <span class="string">'NOPASSWD'</span></span><br><span class="line">    $line = <span class="string">"$name  $machine=$commands  $&#123;nopwd&#125;: $nopasswd_commands"</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $line = <span class="string">"$name  $machine=$commands  $commands"</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  exec &#123; <span class="string">"test_user_exist_$name"</span><span class="symbol">:</span></span><br><span class="line">    command =&gt; <span class="string">"sed -i '/^$name[[:space:]]/d' $&#123;sudo_file_path&#125;/$&#123;sudo_file&#125;"</span>,</span><br><span class="line">    onlyif  =&gt; <span class="string">"grep \'^$name[[:space:]]\' $&#123;sudo_file_path&#125;/$&#123;sudo_file&#125; &gt;/dev/null &amp;&amp; cat $&#123;sudo_file_path&#125;/$&#123;sudo_file&#125; |grep \'^$name[[:space:]]\' |grep -v \'^$line\$\' &gt;/dev/null"</span>,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  file_line &#123; <span class="string">"$name"</span><span class="symbol">:</span></span><br><span class="line">    <span class="keyword">ensure</span> =&gt; $ensure,</span><br><span class="line">    line   =&gt; $line,</span><br><span class="line">    path   =&gt; <span class="string">"$&#123;sudo_file_path&#125;/$&#123;sudo_file&#125;"</span>,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Exec[<span class="string">"test_user_exist_$name"</span>] -&gt; File_line[<span class="string">"$name"</span>]</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sudo::alias定义如下：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">define sudo::<span class="keyword">alias</span> (</span><br><span class="line">  $ensure         = present,</span><br><span class="line">  $alias_type     = <span class="keyword">undef</span>,</span><br><span class="line">  $alias_name     = <span class="keyword">undef</span>,</span><br><span class="line">  $alias_content  = <span class="keyword">undef</span>,</span><br><span class="line">  $sudo_file      = <span class="string">'sudoers'</span>,</span><br><span class="line">  $sudo_file_path = <span class="string">'/etc'</span></span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">  validate_re($ensure, [present, absent])</span><br><span class="line">  validate_re($alias_type, [<span class="string">'Host_Alias'</span>, <span class="string">'User_Alias'</span>, <span class="string">'Cmnd_Alias'</span>])</span><br><span class="line">  validate_string($alias_name)</span><br><span class="line">  validate_string($alias_content)</span><br><span class="line">  validate_string($sudo_file)</span><br><span class="line">  validate_absolute_path($sudo_file_path)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ! ($ensure <span class="keyword">in</span> [present, absent]) &#123;</span><br><span class="line">    fail(<span class="string">'ensure parameter must be present or absent'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ! ($alias_type <span class="keyword">in</span> [<span class="string">'Host_Alias'</span>, <span class="string">'User_Alias'</span>, <span class="string">'Cmnd_Alias'</span>]) &#123;</span><br><span class="line">    fail(<span class="string">'alias_type parameter must be "Host_Alias" or "User_Alias" or "Cmnd_Alias"'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ($alias_type != <span class="keyword">undef</span> <span class="keyword">and</span> $alias_name != <span class="keyword">undef</span> <span class="keyword">and</span> $alias_content != <span class="keyword">undef</span>) &#123;</span><br><span class="line">    $alias_line = <span class="string">"$alias_type $alias_name = $alias_content"</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ($alias_line != <span class="keyword">undef</span>) &#123;</span><br><span class="line">    exec &#123; <span class="string">"test_alias_exist_$name"</span><span class="symbol">:</span></span><br><span class="line">      command =&gt; <span class="string">"sed -i '/^$alias_type $alias_name[[:space:]]/d' $&#123;sudo_file_path&#125;/$&#123;sudo_file&#125;"</span>,</span><br><span class="line">      onlyif  =&gt; <span class="string">"grep \'^$alias_type[[:space:]]$alias_name[[:space:]]\' $&#123;sudo_file_path&#125;/$&#123;sudo_file&#125; &gt;/dev/null &amp;&amp; cat $&#123;sudo_file_path&#125;/$&#123;sudo_file&#125; |grep \'^$alias_type[[:space:]]$alias_name[[:space:]]\' |grep -v \'^$alias_line\$\' &gt;/dev/null"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    file_line &#123; <span class="string">"alias_$name"</span><span class="symbol">:</span></span><br><span class="line">      <span class="keyword">ensure</span> =&gt; $ensure,</span><br><span class="line">      line   =&gt; $alias_line,</span><br><span class="line">      path   =&gt; <span class="string">"$&#123;sudo_file_path&#125;/$&#123;sudo_file&#125;"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  Exec[<span class="string">"test_alias_exist_$name"</span>] -&gt; File_line[<span class="string">"alias_$name"</span>]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      介绍puppet自制sudo模块
    
    </summary>
    
      <category term="Puppet" scheme="https://istone.dev/categories/Puppet/"/>
    
    
      <category term="puppet" scheme="https://istone.dev/tags/puppet/"/>
    
      <category term="devops" scheme="https://istone.dev/tags/devops/"/>
    
  </entry>
  
</feed>
