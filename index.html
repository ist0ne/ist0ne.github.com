<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>石头记 | Docker、Kubernetes、CI/CD 等技术分享</title>

  
  <meta name="author" content="ist0ne">
  

  
  <meta name="description" content="Docker、Kubernetes、Ceph、Saltstack、OpenStack 等技术分享">
  

  
  <meta name="keywords" content="blog kubernetes k8s docker container ceph salt saltstack openstack kube kubectl helm charts gitlab git">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content="石头记">

  
  <meta property="og:image" content="/favicon.ico">
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="石头记" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">石头记</a>
    </h1>
    <p class="site-description">Docker、Kubernetes、CI/CD 等技术分享</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
        <li><a href="/atom.xml">订阅</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    
  <article>

  
    
    <h3 class="article-title"><a href="/2018/09/14/Kubernetes-Update/"><span>Kubernetes 集群升级</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/09/14/Kubernetes-Update/" rel="bookmark">
        <time class="entry-date published" datetime="2018-09-14T08:56:49.000Z">
          2018-09-14
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h3 id="控制平面升级"><a href="#控制平面升级" class="headerlink" title="控制平面升级"></a>控制平面升级</h3><p>只有master节点需要执行如下操作，需要逐节点操作。将集群从当前的v1.11.2升级到v1.11.3。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 升级kubeadm</span></span><br><span class="line">[root@k8s-ha-1 ~]<span class="comment"># export VERSION=$(curl -sSL https://dl.k8s.io/release/stable.txt)</span></span><br><span class="line">[root@k8s-ha-1 ~]<span class="comment"># export ARCH=amd64</span></span><br><span class="line">[root@k8s-ha-1 ~]<span class="comment"># curl -sSL https://dl.k8s.io/release/$&#123;VERSION&#125;/bin/linux/$&#123;ARCH&#125;/kubeadm &gt;/usr/bin/kubeadm</span></span><br><span class="line">[root@k8s-ha-1 ~]<span class="comment"># chmod a+rx /usr/bin/kubeadm</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看升级计划</span></span><br><span class="line">[root@k8s-ha-1 ~]<span class="comment"># kubeadm upgrade plan</span></span><br><span class="line">[preflight] Running pre-flight checks.</span><br><span class="line">[upgrade] Making sure the cluster is healthy:</span><br><span class="line">[upgrade/config] Making sure the configuration is correct:</span><br><span class="line">[upgrade/config] Reading configuration from the cluster...</span><br><span class="line">[upgrade/config] FYI: You can look at this config file with <span class="string">'kubectl -n kube-system get cm kubeadm-config -oyaml'</span></span><br><span class="line">[endpoint] WARNING: port specified <span class="keyword">in</span> api.controlPlaneEndpoint overrides api.bindPort <span class="keyword">in</span> the controlplane address</span><br><span class="line">[upgrade] Fetching available versions to upgrade to</span><br><span class="line">[upgrade/versions] Cluster version: v1.11.2</span><br><span class="line">[upgrade/versions] kubeadm version: v1.11.3</span><br><span class="line">[upgrade/versions] Latest stable version: v1.11.3</span><br><span class="line">[upgrade/versions] Latest version <span class="keyword">in</span> the v1.11 series: v1.11.3</span><br><span class="line"></span><br><span class="line">Components that must be upgraded manually after you have upgraded the control plane with <span class="string">'kubeadm upgrade apply'</span>:</span><br><span class="line">COMPONENT   CURRENT       AVAILABLE</span><br><span class="line">Kubelet     1 x v1.11.2   v1.11.3</span><br><span class="line">            2 x v1.11.3   v1.11.3</span><br><span class="line"></span><br><span class="line">Upgrade to the latest version <span class="keyword">in</span> the v1.11 series:</span><br><span class="line"></span><br><span class="line">COMPONENT            CURRENT   AVAILABLE</span><br><span class="line">API Server           v1.11.2   v1.11.3</span><br><span class="line">Controller Manager   v1.11.2   v1.11.3</span><br><span class="line">Scheduler            v1.11.2   v1.11.3</span><br><span class="line">Kube Proxy           v1.11.2   v1.11.3</span><br><span class="line">CoreDNS              1.1.3     1.1.3</span><br><span class="line">Etcd                 3.2.18    3.2.18</span><br><span class="line"></span><br><span class="line">You can now apply the upgrade by executing the following <span class="built_in">command</span>:</span><br><span class="line"></span><br><span class="line">    kubeadm upgrade apply v1.11.3</span><br><span class="line"></span><br><span class="line">_____________________________________________________________________</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级控制节点</span></span><br><span class="line">[root@k8s-ha-1 ~]<span class="comment"># kubeadm upgrade apply v1.11.3</span></span><br><span class="line">[preflight] Running pre-flight checks.</span><br><span class="line">[upgrade] Making sure the cluster is healthy:</span><br><span class="line">[upgrade/config] Making sure the configuration is correct:</span><br><span class="line">[upgrade/config] Reading configuration from the cluster...</span><br><span class="line">[upgrade/config] FYI: You can look at this config file with <span class="string">'kubectl -n kube-system get cm kubeadm-config -oyaml'</span></span><br><span class="line">[endpoint] WARNING: port specified <span class="keyword">in</span> api.controlPlaneEndpoint overrides api.bindPort <span class="keyword">in</span> the controlplane address</span><br><span class="line">[upgrade/apply] Respecting the --cri-socket flag that is <span class="built_in">set</span> with higher priority than the config file.</span><br><span class="line">[upgrade/version] You have chosen to change the cluster version to <span class="string">"v1.11.3"</span></span><br><span class="line">[upgrade/versions] Cluster version: v1.11.3</span><br><span class="line">[upgrade/versions] kubeadm version: v1.11.3</span><br><span class="line">[upgrade/confirm] Are you sure you want to proceed with the upgrade? [y/N]: y</span><br><span class="line">[upgrade/prepull] Will prepull images <span class="keyword">for</span> components [kube-apiserver kube-controller-manager kube-scheduler etcd]</span><br><span class="line">[upgrade/apply] Upgrading your Static Pod-hosted control plane to version <span class="string">"v1.11.3"</span>...</span><br><span class="line">Static pod: kube-apiserver-k8s-ha-1 <span class="built_in">hash</span>: 59b9d4f724df54d37f5379586005e80b</span><br><span class="line">Static pod: kube-controller-manager-k8s-ha-1 <span class="built_in">hash</span>: c844216e25c7ade0ed6358313b2ae382</span><br><span class="line">Static pod: kube-scheduler-k8s-ha-1 <span class="built_in">hash</span>: a00c35e56ebd0bdfcd77d53674a5d2a1</span><br><span class="line">[upgrade/staticpods] Writing new Static Pod manifests to <span class="string">"/etc/kubernetes/tmp/kubeadm-upgraded-manifests350573529"</span></span><br><span class="line">[controlplane] wrote Static Pod manifest <span class="keyword">for</span> component kube-apiserver to <span class="string">"/etc/kubernetes/tmp/kubeadm-upgraded-manifests350573529/kube-apiserver.yaml"</span></span><br><span class="line">[controlplane] wrote Static Pod manifest <span class="keyword">for</span> component kube-controller-manager to <span class="string">"/etc/kubernetes/tmp/kubeadm-upgraded-manifests350573529/kube-controller-manager.yaml"</span></span><br><span class="line">[controlplane] wrote Static Pod manifest <span class="keyword">for</span> component kube-scheduler to <span class="string">"/etc/kubernetes/tmp/kubeadm-upgraded-manifests350573529/kube-scheduler.yaml"</span></span><br><span class="line">[certificates] Using the existing etcd/ca certificate and key.</span><br><span class="line">[certificates] Using the existing apiserver-etcd-client certificate and key.</span><br><span class="line">[upgrade/staticpods] Moved new manifest to <span class="string">"/etc/kubernetes/manifests/kube-apiserver.yaml"</span> and backed up old manifest to <span class="string">"/etc/kubernetes/tmp/kubeadm-backup-manifests-2018-09-14-07-36-57/kube-apiserver.yaml"</span></span><br><span class="line">[upgrade/staticpods] Waiting <span class="keyword">for</span> the kubelet to restart the component</span><br><span class="line">Static pod: kube-apiserver-k8s-ha-1 <span class="built_in">hash</span>: 59b9d4f724df54d37f5379586005e80b</span><br><span class="line">Static pod: kube-apiserver-k8s-ha-1 <span class="built_in">hash</span>: 59b9d4f724df54d37f5379586005e80b</span><br><span class="line">Static pod: kube-apiserver-k8s-ha-1 <span class="built_in">hash</span>: 50141d1c8e0a130d159fa29fef61933c</span><br><span class="line">[apiclient] Found 3 Pods <span class="keyword">for</span> label selector component=kube-apiserver</span><br><span class="line">[upgrade/staticpods] Component <span class="string">"kube-apiserver"</span> upgraded successfully!</span><br><span class="line">[upgrade/staticpods] Moved new manifest to <span class="string">"/etc/kubernetes/manifests/kube-controller-manager.yaml"</span> and backed up old manifest to <span class="string">"/etc/kubernetes/tmp/kubeadm-backup-manifests-2018-09-14-07-36-57/kube-controller-manager.yaml"</span></span><br><span class="line">[upgrade/staticpods] Waiting <span class="keyword">for</span> the kubelet to restart the component</span><br><span class="line">Static pod: kube-controller-manager-k8s-ha-1 <span class="built_in">hash</span>: c844216e25c7ade0ed6358313b2ae382</span><br><span class="line">Static pod: kube-controller-manager-k8s-ha-1 <span class="built_in">hash</span>: c844216e25c7ade0ed6358313b2ae382</span><br><span class="line">Static pod: kube-controller-manager-k8s-ha-1 <span class="built_in">hash</span>: c844216e25c7ade0ed6358313b2ae382</span><br><span class="line">Static pod: kube-controller-manager-k8s-ha-1 <span class="built_in">hash</span>: bdbce0400587a45fd6b7b4a4523eaff5</span><br><span class="line">[apiclient] Found 3 Pods <span class="keyword">for</span> label selector component=kube-controller-manager</span><br><span class="line">[upgrade/staticpods] Component <span class="string">"kube-controller-manager"</span> upgraded successfully!</span><br><span class="line">[upgrade/staticpods] Moved new manifest to <span class="string">"/etc/kubernetes/manifests/kube-scheduler.yaml"</span> and backed up old manifest to <span class="string">"/etc/kubernetes/tmp/kubeadm-backup-manifests-2018-09-14-07-36-57/kube-scheduler.yaml"</span></span><br><span class="line">[upgrade/staticpods] Waiting <span class="keyword">for</span> the kubelet to restart the component</span><br><span class="line">Static pod: kube-scheduler-k8s-ha-1 <span class="built_in">hash</span>: a00c35e56ebd0bdfcd77d53674a5d2a1</span><br><span class="line">Static pod: kube-scheduler-k8s-ha-1 <span class="built_in">hash</span>: a00c35e56ebd0bdfcd77d53674a5d2a1</span><br><span class="line">Static pod: kube-scheduler-k8s-ha-1 <span class="built_in">hash</span>: 009228e74aef4d7babd7968782118d5e</span><br><span class="line">[apiclient] Found 3 Pods <span class="keyword">for</span> label selector component=kube-scheduler</span><br><span class="line">[upgrade/staticpods] Component <span class="string">"kube-scheduler"</span> upgraded successfully!</span><br><span class="line">[uploadconfig] storing the configuration used <span class="keyword">in</span> ConfigMap <span class="string">"kubeadm-config"</span> <span class="keyword">in</span> the <span class="string">"kube-system"</span> Namespace</span><br><span class="line">[kubelet] Creating a ConfigMap <span class="string">"kubelet-config-1.11"</span> <span class="keyword">in</span> namespace kube-system with the configuration <span class="keyword">for</span> the kubelets <span class="keyword">in</span> the cluster</span><br><span class="line">[kubelet] Downloading configuration <span class="keyword">for</span> the kubelet from the <span class="string">"kubelet-config-1.11"</span> ConfigMap <span class="keyword">in</span> the kube-system namespace</span><br><span class="line">[kubelet] Writing kubelet configuration to file <span class="string">"/var/lib/kubelet/config.yaml"</span></span><br><span class="line">[patchnode] Uploading the CRI Socket information <span class="string">"/var/run/dockershim.sock"</span> to the Node API object <span class="string">"k8s-ha-1"</span> as an annotation</span><br><span class="line">[bootstraptoken] configured RBAC rules to allow Node Bootstrap tokens to post CSRs <span class="keyword">in</span> order <span class="keyword">for</span> nodes to get long term certificate credentials</span><br><span class="line">[bootstraptoken] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span><br><span class="line">[bootstraptoken] configured RBAC rules to allow certificate rotation <span class="keyword">for</span> all node client certificates <span class="keyword">in</span> the cluster</span><br><span class="line">[addons] Applied essential addon: CoreDNS</span><br><span class="line">[endpoint] WARNING: port specified <span class="keyword">in</span> api.controlPlaneEndpoint overrides api.bindPort <span class="keyword">in</span> the controlplane address</span><br><span class="line">[addons] Applied essential addon: kube-proxy</span><br><span class="line"></span><br><span class="line">[upgrade/successful] SUCCESS! Your cluster was upgraded to <span class="string">"v1.11.3"</span>. Enjoy!</span><br><span class="line"></span><br><span class="line">[upgrade/kubelet] Now that your control plane is upgraded, please proceed with upgrading your kubelets <span class="keyword">if</span> you haven<span class="string">'t already done so.</span></span><br></pre></td></tr></table></figure>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/docker/">docker</a><a href="/tags/container/">container</a><a href="/tags/kubernetes/">kubernetes</a><a href="/tags/k8s/">k8s</a><a href="/tags/kubeadm/">kubeadm</a><a href="/tags/kubectl/">kubectl</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2018/09/14/Kubernetes-Update/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/09/13/Kubernetes-Install/"><span>高可用 Kubernetes 集群部署</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/09/13/Kubernetes-Install/" rel="bookmark">
        <time class="entry-date published" datetime="2018-09-13T04:09:18.000Z">
          2018-09-13
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>我在前面介绍容器技术基础知识，本篇主要介绍通过kubeadm部署高可用容器编排工具Kubernetes。跟很多基础设施领域先有工程实践、后有方法论的发展路线不同，Kubernetes 项目的理论基础则要比工程实践走得靠前得多，这当然要归功于 Google 公司在 2015 年 4 月发布的 Borg 论文了。Borg 系统，一直以来都被誉为 Google 公司内部最强大的“秘密武器”。因为，相比于 Spanner、BigTable 等相对上层的项目，Borg 要承担的责任，是承载 Google 公司整个基础设施的核心依赖。在 Google 公司已经公开发表的基础设施体系论文中，Borg 项目当仁不让地位居整个基础设施技术栈的最底层。</p>
<p><img src="/imgs/201809/borg.jpg" alt="Google 架构"></p>
<p>Kubernetes 项目的架构，跟它的原型项目 Borg 非常类似，都由 Master 和 Node 两种节点组成，而这两种角色分别对应着控制节点和计算节点。</p>
<p><img src="/imgs/201809/k8s_jiagou.png" alt="Kubernetes 架构"></p>
<p>其中，控制节点，即 Master 节点，由三个紧密协作的独立组件组合而成，它们分别是负责 API 服务的 kube-apiserver、负责调度的 kube-scheduler，以及负责容器编排的 kube-controller-manager。整个集群的持久化数据，则由 kube-apiserver 处理后保存在 ectd 中。Kubernetes 的高可用即为控制节点和 etcd 数据库的高可用。下面开始介绍高可用 Kubernetes 集群的搭建步骤。</p>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/docker/">docker</a><a href="/tags/container/">container</a><a href="/tags/kubernetes/">kubernetes</a><a href="/tags/k8s/">k8s</a><a href="/tags/kubeadm/">kubeadm</a><a href="/tags/kubectl/">kubectl</a><a href="/tags/helm/">helm</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2018/09/13/Kubernetes-Install/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/09/11/Docker-Compose-PHP-ENV/"><span>Docker Compose 搭建 PHP 开发环境</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/09/11/Docker-Compose-PHP-ENV/" rel="bookmark">
        <time class="entry-date published" datetime="2018-09-11T06:32:23.000Z">
          2018-09-11
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>Docker PHP 可以快速构建基于 Docker 的 PHP 本地开发环境，此套 LNMP 环境同时支持 PHP 5 和 PHP 7。请克隆此项目使用：<a href="https://github.com/ist0ne/docker-php.git" target="_blank" rel="noopener">https://github.com/ist0ne/docker-php.git</a></p>
<h3 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h3><p>PHP/FPM 7.2/5.6、Nginx 1.12、Mysql 5.7、Redis 4.0、Memcached 1.5</p>
<h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">├── add_project.sh  新建项目脚本（Linux）</span><br><span class="line">├── build  镜像构建目录</span><br><span class="line">│   ├── memcached</span><br><span class="line">│   │   └── Dockerfile</span><br><span class="line">│   ├── mysql</span><br><span class="line">│   │   └── Dockerfile</span><br><span class="line">│   ├── nginx</span><br><span class="line">│   │   └── Dockerfile</span><br><span class="line">│   ├── php5</span><br><span class="line">│   │   └── Dockerfile</span><br><span class="line">│   ├── php7</span><br><span class="line">│   │   └── Dockerfile</span><br><span class="line">│   └── redis</span><br><span class="line">│       └── Dockerfile</span><br><span class="line">├── config  服务配置目录</span><br><span class="line">│   ├── mysql</span><br><span class="line">│   │   ├── backup</span><br><span class="line">│   │   ├── config</span><br><span class="line">│   │   │   └── mysql.cnf</span><br><span class="line">│   │   ├── crontabs</span><br><span class="line">│   │   └── docker-entrypoint-initdb.d  数据库初始化脚本目录</span><br><span class="line">│   ├── nginx</span><br><span class="line">│   │   ├── conf.d</span><br><span class="line">│   │   │   ├── bar.example.com.conf</span><br><span class="line">│   │   │   ├── foo.example.com.conf</span><br><span class="line">│   │   │   └── example.com.conf.template</span><br><span class="line">│   │   ├── fastcgi_mysql</span><br><span class="line">│   │   ├── fastcgi_web</span><br><span class="line">│   │   └── nginx.conf</span><br><span class="line">│   ├── php5</span><br><span class="line">│   │   ├── php.ini</span><br><span class="line">│   │   └── php.ini-production</span><br><span class="line">│   ├── php7</span><br><span class="line">│   │   ├── php.ini</span><br><span class="line">│   │   └── php.ini-production</span><br><span class="line">│   └── redis</span><br><span class="line">│       └── redis.conf</span><br><span class="line">├── data 服务数据目录</span><br><span class="line">│   ├── mysql  数据库数据存储目录</span><br><span class="line">│   ├── nginx</span><br><span class="line">│   │   ├── cache  应用缓存目录</span><br><span class="line">│   │   └── data  应用数据目录</span><br><span class="line">│   └── redis  缓存数据目录</span><br><span class="line">├── docker-compose.yml  项目配置文件</span><br><span class="line">├── logs 服务日志目录</span><br><span class="line">│   ├── access  Nginx访问日志目录</span><br><span class="line">│   │   ├── bar.example.com</span><br><span class="line">│   │   │   └── bar.example.com.log</span><br><span class="line">│   │   └── foo.example.com</span><br><span class="line">│   │       └── foo.example.com.log</span><br><span class="line">│   ├── app  应用日志目录</span><br><span class="line">│   │   ├── bar.example.com</span><br><span class="line">│   │   └── foo.example.com</span><br><span class="line">│   └── srv  服务日志目录</span><br><span class="line">│       ├── memcached</span><br><span class="line">│       ├── mysql</span><br><span class="line">│       │   └── error.log</span><br><span class="line">│       ├── nginx</span><br><span class="line">│       │   └── nginx_error.log</span><br><span class="line">│       ├── php5</span><br><span class="line">│       │   └── php_errors.log</span><br><span class="line">│       ├── php7</span><br><span class="line">│       │   └── php_errors.log</span><br><span class="line">│       └── redis</span><br><span class="line">│           └── redis.log</span><br><span class="line">├── README.md</span><br><span class="line">└── webapps  应用代码目录</span><br><span class="line">    ├── bar.example.com</span><br><span class="line">    │   └── htdocs</span><br><span class="line">    │       └── index.php</span><br><span class="line">    └── foo.example.com</span><br><span class="line">        └── htdocs</span><br><span class="line">            └── index.php</span><br></pre></td></tr></table></figure>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/docker/">docker</a><a href="/tags/container/">container</a><a href="/tags/compose/">compose</a><a href="/tags/develop/">develop</a><a href="/tags/php/">php</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2018/09/11/Docker-Compose-PHP-ENV/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/09/10/Docker-Compose/"><span>Docker Compose</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/09/10/Docker-Compose/" rel="bookmark">
        <time class="entry-date published" datetime="2018-09-10T08:24:51.000Z">
          2018-09-10
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Compose 项目是 Docker 官方的开源项目，负责实现对 Docker 容器集群的快速编排。Compose 定位是 「定义和运行多个 Docker 容器化应用（Defining and running multi-container Docker applications）」，其前身是开源项目 Fig。</p>
<p>在日常工作中，经常会碰到需要多个容器相互配合来完成某项任务的情况。例如要实现一个 Web 项目，除了 Web 服务容器本身，往往还需要再加上缓存服务容器，已经后端的数据库服务容器。Compose 恰好满足了这样的需求。它允许用户通过一个单独的 docker-compose.yml 模板文件（YAML 格式）来定义一组相关联的应用容器为一个项目（project）。</p>
<p>Compose 中有两个重要的概念：</p>
<ul>
<li>服务 (service)：一个应用的容器，实际上可以包括若干运行相同镜像的容器实例。</li>
<li>项目 (project)：由一组关联的应用容器组成的一个完整业务单元，在 docker-compose.yml 文件中定义。
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/docker/">docker</a><a href="/tags/container/">container</a><a href="/tags/compose/">compose</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2018/09/10/Docker-Compose/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/09/10/Docker-Volume/"><span>Docker 存储</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/09/10/Docker-Volume/" rel="bookmark">
        <time class="entry-date published" datetime="2018-09-10T03:59:34.000Z">
          2018-09-10
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>Docker 为容器提供了两种存放数据的资源：</p>
<ul>
<li>由 Storage Driver 管理的镜像层和容器层</li>
<li>Data Volume</li>
</ul>
<h3 id="Storage-Driver"><a href="#Storage-Driver" class="headerlink" title="Storage Driver"></a>Storage Driver</h3><p><img src="/imgs/201809/docker_image_layer.png" alt="镜像分层结构"></p>
<p>容器由最上面一个可写的容器层，以及若干只读的镜像层组成，容器的数据就存放在这些层中。这样的分层结构最大的特性是 Copy-on-Write：</p>
<ul>
<li>新数据会直接存放在最上面的容器层</li>
<li>修改现有数据会先从镜像层将数据复制到容器层，修改后的数据直接保存在容器层中，镜像层保持不变</li>
<li>如果多个层中有命名相同的文件，用户只能看到最上面那层中的文件</li>
</ul>
<p>分层结构使镜像和容器的创建、共享以及分发变得非常高效，而这些都要归功于 Docker storage driver。正是 storage driver 实现了多层数据的堆叠并为用户提供一个单一的合并之后的统一视图。</p>
<p>Docker 支持多种 storage driver，有 AUFS、Device Mapper、Btrfs、OverlayFS、VFS 和 ZFS。它们都能实现分层的架构，同时又有各自的特性。对于 Docker 用户来说，具体选择使用哪个 storage driver 是一个难题，不过 Docker 官方给出了一个简单的答案：优先使用 Linux 发行版默认的 storage driver。Docker 安装时会根据当前系统的配置选择默认的 driver。默认 driver 具有最好的稳定性，因为默认 driver 在发行版上经过了严格的测试。</p>
<p><strong>Docker CE on Ubuntu</strong> aufs, devicemapper, overlay2 (Ubuntu 14.04.4 or later, 16.04 or later), overlay, zfs, vfs<br><strong>Docker CE on Debian</strong> aufs, devicemapper, overlay2 (Debian Stretch), overlay, vfs<br><strong>Docker CE on CentOS</strong> devicemapper, vfs<br><strong>Docker CE on Fedora</strong> devicemapper, overlay2 (Fedora 26 or later, experimental), overlay (experimental), vfs</p>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/docker/">docker</a><a href="/tags/container/">container</a><a href="/tags/volume/">volume</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2018/09/10/Docker-Volume/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/07/02/Docker-Network/"><span>Docker 网络</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/07/02/Docker-Network/" rel="bookmark">
        <time class="entry-date published" datetime="2018-07-02T06:05:45.000Z">
          2018-07-02
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="容器的三种本地网络"><a href="#容器的三种本地网络" class="headerlink" title="容器的三种本地网络"></a>容器的三种本地网络</h2><h3 id="none-网络"><a href="#none-网络" class="headerlink" title="none 网络"></a>none 网络</h3><p>故名思议，none 网络就是什么都没有的网络。挂在这个网络下的容器除了 lo，没有其他任何网卡。容器创建时，可以通过 --network=none 指定使用 none 网络。</p>
<p><img src="/imgs/201807/docker_network_none.png" alt="docker network none"></p>
<h3 id="host-网络"><a href="#host-网络" class="headerlink" title="host 网络"></a>host 网络</h3><p>连接到 host 网络的容器共享 Docker host 的网络栈，容器的网络配置与 host 完全一样。可以通过 --network=host 指定使用 host 网络。使用 host 网络，容器和宿主机共用 host 网络，当启动服务时应该避免端口冲突。</p>
<p><img src="/imgs/201807/docker_network_host.png" alt="docker network host"></p>
<h3 id="Bridge-网络"><a href="#Bridge-网络" class="headerlink" title="Bridge 网络"></a>Bridge 网络</h3><p>Docker 安装时会创建一个命名为 docker0 的 linux bridge。如果不指定--network，创建的容器默认都会挂到 docker0 上。</p>
<p><img src="/imgs/201807/docker_network_bridge.png" alt="docker network bridge"></p>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/docker/">docker</a><a href="/tags/container/">container</a><a href="/tags/network/">network</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2018/07/02/Docker-Network/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/06/22/Run-Docker/"><span>Docker 生命周期管理</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/06/22/Run-Docker/" rel="bookmark">
        <time class="entry-date published" datetime="2018-06-22T03:13:58.000Z">
          2018-06-22
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="运行容器"><a href="#运行容器" class="headerlink" title="运行容器"></a>运行容器</h2><p>docker run 是启动容器的方法，容器启动后返回的是 “长ID”，我们可以通过这个长ID去访问这个容器，也可以通过启动时指定的名字访问这个容器。docker ps 能够看到容器的“短ID”，通过短ID同样可以访问这个容器，甚至只要能够唯一标识这个容器也可使用更短的ID。</p>
<p><img src="/imgs/201806/docker_run.jpg" alt="docker run"></p>
<p>-d 指定容器以后台方式运行；–restart 指定容器的重启策略，默认值no，容器退出时不要重启，on-failure[:max-retries] 只在容器以非0状态码退出时重启。max-retries可以指定尝试重启容器的次数；always 不管退出状态码是什么始终重启容器。当指定容器退出后，docker daemon将无限次数地重启容器。–name 指定容器的名称。</p>
<p>容器的生命周期依赖于启动时执行的命令，只要该命令不结束，容器也就不会退出。理解了这个原理，我们就可以通过执行一个长期运行的命令来保持容器的运行状态。</p>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/docker/">docker</a><a href="/tags/container/">container</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2018/06/22/Run-Docker/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/06/11/Docker-Images/"><span>Docker 镜像</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/06/11/Docker-Images/" rel="bookmark">
        <time class="entry-date published" datetime="2018-06-11T06:20:40.000Z">
          2018-06-11
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="最小镜像"><a href="#最小镜像" class="headerlink" title="最小镜像"></a>最小镜像</h2><p>镜像是 Docker 容器的基石，容器是镜像的实例，有了镜像才能启动容器。</p>
<p>镜像到底包含什么呢？容器为什么是轻量级的虚拟化呢？</p>
<p><img src="/imgs/201806/run_hello_world.png" alt="运行hello world"></p>
<p>首先从一个最小的镜像hello-world讲起，hello-world镜像仅有1.85kB，根据经验它肯定是不包括Linux的内核的，因为现在Linux内核大小至少100MB以上。</p>
<p>这么小的镜像，它能运行，是一个完整的镜像，他是怎么构建出来的呢？</p>
<p><img src="/imgs/201806/dockerfile_hello_world.png" alt="hello world dockerfile"></p>
<p>这个镜像的构建文件仅有三行，第一行从空白镜像开始构建，第二行拷贝二进制hello程序，第三行运行hello程序。</p>
<p>/hello 就是文件系统的全部内容，连最基本的 /bin，/usr, /lib, /dev 都没有。</p>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/docker/">docker</a><a href="/tags/container/">container</a><a href="/tags/image/">image</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2018/06/11/Docker-Images/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/06/07/Hello-Docker/"><span>Hello Docker</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/06/07/Hello-Docker/" rel="bookmark">
        <time class="entry-date published" datetime="2018-06-07T10:41:33.000Z">
          2018-06-07
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="环境选择"><a href="#环境选择" class="headerlink" title="环境选择"></a>环境选择</h2><p>容器需要管理工具、运行时和操作系统，我们的选择如下：</p>
<ul>
<li><p>管理工具 - Docker Engine<br>因为 Docker 最流行使用最广泛</p>
</li>
<li><p>运行时 - runc<br>Docker 的默认 runtime</p>
</li>
<li><p>操作系统 - Ubuntu<br>选择大家熟悉的操作系统</p>
</li>
</ul>
<h2 id="安装-Docker"><a href="#安装-Docker" class="headerlink" title="安装 Docker"></a>安装 Docker</h2><p>我们将在 ubuntu 16.04 虚拟机中安装 Docker。因为安装过程需要访问 internet， 所以虚拟机必须能够上网。</p>
<p>Docker 支持几乎所有的 Linux 发行版，也支持 Mac 和 Windows。各操作系统的安装方法可以访问：<a href="https://docs.docker.com/install/" target="_blank" rel="noopener">https://docs.docker.com/install/</a></p>
<p>Docker 分为开源免费的 CE（Community Edition）版本和收费的 EE（Enterprise Edition）版本。下面我们将按照文档，通过以下步骤在 Ubuntu 16.04 上安装 Docker CE 版本。</p>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/docker/">docker</a><a href="/tags/container/">container</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2018/06/07/Hello-Docker/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2014/09/10/openstack-use/"><span>Openstack 使用</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2014/09/10/openstack-use/" rel="bookmark">
        <time class="entry-date published" datetime="2014-09-10T03:00:00.000Z">
          2014-09-10
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>OpenStack作为基础设施即服务（简称IaaS）资源的通用前端。首要任务是简化云的部署过程并为其带来良好的可扩展性。本文希望通过提供必要的指导信息，帮助大家利用OpenStack前端来设置及管理自己的私有云。</p>
<h2 id="导入虚拟机镜像"><a href="#导入虚拟机镜像" class="headerlink" title="导入虚拟机镜像"></a>导入虚拟机镜像</h2><p>如下列出了一下虚拟机镜像，可以在本地下载后通过Openstack界面导入。</p>
<p><a href="https://openstack.redhat.com/Image_resources" target="_blank" rel="noopener">https://openstack.redhat.com/Image_resources</a></p>
<p>也可以参考如下文档自己制作镜像：</p>
<p><a href="https://www.ibm.com/developerworks/community/wikis/home?lang=en#!/wiki/OpenStack/page/Creating%20qcow2%20CentOS%20Image%20for%20OpenStack" target="_blank" rel="noopener">https://www.ibm.com/developerworks/community/wikis/home?lang=en#!/wiki/OpenStack/page/Creating%20qcow2%20CentOS%20Image%20for%20OpenStack</a></p>
<p>导入镜像：</p>
<p>点击左侧的镜像 选项卡，可以看到已经导入的镜像，点击创建镜像 按钮创建镜像。</p>
<p><img src="/images/14-09-10/openstack_images.png" alt="Openstack镜像"></p>
<p>填写 镜像名称，镜像源选择—镜像文件，格式选择 QCOW2，勾选 公有 框（这样你上传得镜像其他人也能使用），然后点击创建镜像。</p>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/虚拟化/">虚拟化</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Openstack/">Openstack</a><a href="/tags/KVM/">KVM</a><a href="/tags/Ceph/">Ceph</a><a href="/tags/CoreOS/">CoreOS</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2014/09/10/openstack-use/#comment">评论</a>
        </span>
      </span>
    </div>
    
  </div>
</article>




<nav class="pagination">
  
  
  <a href="/page/2/" class="pagination-next">下一页</a>
  
</nav>
    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2019 ist0ne
    
  </p>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-39923501-1', 'auto');
    ga('send', 'pageview');

</script>

  </div>
</div>
</body>
</html>